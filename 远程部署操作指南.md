# 远程部署操作指南

## 服务器信息
- **IP**: 113.240.112.71
- **SSH端口**: 10022
- **用户名**: root
- **密码**: Kxr^pVpRrTXeg2025ysweb
- **后端路径**: /qzkj/hr/backend
- **前端路径**: /qzkj/hr/frontend/dist

---

## 一、后端部署

### 1. 完整打包后端
在本地项目目录执行：
```bash
cd /Users/Python项目/HR人事
DATE=$(date +%Y%m%d)
cd backend && zip -r ../backend-update-${DATE}.zip app .env requirements.txt alembic.ini alembic \
  -x "*.pyc" -x "*__pycache__*" -x "*.db" -x ".venv/*" \
  -x "*.DS_Store" -x "__MACOSX/*" -x "._*" -x ".AppleDouble/*"
```

### 1b. 单文件更新（推荐小改动）
如果只修改了个别文件，可以直接上传：
```bash
# 示例：只更新 portrait_router.py
scp -P 10022 backend/app/core/ai/portrait_router.py root@113.240.112.71:/qzkj/hr/backend/app/core/ai/

# 重启服务生效
ssh -p 10022 root@113.240.112.71 "systemctl restart talentlens"
```

### 2. 上传到服务器
```bash
cd /Users/Python项目/HR人事
scp -P 10022 backend-update-*.zip root@113.240.112.71:/qzkj/hr/
```
输入密码：`Kxr^pVpRrTXeg2025ysweb`

### 3. SSH登录服务器并部署
```bash
ssh -p 10022 root@113.240.112.71
```

执行部署：
```bash
cd /qzkj/hr
# 备份
cp -r backend/app backend/app_backup_$(date +%Y%m%d)
# 解压覆盖
unzip -o backend-update-*.zip -d backend/
# 重启服务
systemctl restart talentlens
# 查看状态
systemctl status talentlens
```

---

## 二、前端部署

### 1. 打包前端
在本地项目目录执行：
```bash
cd /Users/Python项目/HR人事/frontend
npm run build
DATE=$(date +%Y%m%d)
cd dist && zip -r ../../frontend-dist-update-${DATE}.zip . \
  -x "*.DS_Store" -x "__MACOSX/*" -x "._*"
```

### 2. 上传到服务器
```bash
cd /Users/Python项目/HR人事
scp -P 10022 frontend-dist-update-*.zip root@113.240.112.71:/qzkj/hr/
```

### 3. SSH登录服务器并部署
```bash
ssh -p 10022 root@113.240.112.71
```

执行部署：
```bash
cd /qzkj/hr
# 备份
cp -r frontend/dist frontend/dist_backup_$(date +%Y%m%d)
# 解压覆盖
unzip -o frontend-dist-update-*.zip -d frontend/dist/
```
前端是静态文件，无需重启服务，刷新页面即可。

---

## 三、一键部署脚本（可选）

保存为 `deploy.sh`，执行时自动完成全部操作：

```bash
#!/bin/bash
SERVER="root@113.240.112.71"
PORT="10022"
REMOTE_PATH="/qzkj/hr"
DATE=$(date +%Y%m%d)

echo "===== 1. 打包后端 ====="
cd /Users/Python项目/HR人事/backend
zip -r ../backend-update-${DATE}.zip app .env requirements.txt alembic.ini alembic \
  -x "*.pyc" -x "*__pycache__*" -x "*.db" -x ".venv/*" \
  -x "*.DS_Store" -x "__MACOSX/*" -x "._*"

echo "===== 2. 打包前端 ====="
cd /Users/Python项目/HR人事/frontend
npm run build
cd dist && zip -r ../../frontend-dist-update-${DATE}.zip . \
  -x "*.DS_Store" -x "__MACOSX/*" -x "._*"

echo "===== 3. 上传文件 ====="
cd /Users/Python项目/HR人事
scp -P ${PORT} backend-update-${DATE}.zip ${SERVER}:${REMOTE_PATH}/
scp -P ${PORT} frontend-dist-update-${DATE}.zip ${SERVER}:${REMOTE_PATH}/

echo "===== 4. 远程部署 ====="
ssh -p ${PORT} ${SERVER} << 'ENDSSH'
cd /qzkj/hr
# 备份
cp -r backend/app backend/app_backup_$(date +%Y%m%d)
cp -r frontend/dist frontend/dist_backup_$(date +%Y%m%d)
# 解压
unzip -o backend-update-*.zip -d backend/
unzip -o frontend-dist-update-*.zip -d frontend/dist/
# 重启后端
systemctl restart talentlens
echo "✅ 部署完成"
systemctl status talentlens --no-pager
ENDSSH
```

---

## 四、常用运维命令

### 查看后端日志
```bash
ssh -p 10022 root@113.240.112.71 "tail -100 /var/log/talentlens/error.log"
```

### 重启后端服务
```bash
ssh -p 10022 root@113.240.112.71 "systemctl restart talentlens"
```

### 查看服务状态
```bash
ssh -p 10022 root@113.240.112.71 "systemctl status talentlens"
```

### 同步问卷到数据库
```bash
scp -P 10022 /tmp/sync_questionnaires.py root@113.240.112.71:/tmp/
ssh -p 10022 root@113.240.112.71 "cd /qzkj/hr/backend && source venv/bin/activate && python3 /tmp/sync_questionnaires.py"
```

---

## 五、注意事项

1. **密码中有特殊字符**：如果用脚本自动化，建议配置 SSH 免密登录
2. **备份**：每次部署前自动备份，出问题可回滚
3. **.env 文件**：已包含在后端打包中，会自动覆盖
4. **数据库**：SQLite 数据库文件 `hr.db` 不在打包范围内，不会被覆盖

