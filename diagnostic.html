<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPQ ç³»ç»Ÿè¯Šæ–­å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; margin-bottom: 20px; }
        h2 { color: #333; margin: 30px 0 15px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .status { padding: 15px; border-radius: 8px; margin: 10px 0; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.warning { background: #fef3c7; color: #92400e; }
        button {
            padding: 12px 24px;
            margin: 10px 10px 10px 0;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover { background: #5568d3; transform: translateY(-2px); }
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            max-height: 400px;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .card h3 { margin-bottom: 10px; color: #667eea; }
        .card .value { font-size: 32px; font-weight: bold; color: #333; }
        .card .label { color: #666; font-size: 14px; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ EPQ ç³»ç»Ÿè¯Šæ–­å·¥å…·</h1>
        <p style="color: #666; margin-bottom: 20px;">æ£€æµ‹ç³»ç»ŸçŠ¶æ€å¹¶ä¿®å¤å¸¸è§é—®é¢˜</p>

        <div class="grid" id="statsCards"></div>

        <h2>ğŸ” ç³»ç»Ÿæ£€æŸ¥</h2>
        <div id="systemCheck"></div>

        <h2>ğŸ“Š æ•°æ®çŠ¶æ€</h2>
        <div id="dataStatus"></div>

        <h2>ğŸ› ï¸ å¿«é€Ÿä¿®å¤</h2>
        <div>
            <button onclick="fixDateFormat()">ä¿®å¤æ—¥æœŸæ ¼å¼</button>
            <button onclick="fixDataStructure()">ä¿®å¤æ•°æ®ç»“æ„</button>
            <button onclick="clearAndRegenerate()">æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆæ•°æ®</button>
            <button class="danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>

        <h2>ğŸ“„ åŸå§‹æ•°æ®</h2>
        <button onclick="viewRawData()">æŸ¥çœ‹åŸå§‹æ•°æ®</button>
        <button onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
        <pre id="rawData" style="display: none;"></pre>

        <h2>ğŸš€ å¿«é€Ÿé“¾æ¥</h2>
        <div>
            <button onclick="window.open('test.html', '_blank')">æ‰“å¼€æµ‹è¯„é¡µé¢</button>
            <button onclick="window.open('admin.html', '_blank')">æ‰“å¼€ç®¡ç†åå° v2.5</button>
            <button onclick="window.open('debug.html', '_blank')">æ‰“å¼€è°ƒè¯•å·¥å…·</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'epqRecords';
        const CONFIG_KEY = 'epqAdminSettings';

        function runDiagnostics() {
            checkSystem();
            checkData();
            updateStats();
        }

        function checkSystem() {
            const checks = [];
            const checkDiv = document.getElementById('systemCheck');

            // æ£€æŸ¥ LocalStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                checks.push({ status: 'success', message: 'âœ… LocalStorage å¯ç”¨' });
            } catch (e) {
                checks.push({ status: 'error', message: 'âŒ LocalStorage ä¸å¯ç”¨: ' + e.message });
            }

            // æ£€æŸ¥æ•°æ®å­˜åœ¨
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                try {
                    const records = JSON.parse(data);
                    checks.push({ status: 'success', message: `âœ… æ•°æ®å·²åŠ è½½ (${records.length} æ¡è®°å½•)` });
                } catch (e) {
                    checks.push({ status: 'error', message: 'âŒ æ•°æ®è§£æé”™è¯¯: ' + e.message });
                }
            } else {
                checks.push({ status: 'warning', message: 'âš ï¸ æš‚æ— æ•°æ®' });
            }

            // æ£€æŸ¥é…ç½®
            const config = localStorage.getItem(CONFIG_KEY);
            if (config) {
                checks.push({ status: 'success', message: 'âœ… é…ç½®å·²åŠ è½½' });
            } else {
                checks.push({ status: 'warning', message: 'âš ï¸ æš‚æ— é…ç½®' });
            }

            checkDiv.innerHTML = checks.map(c => 
                `<div class="status ${c.status}">${c.message}</div>`
            ).join('');
        }

        function checkData() {
            const statusDiv = document.getElementById('dataStatus');
            const data = localStorage.getItem(STORAGE_KEY);
            
            if (!data) {
                statusDiv.innerHTML = '<div class="status warning">âš ï¸ æš‚æ— æ•°æ®ï¼Œè¯·ç”Ÿæˆæµ‹è¯•æ•°æ®æˆ–å®Œæˆä¸€æ¬¡æµ‹è¯„</div>';
                return;
            }

            try {
                const records = JSON.parse(data);
                const issues = [];

                records.forEach((record, index) => {
                    // æ£€æŸ¥å¿…è¦å­—æ®µ
                    if (!record.id) issues.push(`è®°å½• ${index + 1}: ç¼ºå°‘ id`);
                    if (!record.name) issues.push(`è®°å½• ${index + 1}: ç¼ºå°‘ name`);
                    if (!record.phone) issues.push(`è®°å½• ${index + 1}: ç¼ºå°‘ phone`);
                    if (!record.position) issues.push(`è®°å½• ${index + 1}: ç¼ºå°‘ position`);
                    if (!record.createTime) issues.push(`è®°å½• ${index + 1}: ç¼ºå°‘ createTime`);
                    if (!record.scores) issues.push(`è®°å½• ${index + 1}: ç¼ºå°‘ scores`);

                    // æ£€æŸ¥æ—¥æœŸæ ¼å¼
                    if (record.createTime) {
                        const date = new Date(record.createTime);
                        if (isNaN(date.getTime())) {
                            issues.push(`è®°å½• ${index + 1}: createTime æ ¼å¼é”™è¯¯ (${record.createTime})`);
                        }
                    }
                });

                if (issues.length === 0) {
                    statusDiv.innerHTML = '<div class="status success">âœ… æ•°æ®ç»“æ„æ­£å¸¸</div>';
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            âŒ å‘ç° ${issues.length} ä¸ªé—®é¢˜ï¼š<br>
                            ${issues.slice(0, 10).join('<br>')}
                            ${issues.length > 10 ? '<br>...' : ''}
                        </div>
                    `;
                }
            } catch (e) {
                statusDiv.innerHTML = `<div class="status error">âŒ æ•°æ®è§£æé”™è¯¯: ${e.message}</div>`;
            }
        }

        function updateStats() {
            const data = localStorage.getItem(STORAGE_KEY);
            const records = data ? JSON.parse(data) : [];
            
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = records.filter(r => {
                try {
                    const recordDate = new Date(r.createTime).toISOString().split('T')[0];
                    return recordDate === today;
                } catch (e) {
                    return false;
                }
            });

            const positions = [...new Set(records.map(r => r.position).filter(Boolean))];

            document.getElementById('statsCards').innerHTML = `
                <div class="card">
                    <h3>æ€»è®°å½•æ•°</h3>
                    <div class="value">${records.length}</div>
                    <div class="label">æ¡è®°å½•</div>
                </div>
                <div class="card">
                    <h3>ä»Šæ—¥æ–°å¢</h3>
                    <div class="value">${todayRecords.length}</div>
                    <div class="label">æ¡è®°å½•</div>
                </div>
                <div class="card">
                    <h3>å²—ä½æ•°é‡</h3>
                    <div class="value">${positions.length}</div>
                    <div class="label">ä¸ªå²—ä½</div>
                </div>
                <div class="card">
                    <h3>å­˜å‚¨å¤§å°</h3>
                    <div class="value">${(JSON.stringify(records).length / 1024).toFixed(2)}</div>
                    <div class="label">KB</div>
                </div>
            `;
        }

        function fixDateFormat() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (!data) {
                alert('æš‚æ— æ•°æ®');
                return;
            }

            try {
                const records = JSON.parse(data);
                let fixedCount = 0;

                const fixedRecords = records.map(record => {
                    if (record.createTime) {
                        // å°è¯•è§£æå¹¶æ ‡å‡†åŒ–æ—¥æœŸæ ¼å¼
                        const date = new Date(record.createTime);
                        if (!isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const hour = String(date.getHours()).padStart(2, '0');
                            const minute = String(date.getMinutes()).padStart(2, '0');
                            const second = String(date.getSeconds()).padStart(2, '0');
                            record.createTime = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                            fixedCount++;
                        }
                    }
                    return record;
                });

                localStorage.setItem(STORAGE_KEY, JSON.stringify(fixedRecords));
                alert(`âœ… å·²ä¿®å¤ ${fixedCount} æ¡è®°å½•çš„æ—¥æœŸæ ¼å¼`);
                runDiagnostics();
            } catch (e) {
                alert('âŒ ä¿®å¤å¤±è´¥: ' + e.message);
            }
        }

        function fixDataStructure() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (!data) {
                alert('æš‚æ— æ•°æ®');
                return;
            }

            try {
                const records = JSON.parse(data);
                const fixedRecords = records.map(record => ({
                    id: record.id || Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    name: record.name || 'æœªçŸ¥',
                    phone: record.phone || '',
                    position: record.position || 'æœªçŸ¥',
                    remark: record.remark || '',
                    createTime: record.createTime || new Date().toISOString().replace('T', ' ').split('.')[0],
                    scores: record.scores || { E: 0, N: 0, P: 0, L: 0 },
                    rawAnswers: record.rawAnswers || {}
                }));

                localStorage.setItem(STORAGE_KEY, JSON.stringify(fixedRecords));
                alert('âœ… æ•°æ®ç»“æ„å·²ä¿®å¤');
                runDiagnostics();
            } catch (e) {
                alert('âŒ ä¿®å¤å¤±è´¥: ' + e.message);
            }
        }

        function clearAndRegenerate() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºç°æœ‰æ•°æ®å¹¶ç”Ÿæˆæ–°çš„æµ‹è¯•æ•°æ®å—ï¼Ÿ')) return;

            const positions = ['Javaå¼€å‘å·¥ç¨‹å¸ˆ', 'å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ', 'äº§å“ç»ç†', 'UIè®¾è®¡å¸ˆ', 'é”€å”®ç»ç†'];
            const names = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­', 'é’±ä¸ƒ'];
            const records = [];

            for (let i = 0; i < 10; i++) {
                const now = new Date();
                now.setDate(now.getDate() - Math.floor(Math.random() * 7));
                
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                const second = String(now.getSeconds()).padStart(2, '0');

                records.push({
                    id: Date.now() + i + '-' + Math.random().toString(36).substr(2, 9),
                    name: names[Math.floor(Math.random() * names.length)],
                    phone: '138' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0'),
                    position: positions[Math.floor(Math.random() * positions.length)],
                    remark: `æµ‹è¯•å¤‡æ³¨ ${i + 1}`,
                    createTime: `${year}-${month}-${day} ${hour}:${minute}:${second}`,
                    scores: {
                        E: Math.floor(Math.random() * 22),
                        N: Math.floor(Math.random() * 25),
                        P: Math.floor(Math.random() * 22),
                        L: Math.floor(Math.random() * 23)
                    },
                    rawAnswers: {}
                });
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            alert('âœ… å·²ç”Ÿæˆ 10 æ¡æ ‡å‡†æ ¼å¼çš„æµ‹è¯•æ•°æ®');
            runDiagnostics();
        }

        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(CONFIG_KEY);
            alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
            runDiagnostics();
        }

        function viewRawData() {
            const pre = document.getElementById('rawData');
            const data = localStorage.getItem(STORAGE_KEY);
            
            if (data) {
                pre.textContent = JSON.stringify(JSON.parse(data), null, 2);
                pre.style.display = 'block';
            } else {
                pre.textContent = 'æš‚æ— æ•°æ®';
                pre.style.display = 'block';
            }
        }

        function exportData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (!data) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `epq_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('âœ… æ•°æ®å·²å¯¼å‡º');
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œè¯Šæ–­
        window.addEventListener('DOMContentLoaded', runDiagnostics);
    </script>
</body>
</html>

