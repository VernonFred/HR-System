## 服务器及部署情况
113.240.112.71 root/Kxr^pVpRrTXeg2025ysweb

后端：/qzkj/hr/backend

前端：/qzkj/hr/frontend

nginx配置文件：/jw/nginx/conf/hr.conf 

# 一、安装部署操作
## 1、环境安装要求
### <font style="color:rgb(51, 51, 51);">1.1 Python 3.11+</font>
<font style="color:rgb(51, 51, 51);">先查看python版本 python3 --version，如果版本不是3.11+，建议使用安装包编译升级3.11+版本。</font>

```plain
dnf install -y gcc make zlib-devel bzip2 bzip2-devel readline-devel sqlite sqlite-devel openssl-devel libffi-devel xz-devel tk-devel wget
wget https://www.python.org/ftp/python/3.11.0/Python-3.11.0.tar.xz
tar -xf Python-3.11.0.tar.xz
cd Python-3.11.0
./configure --enable-optimizations --enable-shared
make -j$(nproc)
sudo make altinstall   # 使用 `altinstall` 避免覆盖系统 Python
python3.11 --version    #输出应为：Python 3.11.0
如果运行 python3.11 时报错 libpython3.11.so.1.0 找不到：
ldconfig   #还找不到，在服务器上全量搜索libpython3.11.so.1.0，然后复制到/usr/local/lib/libpython3.11.so.1.0
cp xx/xx/libpython3.11.so.1.0 /usr/local/lib/
vim /etc/ld.so.conf.d/python3.11.conf
/usr/local/lib  # 若库文件在 /usr/local/lib 下，或自定义安装路径，如 /opt/python3.11/lib
ldconfig
python3.11 --version
```

### 1.2 Node.js 18+
**<font style="color:rgb(51, 51, 51);">使用 nvm (推荐)</font>**

```plain
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
# 安装 Node.js
nvm install 18
nvm use 18
```

### 1.3 nginx
## 2、后端部署
### 2.1 创建虚拟环境并安装依赖
```plain
cd /qzkj/hr/backend
#创建虚拟环境
python3.11 -m venv venv
source venv/bin/activate
#安装依赖
pip install --upgrade pip
pip install -r requirements.txt
pip install gunicorn
```

### 2.2 创建.env文件
```plain
# 创建.env文件
cat > .env << 'EOF'
# 数据库配置
DATABASE_URL=sqlite:///./hr.db

# 密码盐值（重要！一旦设置不可更改）
AUTH_SALT=qz-talentlens-auth-salt-2024

# JWT 配置
JWT_SECRET_KEY=qz-talentlens-jwt-secret-key-2024-production
JWT_ALGORITHM=HS256

# AI 配置
MODELSCOPE_API_KEY=ms-719ff9c2-52e9-43df-bf51-3226f0acdf78
MODELSCOPE_API_KEY_EXPIRES=2099-01-06
MODELSCOPE_API_BASE=https://api-inference.modelscope.cn/v1/chat/completions

# 硅基流动备用 (可选)
SILICONFLOW_API_KEY=your_siliconflow_api_key

# ============================================
# AI 备用模型（硅基流动 - ModelScope失败时自动切换）
# ============================================
AI_API_KEY=sk-yhnqazcdjyqtbjqmnyxuslbavwopabgwnsvoqacwkvdrlzvn
AI_API_BASE=https://api.siliconflow.cn/v1/chat/completions
AI_MODEL=Qwen/Qwen3-8B
AI_FALLBACK_MODELS_SIMPLE=THUDM/glm-4-9b-chat,THUDM/GLM-Z1-9B-0414,THUDM/GLM-4-9B-0414

# 默认管理员
DEFAULT_ADMIN_USERNAME=admin
DEFAULT_ADMIN_PASSWORD=admin123
EOF
```

### 2.3 创建后端systemd服务
```plain
cat > /etc/systemd/system/talentlens.service << 'EOF'
[Unit]
Description=QZ TalentLens Backend Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/qzkj/hr/backend
Environment="PATH=/qzkj/hr/backend/venv/bin"
ExecStart=/qzkj/hr/backend/venv/bin/gunicorn app.main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 127.0.0.1:9000 --access-logfile /var/log/talentlens/access.log --error-logfile /var/log/talentlens/error.log 
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target

EOF

# 启用并启动服务
systemctl daemon-reload
systemctl enable talentlens
systemctl start talentlens
```

## 3、前端部署

编译前端文件

```plain
cd /qzkj/hr/frontend
cat > .env.production << 'EOF'
VITE_API_BASE=http://113.240.112.71:1080/
EOF

npm install
npm install -D sass-embedded
npm run build
```

编译后生成包路径：/qzkj/hr/frontend/dist/

nginx配置

```plain
server {
    listen 1080;
    server_name 113.240.112.71;
    
    # 重定向到 HTTPS (生产环境)
    # return 301 https://$server_name$request_uri;
    
    # 前端静态文件
    root /qzkj/hr/frontend/dist;
    index index.html;
    
    # 前端路由 (SPA)
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API 代理
    location /api {
        proxy_pass http://127.0.0.1:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }
    
    # Auth API 代理
    location /auth {
        proxy_pass http://127.0.0.1:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;
}
```



访问系统：[http://113.240.112.71:1080/](http://113.240.112.71:1080/)  



## 4、注意事项
### 4.1 数据库初始化问题
因为使用人数不多，所以采用的<font style="color:rgb(51, 51, 51);">SQLite 部署（推荐小规模使用）。</font>

数据库在第一次启动的时候生成hr.db文件。

### 4.2 数据库、环境变量备份
备份路径：/qzkj/backup

# 二、系统运维
## 1 后端更新
参考《05_后续维护文档.md》

覆盖.env文件

cp /qzkj/hr/.env /qzkj/hr/backend

重启后端服务

systemctl restart talentlens

## 2 前端更新
替换/qzkj/hr/frontend/dist文件。

## 3 后端日志查看
tail -f /var/log/talentlens/access.log

tail -f /var/log/talentlens/error.log



