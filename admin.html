<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPQ 测试管理后台</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --primary-dark: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f3f4f8;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --card-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* 登录页面 */
        .login-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 48px 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 32px;
            color: white;
        }

        .login-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-header p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 18px;
        }

        input[type="password"],
        input[type="text"],
        input[type="date"],
        input[type="search"],
        select {
            width: 100%;
            padding: 12px 16px;
            padding-left: 44px;
            font-size: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--card-bg);
            transition: var(--transition);
            outline: none;
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 100%;
            padding: 14px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .error-msg {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--danger);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 16px;
            display: none;
            animation: shake 0.5s;
        }

        .error-msg.show {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* 主界面布局 */
        .admin-wrapper {
            display: none;
            min-height: 100vh;
        }

        .admin-wrapper.active {
            display: block;
        }

        /* 顶部导航 */
        .navbar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .navbar-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .navbar-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .navbar-title h1 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .navbar-title p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 18px;
        }

        .btn-icon:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* 主内容区 */
        .main-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--card-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
        }

        .stat-card.gradient-1 {
            --gradient-start: #667eea;
            --gradient-end: #764ba2;
        }

        .stat-card.gradient-2 {
            --gradient-start: #f093fb;
            --gradient-end: #f5576c;
        }

        .stat-card.gradient-3 {
            --gradient-start: #4facfe;
            --gradient-end: #00f2fe;
        }

        .stat-card.gradient-4 {
            --gradient-start: #43e97b;
            --gradient-end: #38f9d7;
        }

        .stat-card.gradient-5 {
            --gradient-start: #fa709a;
            --gradient-end: #fee140;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-header h3 {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stat-footer {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
        }

        .stat-change.up {
            background: #d1fae5;
            color: #065f46;
        }

        .stat-change.down {
            background: #fee2e2;
            color: #991b1b;
        }

        /* 卡片容器 */
        .card {
            background: var(--card-bg);
            border-radius: var(--card-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card-title i {
            font-size: 22px;
            color: var(--primary);
        }

        /* 筛选区域 */
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .filter-item label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-item input,
        .filter-item select {
            padding-left: 16px;
        }

        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .quick-filter-btn {
            padding: 8px 16px;
            font-size: 13px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-filter-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* 表格样式 */
        .table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: var(--bg);
        }

        th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }

        th:hover {
            background: var(--border);
        }

        th.sortable::after {
            content: '\ea4e';
            font-family: 'remixicon';
            margin-left: 6px;
            opacity: 0.3;
            font-size: 14px;
        }

        th.sort-asc::after {
            content: '\ea78';
            opacity: 1;
        }

        th.sort-desc::after {
            content: '\ea4d';
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
            cursor: pointer;
        }

        tbody tr:hover {
            background: #fafbfc;
        }

        td {
            padding: 16px 12px;
            color: var(--text-primary);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .score-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--bg);
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
        }

        /* 分页 */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
        }

        .page-btn {
            min-width: 36px;
            height: 36px;
            padding: 0 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .page-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 14px;
            color: var(--text-secondary);
            padding: 0 12px;
        }

        /* 图表网格 */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        
        .master-detail-layout {
            display: grid;
            grid-template-columns: minmax(360px, 420px) 1fr;
            gap: 0;
            background: var(--bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .master-panel { display: flex; flex-direction: column; background: var(--card-bg); border-right: 1px solid var(--border); }
        .list-toolbar { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .list-toolbar-left { display: flex; align-items: center; gap: 12px; }
        .list-count { font-size: 12px; color: var(--text-secondary); }
        .list-actions { display: flex; gap: 8px; }
        .candidate-list { flex: 1; overflow-y: auto; padding: 8px; }
        .candidate-item { display: flex; align-items: flex-start; flex-wrap: wrap; gap: 12px; padding: 12px; margin: 6px 0; border-radius: 10px; cursor: pointer; transition: var(--transition); }
        .candidate-item:hover { background: var(--bg); }
        .candidate-item.active { background: rgba(79,70,229,0.08); border: 1px solid rgba(79,70,229,0.18); }
        .candidate-item .checkbox { flex-shrink: 0; width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary); }
        .candidate-avatar { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
        .candidate-info { flex: 1; min-width: 0; }
        .candidate-name { font-size: 14px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .candidate-meta { font-size: 12px; color: var(--text-secondary); display:flex; align-items:center; gap:8px; line-height: 1.4; flex-wrap: wrap; }
        .candidate-meta span { white-space: nowrap; }
        .candidate-scores { display:flex; gap:8px; flex-wrap: wrap; width: 100%; padding-left: 64px; }
        .score-dot { min-width:36px; height:26px; padding:0 8px; border-radius:13px; background: var(--bg); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color: var(--text-secondary); }
        .master-footer { padding: 10px 12px; border-top: 1px solid var(--border); }
        .detail-panel { background: var(--card-bg); }
        .detail-content { padding: 16px; }

        
        .assessment-tabs {
            display: flex;
            gap: 6px;
            padding: 6px;
            background: var(--bg);
            border-radius: 12px;
            margin-bottom: 24px;
        }
        .assessment-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        .assessment-tab:hover {
            background: var(--border);
            color: var(--text-primary);
        }
        .assessment-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .assessment-tab-content { display: none; }
        .assessment-tab-content.active { display: block; }

        
        .chart-container {
            width: 100%;
            height: 360px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: var(--card-radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart {
            width: 100%;
            height: 350px;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            color: var(--text-light);
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* 模态框/抽屉 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            animation: fadeIn 0.3s;
        }

        .modal-overlay.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .drawer {
            position: fixed;
            right: -600px;
            top: 0;
            bottom: 0;
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            box-shadow: var(--shadow-xl);
            z-index: 1001;
            overflow-y: auto;
            transition: right 0.3s ease-out;
        }

        .drawer.active {
            right: 0;
        }

        .drawer-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
        }

        .drawer-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .drawer-body {
            padding: 24px;
        }

        .detail-section {
            margin-bottom: 32px;
        }

        .detail-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-item {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            flex: 0 0 100px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .detail-value {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
        }

        /* 配置面板 */
        .config-panel {
            position: fixed;
            right: -400px;
            top: 0;
            bottom: 0;
            width: 100%;
            max-width: 400px;
            background: var(--card-bg);
            box-shadow: var(--shadow-xl);
            z-index: 1001;
            overflow-y: auto;
            transition: right 0.3s ease-out;
        }

        .config-panel.active {
            right: 0;
        }

        .config-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
        }

        .config-body {
            padding: 24px;
        }

        .config-section {
            margin-bottom: 32px;
        }

        .config-section h4 {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-section h4 i {
            font-size: 16px;
            color: var(--primary);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .checkbox-item:hover {
            background: var(--border);
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
        }

        /* 岗位列表 */
        .position-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .position-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg);
            border-radius: 8px;
            transition: var(--transition);
        }

        .position-item:hover {
            background: var(--border);
        }

        .position-name {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }

        .position-actions {
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
        }

        .icon-btn:hover {
            background: var(--card-bg);
            color: var(--primary);
        }

        .icon-btn.delete:hover {
            color: var(--danger);
        }

        /* 规则配置 */
        .rule-item {
            margin-bottom: 16px;
        }

        .rule-item label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* 自定义模态框 */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .custom-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 0;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .form-field {
            margin-bottom: 20px;
        }

        .form-field label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            transition: var(--transition);
            outline: none;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .form-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .btn-cancel {
            background: var(--bg);
            color: var(--text-primary);
        }

        .btn-cancel:hover {
            background: var(--border);
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .navbar-content {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .drawer,
            .config-panel {
                max-width: 100%;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 8px;
            }
        }

        /* Tabs（保留旧样式以兼容旧结构） */
        .tabs { display: none; }
        .tab { display: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div id="loginWrapper" class="login-wrapper">
        <div class="login-card">
            <div class="login-header">
                <div class="login-icon">
                    <i class="ri-shield-user-line"></i>
                </div>
                <h1>管理员登录</h1>
                <p>EPQ 测试管理后台系统</p>
            </div>
            <div class="error-msg" id="loginError"></div>
            <div class="form-group">
                <label>管理员密码</label>
                <div class="input-wrapper">
                    <i class="ri-lock-line"></i>
                    <input type="password" id="passwordInput" placeholder="请输入管理员密码" autocomplete="off">
                </div>
            </div>
            <button class="btn btn-primary" onclick="handleLogin()">
                <i class="ri-login-box-line"></i>
                登录
            </button>
            <p style="text-align: center; margin-top: 20px; font-size: 12px; color: var(--text-light);">
                默认密码：epq_admin_123
            </p>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="adminWrapper" class="admin-wrapper">
        <!-- 顶部导航 -->
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-brand">
                    <div class="navbar-icon">
                        <i class="ri-dashboard-line"></i>
                    </div>
                    <div class="navbar-title">
                        <h1>EPQ 测试管理后台</h1>
                        <p>招聘人格测试数据分析系统</p>
                    </div>
                </div>
                <div class="navbar-actions">
                    <div class="user-info">
                        <i class="ri-admin-line"></i>
                        <span>管理员</span>
                    </div>
                    <button class="btn-icon" onclick="toggleConfigPanel()" title="设置">
                        <i class="ri-settings-3-line"></i>
                    </button>
                    <button class="btn btn-secondary" onclick="handleLogout()">
                        <i class="ri-logout-box-line"></i>
                        退出登录
                    </button>
                </div>
            </div>
        </nav>

        <!-- 主内容 -->
        <main class="main-content">
            <!-- 统计卡片 -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- 数据管理模块（合并筛选和表格） -->
            <div class="card" id="dataManagementCard">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ri-database-2-line"></i>
                        数据管理
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button class="btn btn-secondary" onclick="toggleFilterPanel()" id="toggleFilterBtn" style="padding: 8px 16px;">
                            <i class="ri-filter-3-line"></i>
                            <span id="filterBtnText">显示筛选</span>
                        </button>
                        <button class="btn btn-success" onclick="exportCSV()" style="padding: 8px 16px;">
                            <i class="ri-file-excel-2-line"></i>
                            导出数据
                        </button>
                    </div>
                </div>

                <!-- 筛选面板 -->
                <div id="filterPanel" style="border-bottom: 1px solid var(--border); padding: 20px; display: none;">
                    <div class="filter-grid">
                        <div class="filter-item">
                            <label>应聘岗位</label>
                            <select id="filterPosition" onchange="applyFilters()">
                                <option value="">全部岗位</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>开始日期</label>
                            <input type="date" id="filterStartDate" onchange="applyFilters()">
                        </div>
                        <div class="filter-item">
                            <label>结束日期</label>
                            <input type="date" id="filterEndDate" onchange="applyFilters()">
                        </div>
                        <div class="filter-item">
                            <label>关键词搜索</label>
                            <input type="search" id="searchKeyword" placeholder="姓名或手机号" oninput="applyFilters()">
                        </div>
                    </div>

                    <!-- 成绩区间筛选 -->
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <h4 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                            <i class="ri-bar-chart-line"></i> EPQ 成绩区间筛选
                        </h4>
                        <div class="filter-grid">
                            <div class="filter-item">
                                <label>E (外向性) 0-21</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" id="filterEMin" min="0" max="21" placeholder="最小" onchange="applyFilters()" style="flex: 1;">
                                    <span>-</span>
                                    <input type="number" id="filterEMax" min="0" max="21" placeholder="最大" onchange="applyFilters()" style="flex: 1;">
                                </div>
                            </div>
                            <div class="filter-item">
                                <label>N (神经质) 0-24</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" id="filterNMin" min="0" max="24" placeholder="最小" onchange="applyFilters()" style="flex: 1;">
                                    <span>-</span>
                                    <input type="number" id="filterNMax" min="0" max="24" placeholder="最大" onchange="applyFilters()" style="flex: 1;">
                                </div>
                            </div>
                            <div class="filter-item">
                                <label>P (精神质) 0-21</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" id="filterPMin" min="0" max="21" placeholder="最小" onchange="applyFilters()" style="flex: 1;">
                                    <span>-</span>
                                    <input type="number" id="filterPMax" min="0" max="21" placeholder="最大" onchange="applyFilters()" style="flex: 1;">
                                </div>
                            </div>
                            <div class="filter-item">
                                <label>L (掩饰性) 0-22</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" id="filterLMin" min="0" max="22" placeholder="最小" onchange="applyFilters()" style="flex: 1;">
                                    <span>-</span>
                                    <input type="number" id="filterLMax" min="0" max="22" placeholder="最大" onchange="applyFilters()" style="flex: 1;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="quick-filters">
                        <button class="quick-filter-btn" onclick="setQuickFilter(7)">最近7天</button>
                        <button class="quick-filter-btn" onclick="setQuickFilter(30)">最近30天</button>
                        <button class="quick-filter-btn" onclick="resetFilters()">清空所有筛选</button>
                    </div>
                </div>

                

                
                <div class="master-detail-layout">
                    <div class="master-panel">
                        <div class="list-toolbar">
                            <div class="list-toolbar-left">
                                <div class="list-count">共 <strong id="totalRecords">0</strong> 条记录 <span id="filteredInfo" style="display:none;">（已筛选 <strong id="filteredCount">0</strong> 条）</span></div>
                            </div>
                            <div class="list-actions">
                                <button class="btn btn-secondary" onclick="toggleSelectAll()" id="selectAllBtn" style="padding:8px 14px;">
                                    <i class="ri-checkbox-line"></i>
                                    <span id="selectAllText">全选</span>
                                </button>
                                <button class="btn" onclick="deleteSelected()" id="deleteSelectedBtn" style="padding:8px 14px; background: var(--danger); color: white; display:none;">
                                    <i class="ri-delete-bin-line"></i>
                                    删除选中 (<span id="selectedCount">0</span>)
                                </button>
                            </div>
                        </div>
                        <div class="candidate-list" id="candidateList"></div>
                        <div class="master-footer" id="candidatePagination"></div>
                    </div>
                    <div class="detail-panel">
                        <div class="detail-content" id="candidateDetail"></div>
                    </div>
                </div>
            </div>

            
        </main>
    </div>

    <!-- 详情抽屉 -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeAllPanels()"></div>
    <div class="drawer" id="detailDrawer">
        <div class="drawer-header">
            <h2>候选人详情</h2>
            <button class="btn-icon" onclick="closeDrawer()">
                <i class="ri-close-line"></i>
            </button>
        </div>
        <div class="drawer-body" id="drawerBody"></div>
    </div>

    <!-- 通用模态框 -->
    <div class="custom-modal" id="customModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">标题</h3>
                <button class="btn-icon" onclick="closeModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- 配置面板 -->
    <div class="config-panel" id="configPanel">
        <div class="config-header">
            <h2><i class="ri-settings-3-line"></i> 页面配置</h2>
            <button class="btn-icon" onclick="toggleConfigPanel()">
                <i class="ri-close-line"></i>
            </button>
        </div>
        <div class="config-body">
            <!-- 配置说明 -->
            <div style="padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; margin-bottom: 24px; color: white;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <i class="ri-information-line" style="font-size: 24px;"></i>
                    <strong style="font-size: 15px;">配置中心</strong>
                </div>
                <p style="font-size: 13px; line-height: 1.6; opacity: 0.95;">
                    在这里您可以自定义仪表盘布局、管理岗位、配置匹配度规则。所有设置将自动保存并即时生效。
                </p>
            </div>

            <!-- 模块显示 -->
            <div class="config-section">
                <h4><i class="ri-layout-grid-line"></i> 模块显示</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="showStats" checked onchange="toggleModule('statsGrid')">
                        <label for="showStats">显示统计卡片</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showFilter" checked onchange="toggleModule('filterCard')">
                        <label for="showFilter">显示筛选区域</label>
                    </div>
                </div>
            </div>

            

            <!-- 岗位管理 -->
            <div class="config-section">
                <h4><i class="ri-briefcase-line"></i> 岗位管理</h4>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.5;">
                    管理招聘岗位列表，带 <i class="ri-checkbox-circle-fill" style="color: var(--success);"></i> 标记的岗位已配置自定义匹配规则。
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button class="btn btn-primary" onclick="showAddPositionDialog()" style="flex: 1; padding: 10px;">
                        <i class="ri-add-line"></i> 添加岗位
                    </button>
                    <button class="btn btn-secondary" onclick="exportPositionConfig()" style="flex: 0 0 auto; padding: 10px;" title="导出配置">
                        <i class="ri-download-line"></i>
                    </button>
                </div>
                <div id="positionList" class="position-list"></div>
            </div>

            <!-- 匹配度规则配置 -->
            <div class="config-section">
                <h4><i class="ri-radar-line"></i> 匹配度规则配置</h4>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 13px; color: var(--text-secondary); display: block; margin-bottom: 8px;">
                        选择岗位配置规则：
                    </label>
                    <select id="rulePositionSelect" onchange="loadPositionRule()" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                        <option value="">选择岗位</option>
                    </select>
                    <div id="ruleHint" style="font-size: 12px; margin-top: 6px; color: var(--text-secondary);"></div>
                </div>
                <div id="ruleForm" style="display: none;">
                    <div class="rule-item">
                        <label>E - 外向性范围</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="ruleE1" min="0" max="21" placeholder="最小值" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                            <span>-</span>
                            <input type="number" id="ruleE2" min="0" max="21" placeholder="最大值" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                        </div>
                    </div>
                    <div class="rule-item">
                        <label>N - 神经质范围</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="ruleN1" min="0" max="24" placeholder="最小值" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                            <span>-</span>
                            <input type="number" id="ruleN2" min="0" max="24" placeholder="最大值" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                        </div>
                    </div>
                    <div class="rule-item">
                        <label>P - 精神质范围</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="ruleP1" min="0" max="21" placeholder="最小值" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                            <span>-</span>
                            <input type="number" id="ruleP2" min="0" max="21" placeholder="最大值" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                        </div>
                    </div>
                    <div class="rule-item">
                        <label>L - 掩饰性范围</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="ruleL1" min="0" max="22" placeholder="最小值" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                            <span>-</span>
                            <input type="number" id="ruleL2" min="0" max="22" placeholder="最大值" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border);">
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn btn-success" onclick="savePositionRule()" style="flex: 1;">
                            <i class="ri-save-line"></i> 保存规则
                        </button>
                        <button class="btn btn-secondary" onclick="resetPositionRule()" style="flex: 0 0 auto;" title="恢复默认规则">
                            <i class="ri-restart-line"></i> 重置
                        </button>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 12px; line-height: 1.5; padding: 10px; background: var(--bg); border-radius: 8px;">
                        💡 <strong>配置说明：</strong><br>
                        • 设置每个维度的理想分数范围<br>
                        • E(外向性): 0-21分<br>
                        • N(神经质): 0-24分，越低越稳定<br>
                        • P(精神质): 0-21分<br>
                        • L(掩饰性): 0-22分，越高越诚实
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== 全局配置 ====================
        const ADMIN_PASSWORD = 'epq_admin_123';
        const STORAGE_KEY = 'epq_records';
        const CONFIG_KEY = 'epqAdminSettings';
        const ITEMS_PER_PAGE = 10;

        // ==================== 全局变量 ====================
        let allRecords = [];
        let filteredRecords = [];
        let displayedRecords = [];
        let currentPage = 1;
        let sortColumn = 'createTime';
        let sortDirection = 'desc';
        let selectedRecords = new Set(); // 选中的记录ID集合
        let adminConfig = {
            modules: {
                stats: true,
                filter: true
            },
            positions: [],
            matchRules: {}
        };

        const LOCAL_DIMENSION_MAX = { E: 13, N: 14, P: 10, L: 11 };
        const STANDARD_MAX = { E: 21, N: 24, P: 21, L: 22 };

        function normalizeScores(scores) {
            if (!scores) return { E: 0, N: 0, P: 0, L: 0 };
            return {
                E: Math.round((scores.E / (LOCAL_DIMENSION_MAX.E || 1)) * STANDARD_MAX.E),
                N: Math.round((scores.N / (LOCAL_DIMENSION_MAX.N || 1)) * STANDARD_MAX.N),
                P: Math.round((scores.P / (LOCAL_DIMENSION_MAX.P || 1)) * STANDARD_MAX.P),
                L: Math.round((scores.L / (LOCAL_DIMENSION_MAX.L || 1)) * STANDARD_MAX.L)
            };
        }

        // 默认岗位配置（初始化时使用）
        const DEFAULT_POSITIONS = [
            'Java开发工程师', '前端开发工程师', '产品经理', 'UI设计师',
            '销售经理', '市场运营', '人力资源', '财务专员', '行政专员'
        ];

        // ==================== 岗位理想 EPQ 模型 ====================
        /**
         * 岗位理想 EPQ 模型配置
         * 基于职业心理学研究和实际招聘经验
         * 
         * 维度说明：
         * E（外向性 Extraversion）：0-21分
         *   - 低（0-7）：内向、安静、独立工作
         *   - 中（8-14）：平衡、适应性强
         *   - 高（15-21）：外向、社交、团队协作
         * 
         * N（神经质 Neuroticism）：0-24分
         *   - 低（0-8）：情绪稳定、抗压强
         *   - 中（9-16）：正常范围
         *   - 高（17-24）：敏感、情绪化（部分创意岗位可接受）
         * 
         * P（精神质 Psychoticism）：0-21分
         *   - 低（0-7）：传统、遵从、合作
         *   - 中（8-14）：平衡、有主见
         *   - 高（15-21）：独立、创新、竞争（注意人际关系）
         * 
         * L（掩饰性 Lie Scale）：0-22分
         *   - 低（0-9）：诚实但可能过于直接
         *   - 中（10-16）：真诚、社交得体
         *   - 高（17-22）：可能过度美化自己（需警惕）
         */
        const JOB_IDEAL_PROFILES = {
            'Java开发工程师': {
                name: 'Java开发工程师',
                ideal: { E: 10, N: 5, P: 10, L: 16 },  // 理想中心点
                range: { E: [6, 14], N: [0, 10], P: [6, 14], L: [12, 20] },  // 可接受范围
                description: '专注、逻辑性强、情绪稳定、诚实可靠',
                traits: ['逻辑思维', '专注力', '学习能力', '抗压能力'],
                risks: ['过于内向可能影响团队协作', '神经质高可能在高压下表现不佳']
            },
            '前端开发工程师': {
                name: '前端开发工程师',
                ideal: { E: 13, N: 6, P: 9, L: 15 },
                range: { E: [9, 17], N: [0, 10], P: [5, 13], L: [11, 19] },
                description: '沟通能力较强、细心、有审美、团队合作好',
                traits: ['审美能力', '沟通能力', '细节关注', '用户思维'],
                risks: ['外向性过低可能与设计师、产品沟通不畅', 'P值过高可能过于自我']
            },
            '产品经理': {
                name: '产品经理',
                ideal: { E: 16, N: 6, P: 10, L: 14 },
                range: { E: [13, 19], N: [0, 10], P: [7, 14], L: [10, 18] },
                description: '善于沟通、情绪稳定、有主见、同理心强',
                traits: ['沟通协调', '需求洞察', '逻辑分析', '抗压能力'],
                risks: ['外向性不足可能难以推动跨部门协作', '神经质高易受用户反馈影响']
            },
            'UI设计师': {
                name: 'UI设计师',
                ideal: { E: 12, N: 8, P: 11, L: 15 },
                range: { E: [8, 16], N: [0, 14], P: [7, 15], L: [11, 19] },
                description: '审美独特、细腻敏感、有创造力、沟通适度',
                traits: ['审美创意', '细节把控', '用户同理心', '接受反馈'],
                risks: ['过于敏感可能难以接受修改意见', 'P值过高可能不接受产品需求']
            },
            '销售经理': {
                name: '销售经理',
                ideal: { E: 18, N: 4, P: 13, L: 13 },
                range: { E: [15, 21], N: [0, 8], P: [10, 17], L: [9, 17] },
                description: '外向健谈、抗压能力强、竞争意识高、灵活变通',
                traits: ['人际交往', '抗压能力', '目标导向', '谈判说服'],
                risks: ['外向性不足难以开拓客户', '神经质高易受业绩压力影响']
            },
            '市场运营': {
                name: '市场运营',
                ideal: { E: 15, N: 7, P: 10, L: 14 },
                range: { E: [12, 18], N: [0, 12], P: [6, 14], L: [10, 18] },
                description: '善于沟通、数据敏感、有创意、执行力强',
                traits: ['数据分析', '创意策划', '沟通协调', '用户洞察'],
                risks: ['外向性不足可能难以对接资源', 'P值过低可能缺乏创新']
            },
            '人力资源': {
                name: '人力资源',
                ideal: { E: 14, N: 5, P: 7, L: 17 },
                range: { E: [11, 17], N: [0, 9], P: [3, 11], L: [14, 20] },
                description: '亲和力强、情绪稳定、原则性强、高度诚信',
                traits: ['沟通亲和', '情绪洞察', '保密意识', '公正客观'],
                risks: ['外向性不足可能难以与员工沟通', 'L值低可能处理敏感信息不当']
            },
            '财务专员': {
                name: '财务专员',
                ideal: { E: 9, N: 4, P: 6, L: 18 },
                range: { E: [5, 13], N: [0, 8], P: [0, 10], L: [15, 21] },
                description: '细致严谨、情绪稳定、原则性强、诚实可靠',
                traits: ['细节把控', '逻辑分析', '原则性', '责任心'],
                risks: ['神经质高可能在压力下出错', 'P值高可能不遵守财务规范']
            },
            '行政专员': {
                name: '行政专员',
                ideal: { E: 13, N: 6, P: 7, L: 16 },
                range: { E: [10, 16], N: [0, 10], P: [0, 11], L: [13, 19] },
                description: '服务意识强、细心周到、情绪稳定、可靠负责',
                traits: ['服务意识', '细节关注', '沟通协调', '执行力'],
                risks: ['外向性不足可能服务体验欠佳', 'P值高可能过于自我中心']
            }
        };

        // ==================== 日期处理辅助函数 ====================
        /**
         * 解析各种格式的日期字符串为 Date 对象
         * 支持格式：
         * - "2025-11-27 15:23:10"
         * - "2025/11/27 下午3:23:10"
         * - 其他 Date 构造函数能识别的格式
         */
        function parseDate(dateStr) {
            if (!dateStr) return new Date(0); // 返回一个很早的日期
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date;
                }
                // 如果无法解析，尝试提取数字部分
                const match = dateStr.match(/(\d{4})[-/年](\d{1,2})[-/月](\d{1,2})/);
                if (match) {
                    return new Date(match[1], parseInt(match[2]) - 1, match[3]);
                }
                return new Date(0);
            } catch (e) {
                console.error('日期解析错误:', dateStr, e);
                return new Date(0);
            }
        }

        /**
         * 获取日期的标准化字符串 (YYYY-MM-DD)
         */
        function getDateString(date) {
            if (typeof date === 'string') {
                date = parseDate(date);
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * 从 createTime 字符串中提取日期部分 (YYYY-MM-DD)
         */
        function extractDate(createTime) {
            if (!createTime) return '';
            try {
                // 尝试直接提取 YYYY-MM-DD 格式
                const match = createTime.match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
                if (match) {
                    const year = match[1];
                    const month = match[2].padStart(2, '0');
                    const day = match[3].padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                // 如果匹配失败，使用 parseDate
                return getDateString(parseDate(createTime));
            } catch (e) {
                console.error('日期提取错误:', createTime, e);
                return '';
            }
        }

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 支持回车登录
            document.getElementById('passwordInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });

            // 检查登录状态
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                showAdminPanel();
            }
        });

        // ==================== 登录相关 ====================
        function handleLogin() {
            const password = document.getElementById('passwordInput').value;
            const errorEl = document.getElementById('loginError');

            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showAdminPanel();
            } else {
                errorEl.textContent = '❌ 密码错误，请重试';
                errorEl.classList.add('show');
                setTimeout(() => errorEl.classList.remove('show'), 3000);
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('loginWrapper').style.display = 'flex';
            document.getElementById('adminWrapper').classList.remove('active');
            document.getElementById('passwordInput').value = '';
        }

        function showAdminPanel() {
            document.getElementById('loginWrapper').style.display = 'none';
            document.getElementById('adminWrapper').classList.add('active');
            loadConfig();
            loadData();
        }

        // ==================== 数据加载 ====================
        function loadData() {
            const dataPrimary = localStorage.getItem(STORAGE_KEY);
            const dataLegacy = localStorage.getItem('epqRecords');
            const listPrimary = dataPrimary ? JSON.parse(dataPrimary) : [];
            const listLegacy = dataLegacy ? JSON.parse(dataLegacy) : [];
            const mergedMap = new Map();
            [...listPrimary, ...listLegacy].forEach(r => {
                if (!r) return;
                const key = r.id || `${r.name || ''}-${r.phone || ''}-${r.createTime || ''}`;
                if (!mergedMap.has(key)) mergedMap.set(key, r);
            });
            allRecords = Array.from(mergedMap.values());
            
            // 修复数据格式兼容性
            allRecords = allRecords.map(record => {
                if (!record.scores) {
                    record.scores = { E: 0, N: 0, P: 0, L: 0 };
                }
                return record;
            });

            filteredRecords = [...allRecords];
            applySort();
            updateUI();
        }

        // ==================== 配置管理 ====================
        function loadConfig() {
            const savedConfig = localStorage.getItem(CONFIG_KEY);
            if (savedConfig) {
                const saved = JSON.parse(savedConfig);
                // 深度合并配置，确保新添加的配置项有默认值
                adminConfig = {
                    modules: { ...adminConfig.modules, ...(saved.modules || {}) },
                    positions: saved.positions || [],
                    matchRules: saved.matchRules || {}
                };
            }
            applyConfig();
        }

        function saveConfig() {
            localStorage.setItem(CONFIG_KEY, JSON.stringify(adminConfig));
        }

        function applyConfig() {
            // 模块显示
            document.getElementById('showStats').checked = adminConfig.modules.stats;
            document.getElementById('showFilter').checked = adminConfig.modules.filter;

            toggleModule('statsGrid', false);
            toggleModule('filterCard', false);

            

            // 如果没有自定义岗位，初始化默认岗位
            if (!adminConfig.positions || adminConfig.positions.length === 0) {
                adminConfig.positions = [...DEFAULT_POSITIONS];
                saveConfig();
            }

            // 渲染岗位列表
            renderPositionList();
            updateRulePositionSelect();
        }

        function toggleModule(moduleId, save = true) {
            const element = document.getElementById(moduleId);
            const checkboxId = 'show' + moduleId.charAt(0).toUpperCase() + moduleId.slice(1).replace(/Card|Grid/, '');
            const checkbox = document.getElementById(checkboxId);
            if (!element || !checkbox) return;

            if (checkbox.checked) {
                element.style.display = moduleId === 'statsGrid' ? 'grid' : 'block';
            } else {
                element.style.display = 'none';
            }

            if (save) {
                const configKey = moduleId.replace(/Card|Grid/, '').toLowerCase();
                adminConfig.modules[configKey] = checkbox.checked;
                saveConfig();
            }
        }

        function toggleConfigPanel() {
            const panel = document.getElementById('configPanel');
            const overlay = document.getElementById('modalOverlay');
            
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                panel.classList.add('active');
                overlay.classList.add('active');
                renderPositionList();
                updateRulePositionSelect();
            }
        }

        

        // ==================== 模态框管理 ====================
        function showModal(title, bodyHTML, footerButtons = []) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = bodyHTML;
            
            const footer = document.getElementById('modalFooter');
            footer.innerHTML = '';
            footerButtons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'btn ' + (btn.className || 'btn-primary');
                button.innerHTML = btn.text;
                button.onclick = btn.onclick;
                footer.appendChild(button);
            });
            
            document.getElementById('customModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('customModal').classList.remove('active');
        }

        // 点击模态框背景关闭
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('customModal');
            if (e.target === modal) {
                closeModal();
            }
        });

        // 确认对话框
        function showConfirmDialog(title, message, onConfirm, onCancel = null) {
            const bodyHTML = `
                <div style="padding: 10px 0;">
                    <p style="font-size: 15px; line-height: 1.8; color: var(--text-primary); white-space: pre-line;">${message}</p>
                </div>
            `;
            
            showModal(title, bodyHTML, [
                {
                    text: '<i class="ri-close-line"></i> 取消',
                    className: 'btn-cancel',
                    onclick: () => {
                        closeModal();
                        if (onCancel) onCancel();
                    }
                },
                {
                    text: '<i class="ri-check-line"></i> 确认',
                    className: 'btn-primary',
                    onclick: () => {
                        closeModal();
                        if (onConfirm) onConfirm();
                    }
                }
            ]);
        }

        // 提示对话框
        function showAlertDialog(title, message, type = 'info') {
            const icons = {
                success: '<i class="ri-checkbox-circle-line" style="color: var(--success); font-size: 48px;"></i>',
                error: '<i class="ri-error-warning-line" style="color: var(--danger); font-size: 48px;"></i>',
                info: '<i class="ri-information-line" style="color: var(--primary); font-size: 48px;"></i>'
            };
            
            const bodyHTML = `
                <div style="text-align: center; padding: 10px 0;">
                    ${icons[type] || icons.info}
                    <p style="font-size: 15px; line-height: 1.8; color: var(--text-primary); margin-top: 16px; white-space: pre-line;">${message}</p>
                </div>
            `;
            
            showModal(title, bodyHTML, [
                {
                    text: '<i class="ri-check-line"></i> 确定',
                    className: 'btn-primary',
                    onclick: closeModal
                }
            ]);
        }

        // ==================== 岗位管理 ====================
        function renderPositionList() {
            const listEl = document.getElementById('positionList');
            
            // 从实际数据中获取岗位
            const dataPositions = [...new Set(allRecords.map(r => r.position).filter(p => p))];
            
            // 合并配置中的岗位和实际数据中的岗位
            const allPositions = [...new Set([...(adminConfig.positions || []), ...dataPositions])].sort();
            
            if (allPositions.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">暂无岗位，请先添加</div>';
                return;
            }

            listEl.innerHTML = allPositions.map(pos => {
                const escaped = pos.replace(/'/g, "\\'");
                const hasRule = adminConfig.matchRules[pos];
                return `
                    <div class="position-item">
                        <div style="flex: 1;">
                            <span class="position-name">${pos}</span>
                            ${hasRule ? '<i class="ri-checkbox-circle-fill" style="color: var(--success); font-size: 14px; margin-left: 6px;" title="已配置规则"></i>' : ''}
                        </div>
                        <div class="position-actions">
                            <button class="icon-btn" onclick="editPosition('${escaped}')" title="编辑">
                                <i class="ri-edit-line"></i>
                            </button>
                            <button class="icon-btn delete" onclick="deletePosition('${escaped}')" title="删除">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddPositionDialog() {
            const bodyHTML = `
                <div class="form-field">
                    <label>岗位名称 <span style="color: var(--danger);">*</span></label>
                    <input type="text" id="newPositionName" placeholder="例如：数据分析师" autofocus>
                    <div class="form-hint">
                        <i class="ri-information-line"></i>
                        添加后可以为该岗位配置专属的匹配度规则
                    </div>
                </div>
                <div id="addPositionError" style="color: var(--danger); font-size: 13px; margin-top: 10px; display: none;"></div>
            `;
            
            showModal('添加新岗位', bodyHTML, [
                {
                    text: '<i class="ri-close-line"></i> 取消',
                    className: 'btn-cancel',
                    onclick: closeModal
                },
                {
                    text: '<i class="ri-add-line"></i> 确认添加',
                    className: 'btn-primary',
                    onclick: handleAddPosition
                }
            ]);

            // 回车提交
            setTimeout(() => {
                const input = document.getElementById('newPositionName');
                if (input) {
                    input.focus();
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            handleAddPosition();
                        }
                    });
                }
            }, 100);
        }

        function handleAddPosition() {
            const input = document.getElementById('newPositionName');
            const errorEl = document.getElementById('addPositionError');
            const posName = input.value.trim();
            
            if (!posName) {
                errorEl.textContent = '❌ 请输入岗位名称';
                errorEl.style.display = 'block';
                input.focus();
                return;
            }
            
            // 检查是否已存在
            const dataPositions = [...new Set(allRecords.map(r => r.position).filter(p => p))];
            const allPositions = [...new Set([...(adminConfig.positions || []), ...dataPositions])];
            
            if (allPositions.includes(posName)) {
                errorEl.textContent = '❌ 该岗位已存在！';
                errorEl.style.display = 'block';
                input.focus();
                return;
            }
            
            adminConfig.positions.push(posName);
            saveConfig();
            renderPositionList();
            updateFilters();
            updateRulePositionSelect();
            
            closeModal();
            
            // 询问是否立即配置规则
            showConfirmDialog(
                '添加成功',
                `岗位"${posName}"已成功添加！\n\n是否立即为该岗位配置匹配度规则？`,
                () => {
                    document.getElementById('rulePositionSelect').value = posName;
                    loadPositionRule();
                    document.getElementById('ruleForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            );
        }

        function editPosition(oldName) {
            const bodyHTML = `
                <div class="form-field">
                    <label>岗位名称 <span style="color: var(--danger);">*</span></label>
                    <input type="text" id="editPositionName" value="${oldName}" autofocus>
                    <div class="form-hint">
                        <i class="ri-information-line"></i>
                        修改后将同步更新匹配规则配置
                    </div>
                </div>
                <div id="editPositionError" style="color: var(--danger); font-size: 13px; margin-top: 10px; display: none;"></div>
            `;
            
            showModal('编辑岗位', bodyHTML, [
                {
                    text: '<i class="ri-close-line"></i> 取消',
                    className: 'btn-cancel',
                    onclick: closeModal
                },
                {
                    text: '<i class="ri-save-line"></i> 保存',
                    className: 'btn-primary',
                    onclick: () => handleEditPosition(oldName)
                }
            ]);

            // 回车提交
            setTimeout(() => {
                const input = document.getElementById('editPositionName');
                if (input) {
                    input.focus();
                    input.select();
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            handleEditPosition(oldName);
                        }
                    });
                }
            }, 100);
        }

        function handleEditPosition(oldName) {
            const input = document.getElementById('editPositionName');
            const errorEl = document.getElementById('editPositionError');
            const newName = input.value.trim();
            
            if (!newName) {
                errorEl.textContent = '❌ 请输入岗位名称';
                errorEl.style.display = 'block';
                input.focus();
                return;
            }
            
            if (newName === oldName) {
                closeModal();
                return;
            }
            
            // 检查新名称是否已存在
            const dataPositions = [...new Set(allRecords.map(r => r.position).filter(p => p))];
            const allPositions = [...new Set([...(adminConfig.positions || []), ...dataPositions])];
            
            if (allPositions.includes(newName)) {
                errorEl.textContent = '❌ 该岗位名称已存在！';
                errorEl.style.display = 'block';
                input.focus();
                return;
            }
            
            // 更新配置中的岗位
            const index = adminConfig.positions.indexOf(oldName);
            if (index > -1) {
                adminConfig.positions[index] = newName;
            } else if (!adminConfig.positions.includes(newName)) {
                adminConfig.positions.push(newName);
            }

            // 更新匹配规则
            if (adminConfig.matchRules[oldName]) {
                adminConfig.matchRules[newName] = adminConfig.matchRules[oldName];
                delete adminConfig.matchRules[oldName];
            }

            saveConfig();
            renderPositionList();
            updateFilters();
            updateRulePositionSelect();
            
            closeModal();
            showAlertDialog('修改成功', `岗位名称已从"${oldName}"更新为"${newName}"`, 'success');
        }

        function deletePosition(posName) {
            const recordCount = allRecords.filter(r => r.position === posName).length;
            const hasRecords = recordCount > 0;
            
            let message = `确定要删除岗位"${posName}"吗？`;
            if (hasRecords) {
                message += `\n\n⚠️ 注意：该岗位有 ${recordCount} 条测试记录。\n删除后这些记录仍会保留，但岗位不会出现在筛选列表中。`;
            } else {
                message += '\n\n该岗位暂无测试记录。';
            }
            
            showConfirmDialog('删除岗位', message, () => {
                adminConfig.positions = adminConfig.positions.filter(p => p !== posName);
                delete adminConfig.matchRules[posName];
                saveConfig();
                renderPositionList();
                updateFilters();
                updateRulePositionSelect();
                showAlertDialog('删除成功', `岗位"${posName}"已删除`, 'success');
            });
        }

        function exportPositionConfig() {
            const config = {
                positions: adminConfig.positions,
                matchRules: adminConfig.matchRules,
                exportTime: new Date().toLocaleString('zh-CN'),
                version: '1.0'
            };

            const jsonStr = JSON.stringify(config, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const fileName = `epq_position_config_${new Date().toISOString().split('T')[0]}.json`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ==================== 匹配度规则配置 ====================
        function updateRulePositionSelect() {
            const select = document.getElementById('rulePositionSelect');
            const dataPositions = [...new Set(allRecords.map(r => r.position).filter(p => p))];
            const allPositions = [...new Set([...(adminConfig.positions || []), ...dataPositions])].sort();
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">选择岗位</option>';
            allPositions.forEach(pos => {
                const hasRule = adminConfig.matchRules[pos] ? ' ✓' : '';
                select.innerHTML += `<option value="${pos}">${pos}${hasRule}</option>`;
            });
            // 恢复之前选择的值
            if (currentValue && allPositions.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function loadPositionRule() {
            const position = document.getElementById('rulePositionSelect').value;
            const formEl = document.getElementById('ruleForm');
            
            if (!position) {
                formEl.style.display = 'none';
                return;
            }

            formEl.style.display = 'block';

            // 加载规则（如果存在）
            const isCustomRule = !!adminConfig.matchRules[position];
            const rule = adminConfig.matchRules[position] || getDefaultRule(position);
            
            document.getElementById('ruleE1').value = rule.E[0];
            document.getElementById('ruleE2').value = rule.E[1];
            document.getElementById('ruleN1').value = rule.N[0];
            document.getElementById('ruleN2').value = rule.N[1];
            document.getElementById('ruleP1').value = rule.P[0];
            document.getElementById('ruleP2').value = rule.P[1];
            document.getElementById('ruleL1').value = rule.L[0];
            document.getElementById('ruleL2').value = rule.L[1];

            // 显示规则来源提示
            const hint = document.getElementById('ruleHint');
            if (hint) {
                hint.textContent = isCustomRule ? '✓ 已配置自定义规则' : '使用默认规则';
                hint.style.color = isCustomRule ? 'var(--success)' : 'var(--text-secondary)';
            }
        }

        function getDefaultRule(position) {
            // 返回默认规则
            const profiles = {
                'Java开发工程师': { E: [8, 15], N: [0, 10], P: [0, 10], L: [10, 22] },
                '前端开发工程师': { E: [10, 18], N: [0, 10], P: [0, 8], L: [10, 22] },
                '产品经理': { E: [14, 21], N: [0, 12], P: [5, 12], L: [8, 22] },
                'UI设计师': { E: [8, 16], N: [0, 12], P: [8, 15], L: [10, 22] },
                '销售经理': { E: [16, 21], N: [0, 8], P: [6, 14], L: [12, 22] },
                '市场运营': { E: [14, 21], N: [0, 10], P: [6, 13], L: [10, 22] },
                '人力资源': { E: [12, 20], N: [0, 8], P: [0, 8], L: [14, 22] },
                '财务专员': { E: [6, 14], N: [0, 8], P: [0, 6], L: [16, 22] },
                '行政专员': { E: [10, 18], N: [0, 10], P: [0, 8], L: [12, 22] }
            };
            return profiles[position] || { E: [8, 16], N: [0, 12], P: [0, 12], L: [8, 22] };
        }

        function savePositionRule() {
            const position = document.getElementById('rulePositionSelect').value;
            if (!position) {
                alert('请先选择岗位！');
                return;
            }

            const E1 = parseInt(document.getElementById('ruleE1').value);
            const E2 = parseInt(document.getElementById('ruleE2').value);
            const N1 = parseInt(document.getElementById('ruleN1').value);
            const N2 = parseInt(document.getElementById('ruleN2').value);
            const P1 = parseInt(document.getElementById('ruleP1').value);
            const P2 = parseInt(document.getElementById('ruleP2').value);
            const L1 = parseInt(document.getElementById('ruleL1').value);
            const L2 = parseInt(document.getElementById('ruleL2').value);

            // 验证
            if (isNaN(E1) || isNaN(E2) || isNaN(N1) || isNaN(N2) || 
                isNaN(P1) || isNaN(P2) || isNaN(L1) || isNaN(L2)) {
                alert('请填写所有字段！');
                return;
            }

            if (E1 > E2 || N1 > N2 || P1 > P2 || L1 > L2) {
                alert('最小值不能大于最大值！');
                return;
            }

            if (E1 < 0 || E2 > 21 || N1 < 0 || N2 > 24 || P1 < 0 || P2 > 21 || L1 < 0 || L2 > 22) {
                alert('分数范围超出限制！\nE: 0-21, N: 0-24, P: 0-21, L: 0-22');
                return;
            }

            // 保存规则
            adminConfig.matchRules[position] = {
                E: [E1, E2],
                N: [N1, N2],
                P: [P1, P2],
                L: [L1, L2]
            };

            saveConfig();
            
            // 更新界面显示
            renderPositionList();
            updateRulePositionSelect();
            loadPositionRule();
            
            // 重新计算匹配度并更新界面
            updateUI();
            
            alert('✓ 规则保存成功！匹配度已重新计算。');
        }

        function resetPositionRule() {
            const position = document.getElementById('rulePositionSelect').value;
            if (!position) {
                alert('请先选择岗位！');
                return;
            }

            if (!confirm(`确定要恢复"${position}"的默认规则吗？`)) {
                return;
            }

            // 删除自定义规则
            delete adminConfig.matchRules[position];
            saveConfig();

            // 重新加载默认规则
            loadPositionRule();
            renderPositionList();
            updateRulePositionSelect();
            updateUI();

            alert('✓ 已恢复默认规则！');
        }

        // ==================== UI 更新 ====================
        function updateUI() {
            updateStats();
            updateFilters();
            updateCandidateList();
        }

        // ==================== 统计卡片 ====================
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            const totalCount = allRecords.length;
            const filteredCount = filteredRecords.length;
            const positions = new Set(allRecords.map(r => r.position));
            
            // 今日新增
            const todayStr = getDateString(new Date());
            const todayCount = allRecords.filter(r => {
                const recordDateStr = extractDate(r.createTime);
                return recordDateStr === todayStr;
            }).length;

            // 昨日数据
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = getDateString(yesterday);
            const yesterdayCount = allRecords.filter(r => {
                const recordDateStr = extractDate(r.createTime);
                return recordDateStr === yesterdayStr;
            }).length;

            const todayChange = yesterdayCount > 0 ? (((todayCount - yesterdayCount) / yesterdayCount) * 100).toFixed(0) : 0;

            // 计算平均匹配度
            let highMatchCount = 0;
            filteredRecords.forEach(record => {
                const fit = evaluateFit(record.position, record.scores);
                if (fit.level === '高匹配') highMatchCount++;
            });
            const highMatchPercent = filteredCount > 0 ? ((highMatchCount / filteredCount) * 100).toFixed(0) : 0;

            statsGrid.innerHTML = `
                <div class="stat-card gradient-1">
                    <div class="stat-header">
                        <h3>总测试人数</h3>
                        <div class="stat-icon">
                            <i class="ri-user-line"></i>
                        </div>
                    </div>
                    <div class="stat-value">${totalCount}</div>
                    <div class="stat-footer">
                        <span>累计参与测试人数</span>
                    </div>
                </div>

                <div class="stat-card gradient-2">
                    <div class="stat-header">
                        <h3>应聘岗位数</h3>
                        <div class="stat-icon">
                            <i class="ri-briefcase-line"></i>
                        </div>
                    </div>
                    <div class="stat-value">${positions.size}</div>
                    <div class="stat-footer">
                        <span>涵盖不同职位类型</span>
                    </div>
                </div>

                <div class="stat-card gradient-3">
                    <div class="stat-header">
                        <h3>今日新增</h3>
                        <div class="stat-icon">
                            <i class="ri-calendar-check-line"></i>
                        </div>
                    </div>
                    <div class="stat-value">${todayCount}</div>
                    <div class="stat-footer">
                        <span class="stat-change ${todayChange >= 0 ? 'up' : 'down'}">
                            <i class="ri-arrow-${todayChange >= 0 ? 'up' : 'down'}-line"></i>
                            ${Math.abs(todayChange)}%
                        </span>
                        <span>较昨日</span>
                    </div>
                </div>

                <div class="stat-card gradient-4">
                    <div class="stat-header">
                        <h3>当前筛选结果</h3>
                        <div class="stat-icon">
                            <i class="ri-filter-line"></i>
                        </div>
                    </div>
                    <div class="stat-value">${filteredCount}</div>
                    <div class="stat-footer">
                        <span>符合筛选条件的记录</span>
                    </div>
                </div>

                <div class="stat-card gradient-5">
                    <div class="stat-header">
                        <h3>高匹配占比</h3>
                        <div class="stat-icon">
                            <i class="ri-medal-line"></i>
                        </div>
                    </div>
                    <div class="stat-value">${highMatchPercent}%</div>
                    <div class="stat-footer">
                        <span>${highMatchCount} 人达到高匹配标准</span>
                    </div>
                </div>
            `;
        }

        // ==================== 筛选功能 ====================
        function updateFilters() {
            const positionSelect = document.getElementById('filterPosition');
            const dataPositions = [...new Set(allRecords.map(r => r.position).filter(p => p))];
            const allPositions = [...new Set([...(adminConfig.positions || []), ...dataPositions])].sort();
            
            const currentValue = positionSelect.value;
            positionSelect.innerHTML = '<option value="">全部岗位</option>';
            allPositions.forEach(pos => {
                const count = allRecords.filter(r => r.position === pos).length;
                positionSelect.innerHTML += `<option value="${pos}">${pos} (${count})</option>`;
            });
            positionSelect.value = currentValue;
        }

        // 切换筛选面板
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const btn = document.getElementById('filterBtnText');
            const isVisible = panel.style.display !== 'none';
            
            panel.style.display = isVisible ? 'none' : 'block';
            btn.textContent = isVisible ? '显示筛选' : '隐藏筛选';
        }

        function applyFilters() {
            const position = document.getElementById('filterPosition').value;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();

            // 成绩区间
            const eMin = document.getElementById('filterEMin').value;
            const eMax = document.getElementById('filterEMax').value;
            const nMin = document.getElementById('filterNMin').value;
            const nMax = document.getElementById('filterNMax').value;
            const pMin = document.getElementById('filterPMin').value;
            const pMax = document.getElementById('filterPMax').value;
            const lMin = document.getElementById('filterLMin').value;
            const lMax = document.getElementById('filterLMax').value;

            filteredRecords = allRecords.filter(record => {
                // 岗位筛选
                if (position && record.position !== position) return false;

                // 日期筛选
                const recordDate = parseDate(record.createTime);
                if (startDate) {
                    const startDateTime = new Date(startDate);
                    startDateTime.setHours(0, 0, 0, 0);
                    recordDate.setHours(0, 0, 0, 0);
                    if (recordDate < startDateTime) return false;
                    recordDate.setHours(0, 0, 0, 0); // 重置以便后续比较
                }
                if (endDate) {
                    const endDateTime = new Date(endDate);
                    endDateTime.setHours(23, 59, 59, 999);
                    const recordDateCopy = parseDate(record.createTime);
                    if (recordDateCopy > endDateTime) return false;
                }

                // 关键词搜索
                if (keyword) {
                    const nameMatch = (record.name || '').toLowerCase().includes(keyword);
                    const phoneMatch = (record.phone || '').includes(keyword);
                    if (!nameMatch && !phoneMatch) return false;
                }

                // 成绩区间筛选
                if (record.scores) {
                    if (eMin && record.scores.E < parseInt(eMin)) return false;
                    if (eMax && record.scores.E > parseInt(eMax)) return false;
                    if (nMin && record.scores.N < parseInt(nMin)) return false;
                    if (nMax && record.scores.N > parseInt(nMax)) return false;
                    if (pMin && record.scores.P < parseInt(pMin)) return false;
                    if (pMax && record.scores.P > parseInt(pMax)) return false;
                    if (lMin && record.scores.L < parseInt(lMin)) return false;
                    if (lMax && record.scores.L > parseInt(lMax)) return false;
                }

                return true;
            });

            currentPage = 1;
            applySort();
            updateUI();
            
            // 更新筛选信息显示
            const filteredInfo = document.getElementById('filteredInfo');
            const filteredCount = document.getElementById('filteredCount');
            if (filteredRecords.length < allRecords.length) {
                filteredInfo.style.display = 'inline';
                filteredCount.textContent = filteredRecords.length;
            } else {
                filteredInfo.style.display = 'none';
            }
        }

        function resetFilters() {
            document.getElementById('filterPosition').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('searchKeyword').value = '';
            
            // 清空成绩区间
            document.getElementById('filterEMin').value = '';
            document.getElementById('filterEMax').value = '';
            document.getElementById('filterNMin').value = '';
            document.getElementById('filterNMax').value = '';
            document.getElementById('filterPMin').value = '';
            document.getElementById('filterPMax').value = '';
            document.getElementById('filterLMin').value = '';
            document.getElementById('filterLMax').value = '';
            
            applyFilters();
        }

        function setQuickFilter(days) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);

            document.getElementById('filterStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('filterEndDate').value = endDate.toISOString().split('T')[0];
            applyFilters();
        }

        // ==================== 排序功能 ====================
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }

            applySort();
            updateCandidateList();
            updateSortIcons();
        }

        function applySort() {
            filteredRecords.sort((a, b) => {
                let valueA, valueB;

                if (sortColumn === 'createTime') {
                    valueA = parseDate(a.createTime).getTime();
                    valueB = parseDate(b.createTime).getTime();
                } else if (['E', 'N', 'P', 'L'].includes(sortColumn)) {
                    valueA = a.scores[sortColumn];
                    valueB = b.scores[sortColumn];
                } else {
                    valueA = a[sortColumn];
                    valueB = b[sortColumn];
                }

                return sortDirection === 'asc' ? 
                    (valueA > valueB ? 1 : -1) : 
                    (valueA < valueB ? 1 : -1);
            });
        }

        function updateSortIcons() {
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            const columns = ['createTime', 'name', 'phone', 'position', 'E', 'N', 'P', 'L'];
            const columnIndex = columns.indexOf(sortColumn);
            const ths = document.querySelectorAll('th');
            if (columnIndex >= 0 && ths.length > columnIndex && ths[columnIndex]) {
                ths[columnIndex].classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }

        
        function updateCandidateList() {
            const listEl = document.getElementById('candidateList');
            const totalRecordsEl = document.getElementById('totalRecords');
            totalRecordsEl.textContent = filteredRecords.length;

            const hasData = filteredRecords.length > 0;
            document.getElementById('selectAllBtn').style.display = hasData ? 'inline-flex' : 'none';

            if (filteredRecords.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><i class="ri-inbox-line"></i></div>
                        <h3>暂无数据</h3>
                        <p>当前筛选条件下没有找到测试记录</p>
                    </div>
                `;
                const pagEl = document.getElementById('candidatePagination');
                if (pagEl) pagEl.innerHTML = '';
                updateSelectionUI();
                document.getElementById('candidateDetail').innerHTML = '';
                return;
            }

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredRecords.length);
            displayedRecords = filteredRecords.slice(startIndex, endIndex);

            listEl.innerHTML = displayedRecords.map(record => {
                const fit = evaluateFit(record.position, record.scores);
                const phone = maskPhone(record.phone);
                const isSelected = selectedRecords.has(record.id);
                const initials = (record.name || '').slice(0,1) || '候';
                return `
                    <div class="candidate-item ${isSelected ? 'active' : ''}" onclick="showCandidateDetail('${record.id}')">
                        <input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleRecord('${record.id}')">
                        <div class="candidate-avatar">${initials}</div>
                        <div class="candidate-info">
                            <div class="candidate-name">${record.name || ''} <span class="badge ${fit.badgeClass}" style="margin-left:8px;">${fit.level}</span></div>
                            <div class="candidate-meta">
                                <span>${record.position || '未填写'}</span>
                                <span>${phone}</span>
                                <span>${record.createTime || ''}</span>
                            </div>
                        </div>
                        <div class="candidate-scores">
                            <div class="score-dot">E${record.scores?.E ?? ''}</div>
                            <div class="score-dot">N${record.scores?.N ?? ''}</div>
                            <div class="score-dot">P${record.scores?.P ?? ''}</div>
                            <div class="score-dot">L${record.scores?.L ?? ''}</div>
                        </div>
                    </div>
                `;
            }).join('');

            updatePagination();
            updateSelectionUI();
        }

        // 更新选择UI状态
        function updateSelectionUI() {
            const selectedCount = selectedRecords.size;
            document.getElementById('selectedCount').textContent = selectedCount;
            document.getElementById('deleteSelectedBtn').style.display = selectedCount > 0 ? 'inline-flex' : 'none';
            
            // 更新全选复选框状态
            const headerCheckbox = document.getElementById('headerCheckbox');
            if (headerCheckbox && displayedRecords.length > 0) {
                const allSelected = displayedRecords.every(r => selectedRecords.has(r.id));
                const someSelected = displayedRecords.some(r => selectedRecords.has(r.id));
                headerCheckbox.checked = allSelected;
                headerCheckbox.indeterminate = someSelected && !allSelected;
            }
        }

        // 切换单条记录选择
        function toggleRecord(recordId) {
            if (selectedRecords.has(recordId)) {
                selectedRecords.delete(recordId);
            } else {
                selectedRecords.add(recordId);
            }
            updateSelectionUI();
        }

        // 全选/取消全选当前页
        function toggleSelectAll() {
            const headerCheckbox = document.getElementById('headerCheckbox');
            if (headerCheckbox) {
                if (headerCheckbox.checked) {
                    displayedRecords.forEach(r => selectedRecords.add(r.id));
                } else {
                    displayedRecords.forEach(r => selectedRecords.delete(r.id));
                }
            } else {
                const allSelected = displayedRecords.every(r => selectedRecords.has(r.id));
                if (allSelected) {
                    displayedRecords.forEach(r => selectedRecords.delete(r.id));
                    document.getElementById('selectAllText').textContent = '全选';
                } else {
                    displayedRecords.forEach(r => selectedRecords.add(r.id));
                    document.getElementById('selectAllText').textContent = '取消全选';
                }
            }
            updateCandidateList();
        }

        // 删除单条记录
        function deleteRecord(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;
            
            showConfirmDialog(
                '删除记录',
                `确定要删除"${record.name}"的测试记录吗？\n\n此操作不可恢复！`,
                () => {
                    // 从数据中删除
                    allRecords = allRecords.filter(r => r.id !== recordId);
                    selectedRecords.delete(recordId);
                    
                    // 保存到 localStorage
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(allRecords));
                    
                    // 重新加载数据
                    loadData();
                    
                    showAlertDialog('删除成功', '记录已删除', 'success');
                }
            );
        }

        // 批量删除
        function deleteSelected() {
            if (selectedRecords.size === 0) {
                showAlertDialog('提示', '请先选择要删除的记录！', 'info');
                return;
            }

            showConfirmDialog(
                '批量删除',
                `确定要删除选中的 ${selectedRecords.size} 条记录吗？\n\n此操作不可恢复！`,
                () => {
                    // 批量删除
                    const idsToDelete = Array.from(selectedRecords);
                    const deleteCount = idsToDelete.length;
                    allRecords = allRecords.filter(r => !idsToDelete.includes(r.id));
                    selectedRecords.clear();
                    
                    // 保存到 localStorage
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(allRecords));
                    
                    // 重新加载数据
                    loadData();
                    
                    showAlertDialog('删除成功', `成功删除 ${deleteCount} 条记录`, 'success');
                }
            );
        }

        // ==================== 分页 ====================
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const candidatePagination = document.getElementById('candidatePagination');
            const totalPages = Math.ceil(filteredRecords.length / ITEMS_PER_PAGE);

            if (totalPages <= 1) {
                if (pagination) pagination.innerHTML = '';
                if (candidatePagination) candidatePagination.innerHTML = '';
                return;
            }

            let html = `
                <button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="ri-arrow-left-s-line"></i>
                </button>
            `;

            // 页码按钮
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            if (startPage > 1) {
                html += `<button class="page-btn" onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="page-info">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span class="page-info">...</span>`;
                }
                html += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }

            html += `
                <button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="ri-arrow-right-s-line"></i>
                </button>
            `;

            if (pagination) pagination.innerHTML = html;
            if (candidatePagination) candidatePagination.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredRecords.length / ITEMS_PER_PAGE);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            updateCandidateList();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==================== 详情抽屉 ====================
        function showDetail(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;

            const fit = evaluateFit(record.position, record.scores);
            const profile = generateCandidateProfile(record);
            const matchScore = profile.matchScore;
            const drawerBody = document.getElementById('drawerBody');

            drawerBody.innerHTML = `
                <div class="detail-section">
                    <h3><i class="ri-user-3-line"></i> 基本信息</h3>
                    <div class="detail-item">
                        <div class="detail-label">姓名</div>
                        <div class="detail-value">${record.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">手机号</div>
                        <div class="detail-value">${record.phone}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">应聘岗位</div>
                        <div class="detail-value">${record.position}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">提交时间</div>
                        <div class="detail-value">${record.createTime}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">备注</div>
                        <div class="detail-value">${record.remark || '无'}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-profile-line"></i> 性格画像</h3>
                    <div style="padding: 16px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 12px; margin-top: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="badge badge-primary" style="font-size: 16px; padding: 8px 16px;">
                                    ${profile.type}
                                </span>
                                <span style="color: var(--text-secondary); font-size: 14px;">
                                    综合匹配分: <strong style="color: ${matchScore >= 80 ? '#10b981' : matchScore >= 60 ? '#f59e0b' : '#ef4444'}; font-size: 18px;">${matchScore}</strong> 分
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-bar-chart-line"></i> EPQ 分数</h3>
                    <div class="detail-item">
                        <div class="detail-label">E - 外向性</div>
                        <div class="detail-value"><span class="score-badge">${record.scores.E}</span> / 21</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">N - 神经质</div>
                        <div class="detail-value"><span class="score-badge">${record.scores.N}</span> / 24</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">P - 精神质</div>
                        <div class="detail-value"><span class="score-badge">${record.scores.P}</span> / 21</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">L - 掩饰性</div>
                        <div class="detail-value"><span class="score-badge">${record.scores.L}</span> / 22</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-radar-line"></i> EPQ 雷达图对比</h3>
                    <div id="detailRadarChart" class="chart-container"></div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-star-line"></i> 优势特质</h3>
                    <div style="padding: 16px; background: var(--bg); border-radius: 12px; margin-top: 12px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${profile.strengths.map(s => `<span class="badge badge-success">${s}</span>`).join('')}
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-alert-line"></i> 风险点</h3>
                    <div style="padding: 16px; background: var(--bg); border-radius: 12px; margin-top: 12px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${profile.risks.map(r => `<span class="badge badge-warning">${r}</span>`).join('')}
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-lightbulb-line"></i> 面试建议</h3>
                    <div style="padding: 16px; background: var(--bg); border-radius: 12px; margin-top: 12px;">
                        <ul style="margin: 0; padding-left: 20px; line-height: 2;">
                            ${profile.suggestions.map(s => `<li style="color: var(--text-primary);">${s}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-medal-line"></i> 岗位匹配度评估</h3>
                    <div style="padding: 16px; background: var(--bg); border-radius: 12px; margin-top: 12px;">
                        <div style="margin-bottom: 12px;">
                            <span class="badge ${fit.badgeClass}" style="font-size: 14px; padding: 6px 12px;">
                                ${fit.level}
                            </span>
                        </div>
                        <p style="color: var(--text-primary); line-height: 1.8;">
                            ${profile.fitAnalysis || fit.description}
                        </p>
                    </div>
                </div>
            `;

            // 渲染雷达图（实际值 vs 理想值）
            setTimeout(() => {
                const chart = echarts.init(document.getElementById('detailRadarChart'));
                const idealProfile = JOB_IDEAL_PROFILES[record.position];
                
                const norm = normalizeScores(record.scores);
                const radarData = [{
                    value: [norm.E, norm.N, norm.P, norm.L],
                    name: '实际值',
                    itemStyle: { color: '#4f46e5' },
                    areaStyle: { opacity: 0.3 },
                    lineStyle: { width: 2 }
                }];

                // 如果有理想模型，添加对比线
                if (idealProfile) {
                    radarData.push({
                        value: [idealProfile.ideal.E, idealProfile.ideal.N, idealProfile.ideal.P, idealProfile.ideal.L],
                        name: '理想值',
                        itemStyle: { color: '#10b981' },
                        areaStyle: { opacity: 0.1 },
                        lineStyle: { type: 'dashed', width: 2 }
                    });
                }

                const option = {
                    tooltip: { trigger: 'item' },
                    legend: { data: radarData.map(d => d.name), top: 6, left: 'center' },
                    radar: {
                        indicator: [
                            { name: 'E-外向性', max: 21 },
                            { name: 'N-神经质', max: 24 },
                            { name: 'P-精神质', max: 21 },
                            { name: 'L-掩饰性', max: 22 }
                        ],
                        center: ['50%', '50%'],
                        radius: '42%',
                        name: { textStyle: { color: '#6b7280', fontSize: 12, fontWeight: 600 } },
                        splitLine: { lineStyle: { color: 'rgba(99,102,241,0.18)' } },
                        splitArea: { areaStyle: { color: ['rgba(99,102,241,0.06)'] } }
                    },
                    series: [{ type: 'radar', data: radarData }]
                };
                chart.setOption(option);
                window.addEventListener('resize', () => chart.resize());
            }, 100);

            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('detailDrawer').classList.add('active');
        }

        
        function showCandidateDetail(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;

            const fit = evaluateFit(record.position, record.scores);
            const profile = generateCandidateProfile(record);
            const matchScore = profile.matchScore;
            const container = document.getElementById('candidateDetail');

            container.innerHTML = `
                <div class="detail-section">
                    <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;">
                        <div class="candidate-avatar" style="width:48px;height:48px;">${(record.name||'').slice(0,1) || '候'}</div>
                        <div>
                            <div style="font-size:18px;font-weight:700;color:var(--text-primary);">${record.name || ''}</div>
                            <div class="candidate-meta" style="margin-top:4px;">
                                <span>${record.position || '未填写'}</span>
                                <span>${record.phone || ''}</span>
                                <span>${record.createTime || ''}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-profile-line"></i> 性格画像</h3>
                    <div style="padding: 16px; background: var(--bg); border-radius: 12px; margin-top: 12px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span class="badge badge-primary" style="font-size:14px;">${profile.type}</span>
                            <span style="color: var(--text-secondary); font-size: 14px;">综合匹配分: <strong style="color: ${matchScore >= 80 ? '#10b981' : matchScore >= 60 ? '#f59e0b' : '#ef4444'}; font-size: 16px;">${matchScore}</strong> 分</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-bar-chart-line"></i> EPQ 分数</h3>
                    <div class="detail-item"><div class="detail-label">E - 外向性</div><div class="detail-value"><span class="score-badge">${record.scores.E}</span> / 21</div></div>
                    <div class="detail-item"><div class="detail-label">N - 神经质</div><div class="detail-value"><span class="score-badge">${record.scores.N}</span> / 24</div></div>
                    <div class="detail-item"><div class="detail-label">P - 精神质</div><div class="detail-value"><span class="score-badge">${record.scores.P}</span> / 21</div></div>
                    <div class="detail-item"><div class="detail-label">L - 掩饰性</div><div class="detail-value"><span class="score-badge">${record.scores.L}</span> / 22</div></div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-radar-line"></i> EPQ 雷达图对比</h3>
                    <div id="candidateDetailRadar" class="chart-container"></div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-star-line"></i> 优势特质</h3>
                    <div style="padding: 16px; background: var(--bg); border-radius: 12px; margin-top: 12px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${profile.strengths.map(s => `<span class=\"badge badge-success\">${s}</span>`).join('')}
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-alert-line"></i> 风险点</h3>
                    <div style="padding: 16px; background: var(--bg); border-radius: 12px; margin-top: 12px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${profile.risks.map(r => `<span class=\"badge badge-warning\">${r}</span>`).join('')}
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="ri-medal-line"></i> 岗位匹配度评估</h3>
                    <div style="padding: 16px; background: var(--bg); border-radius: 12px; margin-top: 12px;">
                        <div style="margin-bottom: 12px;">
                            <span class="badge ${fit.badgeClass}" style="font-size: 14px; padding: 6px 12px;">${fit.level}</span>
                        </div>
                        <p style="color: var(--text-primary); line-height: 1.8;">${profile.fitAnalysis || fit.description}</p>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const chart = echarts.init(document.getElementById('candidateDetailRadar'));
                const idealProfile = JOB_IDEAL_PROFILES[record.position];
                const norm = normalizeScores(record.scores);
                const radarData = [{
                    value: [norm.E, norm.N, norm.P, norm.L],
                    name: '实际值',
                    itemStyle: { color: '#4f46e5' },
                    areaStyle: { opacity: 0.3 },
                    lineStyle: { width: 2 }
                }];
                if (idealProfile) {
                    radarData.push({
                        value: [idealProfile.ideal.E, idealProfile.ideal.N, idealProfile.ideal.P, idealProfile.ideal.L],
                        name: '理想值',
                        itemStyle: { color: '#10b981' },
                        areaStyle: { opacity: 0.1 },
                        lineStyle: { type: 'dashed', width: 2 }
                    });
                }
                const option = {
                    tooltip: { trigger: 'item' },
                    legend: { data: radarData.map(d => d.name), top: 6, left: 'center' },
                    radar: {
                        indicator: [
                            { name: 'E-外向性', max: 21 },
                            { name: 'N-神经质', max: 24 },
                            { name: 'P-精神质', max: 21 },
                            { name: 'L-掩饰性', max: 22 }
                        ],
                        center: ['50%', '50%'],
                        radius: '42%',
                        name: { textStyle: { color: '#6b7280', fontSize: 12, fontWeight: 600 } },
                        splitLine: { lineStyle: { color: 'rgba(99,102,241,0.18)' } },
                        splitArea: { areaStyle: { color: ['rgba(99,102,241,0.06)'] } }
                    },
                    series: [{ type: 'radar', data: radarData }]
                };
                chart.setOption(option);
                window.addEventListener('resize', () => chart.resize());
            }, 100);
        }

        function closeDrawer() {
            const overlay = document.getElementById('modalOverlay');
            const drawer = document.getElementById('detailDrawer');
            const configPanel = document.getElementById('configPanel');
            
            drawer.classList.remove('active');
            
            // 只有当配置面板也关闭时，才关闭遮罩层
            if (!configPanel.classList.contains('active')) {
                overlay.classList.remove('active');
            }
        }

        function closeAllPanels() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('detailDrawer').classList.remove('active');
            document.getElementById('configPanel').classList.remove('active');
        }

        // ==================== 图表渲染 ====================
        function updateCharts() {
            if (filteredRecords.length === 0) {
                ['chartJobMatch', 'chartCompetition', 'chartProfile'].forEach(id => {
                    document.getElementById(id).innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="ri-line-chart-line"></i></div>
                            <h3>暂无数据</h3>
                            <p>没有足够的数据生成图表</p>
                        </div>
                    `;
                });
                return;
            }

            renderJobMatchChart();
            renderCompetitionChart();
            renderProfileChart();
        }

        // ==================== 图表 1: 岗位匹配度雷达分析 ====================
        /**
         * 岗位匹配度雷达分析
         * 展示所有候选人与其应聘岗位理想模型的匹配度
         * 使用雷达图直观展示四个维度的偏差
         */
        function renderJobMatchChart() {
            const chartDom = document.getElementById('chartJobMatch');
            const chart = echarts.init(chartDom);
            
            // 按岗位分组，计算平均值和理想值
            const positionData = {};
            filteredRecords.forEach(record => {
                if (!positionData[record.position]) {
                    positionData[record.position] = {
                        scores: { E: [], N: [], P: [], L: [] },
                        count: 0
                    };
                }
                const norm = normalizeScores(record.scores);
                positionData[record.position].scores.E.push(norm.E);
                positionData[record.position].scores.N.push(norm.N);
                positionData[record.position].scores.P.push(norm.P);
                positionData[record.position].scores.L.push(norm.L);
                positionData[record.position].count++;
            });

            // 构建雷达图数据
            const indicator = [
                { name: 'E-外向性', max: 21 },
                { name: 'N-神经质', max: 24 },
                { name: 'P-精神质', max: 21 },
                { name: 'L-掩饰性', max: 22 }
            ];

            const seriesData = [];
            const positions = Object.keys(positionData);

            positions.forEach(position => {
                const data = positionData[position];
                const avgScores = {
                    E: (data.scores.E.reduce((a, b) => a + b, 0) / data.count).toFixed(1),
                    N: (data.scores.N.reduce((a, b) => a + b, 0) / data.count).toFixed(1),
                    P: (data.scores.P.reduce((a, b) => a + b, 0) / data.count).toFixed(1),
                    L: (data.scores.L.reduce((a, b) => a + b, 0) / data.count).toFixed(1)
                };

                // 候选人平均值
                seriesData.push({
                    name: `${position} (实际)`,
                    value: [avgScores.E, avgScores.N, avgScores.P, avgScores.L],
                    areaStyle: { opacity: 0.3 }
                });

                // 理想模型（如果存在）
                const idealProfile = JOB_IDEAL_PROFILES[position];
                if (idealProfile) {
                    seriesData.push({
                        name: `${position} (理想)`,
                        value: [
                            idealProfile.ideal.E,
                            idealProfile.ideal.N,
                            idealProfile.ideal.P,
                            idealProfile.ideal.L
                        ],
                        lineStyle: { type: 'dashed', width: 2 },
                        areaStyle: { opacity: 0.1 }
                    });
                }
            });

            const option = {
                title: {
                    text: '岗位匹配度分析',
                    subtext: '实际值 vs 理想值对比',
                    left: 'center',
                    textStyle: { fontSize: 16, fontWeight: 'bold' }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return `${params.name}<br/>
                                E: ${params.value[0]}<br/>
                                N: ${params.value[1]}<br/>
                                P: ${params.value[2]}<br/>
                                L: ${params.value[3]}`;
                    }
                },
                legend: {
                    data: seriesData.map(item => item.name),
                    top: 6,
                    left: 'center',
                    type: 'scroll',
                    textStyle: { fontSize: 12 }
                },
                radar: {
                    indicator: indicator,
                    center: ['50%', '50%'],
                    radius: positions.length > 2 ? '42%' : '46%',
                    splitNumber: 4,
                    name: { textStyle: { color: '#6b7280', fontSize: 12, fontWeight: 600 } },
                    splitLine: { lineStyle: { color: 'rgba(99,102,241,0.18)' } },
                    splitArea: { areaStyle: { color: ['rgba(99,102,241,0.06)'] } },
                },
                series: [{
                    type: 'radar',
                    data: seriesData,
                    emphasis: {
                        lineStyle: { width: 3 }
                    }
                }]
            };

            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // ==================== 图表 2: 同岗位竞争力排名 ====================
        /**
         * 同岗位竞争力排名
         * 计算每个候选人的综合匹配分，按岗位分组排名
         * 展示竞争力分布：S/A/B/C/D 五个等级
         */
        function renderCompetitionChart() {
            const chartDom = document.getElementById('chartCompetition');
            const chart = echarts.init(chartDom);
            
            // 计算每个候选人的匹配分数
            const candidates = filteredRecords.map(record => {
                const matchScore = calculateMatchScore(record.position, record.scores);
                return {
                    ...record,
                    matchScore: matchScore,
                    rank: null,
                    grade: null
                };
            });

            // 按岗位分组排名
            const positionGroups = {};
            candidates.forEach(candidate => {
                if (!positionGroups[candidate.position]) {
                    positionGroups[candidate.position] = [];
                }
                positionGroups[candidate.position].push(candidate);
            });

            // 计算排名和等级
            Object.keys(positionGroups).forEach(position => {
                const group = positionGroups[position];
                // 按匹配分数降序排序
                group.sort((a, b) => b.matchScore - a.matchScore);
                
                // 分配排名和等级
                group.forEach((candidate, index) => {
                    candidate.rank = index + 1;
                    candidate.percentile = ((index + 1) / group.length * 100).toFixed(0);
                    
                    // 根据百分位分配等级
                    if (candidate.percentile <= 10) candidate.grade = 'S';
                    else if (candidate.percentile <= 30) candidate.grade = 'A';
                    else if (candidate.percentile <= 60) candidate.grade = 'B';
                    else if (candidate.percentile <= 85) candidate.grade = 'C';
                    else candidate.grade = 'D';
                });
            });

            // 统计各等级人数
            const gradeCount = { S: 0, A: 0, B: 0, C: 0, D: 0 };
            candidates.forEach(c => gradeCount[c.grade]++);

            // 按岗位统计平均匹配分
            const positions = Object.keys(positionGroups);
            const avgScores = positions.map(pos => {
                const scores = positionGroups[pos].map(c => c.matchScore);
                return (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
            });

            const option = {
                title: {
                    text: '竞争力等级分布',
                    subtext: 'S:优秀 A:良好 B:中等 C:一般 D:需提升',
                    left: 'center',
                    textStyle: { fontSize: 16, fontWeight: 'bold' },
                    subtextStyle: { fontSize: 12, color: '#666' }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}人 ({d}%)'
                },
                legend: {
                    orient: 'horizontal',
                    bottom: '5%',
                    data: ['S级-优秀', 'A级-良好', 'B级-中等', 'C级-一般', 'D级-需提升']
                },
                series: [
                    {
                        name: '等级分布',
                        type: 'pie',
                        radius: ['35%', '60%'],
                        center: ['50%', '45%'],
                        avoidLabelOverlap: true,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            position: 'outside',
                            formatter: '{b}\n{c}人',
                            fontSize: 13,
                            lineHeight: 18
                        },
                        labelLine: {
                            show: true,
                            length: 15,
                            length2: 10
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 16,
                                fontWeight: 'bold'
                            },
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        },
                        data: [
                            { value: gradeCount.S, name: 'S级-优秀', itemStyle: { color: '#10b981' } },
                            { value: gradeCount.A, name: 'A级-良好', itemStyle: { color: '#3b82f6' } },
                            { value: gradeCount.B, name: 'B级-中等', itemStyle: { color: '#8b5cf6' } },
                            { value: gradeCount.C, name: 'C级-一般', itemStyle: { color: '#f59e0b' } },
                            { value: gradeCount.D, name: 'D级-需提升', itemStyle: { color: '#ef4444' } }
                        ]
                    }
                ]
            };

            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());

            // 存储排名数据供后续使用
            window.competitionData = { candidates, positionGroups };
        }

        /**
         * 计算匹配分数（0-100分）
         * 综合考虑：岗位匹配度(40%) + EPQ平衡度(30%) + 诚实度(20%) + 完成质量(10%)
         */
        function calculateMatchScore(position, scores) {
            const norm = normalizeScores(scores);
            const { E, N, P, L } = norm;
            let totalScore = 0;

            // 1. 岗位匹配度 (40分)
            const profile = JOB_IDEAL_PROFILES[position];
            if (profile) {
                const eMatch = isInRange(E, profile.range.E) ? 10 : Math.max(0, 10 - Math.abs(E - profile.ideal.E) * 0.5);
                const nMatch = isInRange(N, profile.range.N) ? 10 : Math.max(0, 10 - Math.abs(N - profile.ideal.N) * 0.4);
                const pMatch = isInRange(P, profile.range.P) ? 10 : Math.max(0, 10 - Math.abs(P - profile.ideal.P) * 0.5);
                const lMatch = isInRange(L, profile.range.L) ? 10 : Math.max(0, 10 - Math.abs(L - profile.ideal.L) * 0.4);
                totalScore += (eMatch + nMatch + pMatch + lMatch);
            } else {
                totalScore += 20; // 如果没有理想模型，给予基准分
            }

            // 2. EPQ 平衡度 (30分) - 四个维度不要过度极端
            const balance = 30 - (
                (E > 18 || E < 3 ? 5 : 0) +
                (N > 20 || N < 2 ? 5 : 0) +
                (P > 18 || P < 2 ? 5 : 0) +
                (L > 20 || L < 5 ? 5 : 0)
            );
            totalScore += balance;

            // 3. 诚实度 (20分) - L 分数越高越好，但不要太高
            const honestyScore = L >= 10 && L <= 18 ? 20 : (L > 18 ? 15 : Math.min(20, Math.round((L / STANDARD_MAX.L) * 20)));
            totalScore += honestyScore;

            // 4. 完成质量 (10分) - 基准分（未来可扩展：答题时长、一致性等）
            totalScore += 10;

            return Math.round(Math.min(100, Math.max(0, totalScore)));
        }

        // 辅助函数：判断是否在范围内
        function isInRange(value, range) {
            return value >= range[0] && value <= range[1];
        }

        // ==================== 图表 3: 候选人画像与发展建议 ====================
        /**
         * 候选人画像分析
         * 基于 EPQ 四维生成性格画像
         * 分析各类性格特质的人数分布
         */
        function renderProfileChart() {
            const chartDom = document.getElementById('chartProfile');
            const chart = echarts.init(chartDom);
            
            // 性格类型分类
            const profiles = {
                '沉稳型': 0,    // E低 N低 P低 - 沉着冷静，稳重可靠
                '活力型': 0,    // E高 N低 P中 - 外向开朗，积极进取
                '理性型': 0,    // E中 N低 P高 - 理性独立，逻辑严谨
                '敏感型': 0,    // E低 N高 P低 - 细腻敏感，善于观察
                '社交型': 0,    // E高 N中 P中 - 善于交际，灵活变通
                '创意型': 0,    // E中 N中 P高 - 富有创意，思维活跃
                '谨慎型': 0,    // E低 N中 P低 - 细心谨慎，追求完美
                '竞争型': 0     // E高 N低 P高 - 竞争意识强，果敢决断
            };

            filteredRecords.forEach(record => {
                const norm = normalizeScores(record.scores);
                const { E, N, P } = norm;
                const profileType = getPersonalityProfile(E, N, P);
                if (profiles.hasOwnProperty(profileType)) {
                    profiles[profileType]++;
                }
            });

            // 构建图表数据
            const data = Object.entries(profiles)
                .filter(([_, count]) => count > 0)
                .map(([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value);

            // 颜色映射
            const colorMap = {
                '沉稳型': '#3b82f6',
                '活力型': '#f59e0b',
                '理性型': '#8b5cf6',
                '敏感型': '#ec4899',
                '社交型': '#10b981',
                '创意型': '#f97316',
                '谨慎型': '#06b6d4',
                '竞争型': '#ef4444'
            };

            const option = {
                title: {
                    text: '性格特质分布',
                    subtext: '基于 EPQ 四维的性格分类',
                    left: 'center',
                    textStyle: { fontSize: 16, fontWeight: 'bold' },
                    subtextStyle: { fontSize: 12, color: '#666' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const param = params[0];
                        const percentage = (param.value / filteredRecords.length * 100).toFixed(1);
                        return `${param.name}<br/>人数: ${param.value}<br/>占比: ${percentage}%`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '8%',
                    top: '18%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.name),
                    axisLabel: {
                        interval: 0,
                        rotate: data.length > 6 ? 30 : 0,
                        fontSize: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '人数',
                    minInterval: 1
                },
                series: [{
                    type: 'bar',
                    data: data.map(item => ({
                        value: item.value,
                        itemStyle: { 
                            color: colorMap[item.name] || '#4f46e5',
                            borderRadius: [8, 8, 0, 0]
                        }
                    })),
                    label: {
                        show: true,
                        position: 'top',
                        fontSize: 12,
                        fontWeight: 'bold'
                    },
                    barWidth: '50%',
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };

            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        /**
         * 根据 EPQ 分数判断性格类型
         */
        function getPersonalityProfile(E, N, P) {
            const eLow = E < 10;
            const eMid = E >= 10 && E <= 15;
            const eHigh = E > 15;
            
            const nLow = N < 10;
            const nMid = N >= 10 && N <= 16;
            const nHigh = N > 16;
            
            const pLow = P < 8;
            const pMid = P >= 8 && P <= 14;
            const pHigh = P > 14;

            // 性格类型判断逻辑
            if (eLow && nLow && pLow) return '沉稳型';
            if (eHigh && nLow && pMid) return '活力型';
            if (eMid && nLow && pHigh) return '理性型';
            if (eLow && nHigh && pLow) return '敏感型';
            if (eHigh && nMid && pMid) return '社交型';
            if (eMid && nMid && pHigh) return '创意型';
            if (eLow && nMid && pLow) return '谨慎型';
            if (eHigh && nLow && pHigh) return '竞争型';
            
            // 默认根据主导维度
            if (eHigh) return '社交型';
            if (pHigh) return '创意型';
            if (nLow) return '沉稳型';
            return '谨慎型';
        }

        /**
         * 生成候选人详细画像（用于详情页）
         */
        function generateCandidateProfile(record) {
            const { E, N, P, L } = record.scores;
            const profileType = getPersonalityProfile(E, N, P);
            const matchScore = calculateMatchScore(record.position, record.scores);
            const jobProfile = JOB_IDEAL_PROFILES[record.position];

            const result = {
                type: profileType,
                matchScore: matchScore,
                strengths: [],
                risks: [],
                suggestions: [],
                fitAnalysis: ''
            };

            // 基于性格类型的优势和风险
            const typeTraits = {
                '沉稳型': {
                    strengths: ['情绪稳定', '可靠负责', '抗压能力强', '专注力好'],
                    risks: ['可能不够主动', '创新性偏弱', '团队协作待加强']
                },
                '活力型': {
                    strengths: ['充满活力', '善于交际', '积极进取', '团队凝聚力强'],
                    risks: ['可能缺乏耐心', '细节关注不足', '需提升专注力']
                },
                '理性型': {
                    strengths: ['逻辑思维强', '独立性高', '善于分析', '创新能力好'],
                    risks: ['可能过于理性', '人际关系需关注', '团队协作待加强']
                },
                '敏感型': {
                    strengths: ['细腻敏感', '善于观察', '同理心强', '细节把控好'],
                    risks: ['情绪波动较大', '抗压能力待提升', '需要更多支持']
                },
                '社交型': {
                    strengths: ['沟通能力强', '灵活变通', '善于协调', '人际关系好'],
                    risks: ['可能缺乏深度', '原则性需加强', '注意力易分散']
                },
                '创意型': {
                    strengths: ['富有创意', '思维活跃', '勇于尝试', '视角独特'],
                    risks: ['可能不够务实', '执行力需提升', '需平衡创意与现实']
                },
                '谨慎型': {
                    strengths: ['细心谨慎', '追求完美', '责任心强', '质量意识高'],
                    risks: ['可能过于保守', '决策速度慢', '需提升灵活性']
                },
                '竞争型': {
                    strengths: ['竞争意识强', '果敢决断', '目标导向', '执行力强'],
                    risks: ['可能过于激进', '需关注团队合作', '同理心待加强']
                }
            };

            if (typeTraits[profileType]) {
                result.strengths = typeTraits[profileType].strengths;
                result.risks = typeTraits[profileType].risks;
            }

            // 生成面试建议
            if (matchScore >= 80) {
                result.suggestions.push('匹配度优秀，建议优先面试');
                result.suggestions.push('重点考察：项目经验、技术深度');
            } else if (matchScore >= 60) {
                result.suggestions.push('匹配度良好，可以安排面试');
                result.suggestions.push('重点考察：学习能力、发展潜力');
            } else {
                result.suggestions.push('匹配度一般，建议谨慎评估');
                result.suggestions.push('重点考察：' + result.risks.join('、'));
            }

            // 岗位适配分析
            if (jobProfile) {
                result.fitAnalysis = jobProfile.description;
                result.suggestions.push(`${record.position}期望特质：${jobProfile.traits.join('、')}`);
            }

            return result;
        }

        // ==================== 岗位匹配度评估 ====================
        function evaluateFit(position, scores) {
            const norm = normalizeScores(scores);
            const { E, N, P, L } = norm;
            
            // 优先使用自定义规则，否则使用默认规则
            let profile;
            if (adminConfig.matchRules[position]) {
                profile = adminConfig.matchRules[position];
            } else {
                // 默认岗位理想特征配置
                const profiles = {
                    'Java开发工程师': { E: [8, 15], N: [0, 10], P: [0, 10], L: [10, 22] },
                    '前端开发工程师': { E: [10, 18], N: [0, 10], P: [0, 8], L: [10, 22] },
                    '产品经理': { E: [14, 21], N: [0, 12], P: [5, 12], L: [8, 22] },
                    'UI设计师': { E: [8, 16], N: [0, 12], P: [8, 15], L: [10, 22] },
                    '销售经理': { E: [16, 21], N: [0, 8], P: [6, 14], L: [12, 22] },
                    '市场运营': { E: [14, 21], N: [0, 10], P: [6, 13], L: [10, 22] },
                    '人力资源': { E: [12, 20], N: [0, 8], P: [0, 8], L: [14, 22] },
                    '财务专员': { E: [6, 14], N: [0, 8], P: [0, 6], L: [16, 22] },
                    '行政专员': { E: [10, 18], N: [0, 10], P: [0, 8], L: [12, 22] }
                };
                profile = profiles[position] || { E: [8, 16], N: [0, 12], P: [0, 12], L: [8, 22] };
            }
            
            let matchScore = 0;
            const weights = { E: 1, N: 1.2, P: 1, L: 1.3 }; // N和L权重更高
            let totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);

            // E 维度
            if (E >= profile.E[0] && E <= profile.E[1]) matchScore += weights.E;
            else if (Math.abs(E - (profile.E[0] + profile.E[1]) / 2) <= 3) matchScore += weights.E * 0.5;

            // N 维度（越低越好）
            if (N >= profile.N[0] && N <= profile.N[1]) matchScore += weights.N;
            else if (N <= profile.N[1] + 3) matchScore += weights.N * 0.5;

            // P 维度
            if (P >= profile.P[0] && P <= profile.P[1]) matchScore += weights.P;
            else if (Math.abs(P - (profile.P[0] + profile.P[1]) / 2) <= 3) matchScore += weights.P * 0.5;

            // L 维度（越高越好）
            if (L >= profile.L[0] && L <= profile.L[1]) matchScore += weights.L;
            else if (L >= profile.L[0] - 2) matchScore += weights.L * 0.5;

            const percentage = matchScore / totalWeight;

            // 生成详细描述
            let description = '';
            const eDesc = E >= 14 ? '外向性高' : E <= 8 ? '外向性低' : '外向性适中';
            const nDesc = N >= 15 ? '情绪敏感度较高' : N <= 8 ? '情绪稳定' : '情绪稳定性一般';
            const pDesc = P >= 14 ? '独立性强' : P <= 7 ? '团队协作性好' : '独立性适中';
            const lDesc = L >= 15 ? '诚信度高' : L <= 8 ? '诚信度偏低' : '诚信度一般';

            if (percentage >= 0.75) {
                description = `${eDesc}，${nDesc}，${pDesc}，${lDesc}。整体人格特征与${position}的岗位要求高度匹配，建议优先考虑。`;
                return { level: '高匹配', badgeClass: 'success', color: '#10b981', description };
            } else if (percentage >= 0.5) {
                description = `${eDesc}，${nDesc}，${pDesc}，${lDesc}。人格特征基本符合${position}的要求，可以考虑进入下一轮面试。`;
                return { level: '一般', badgeClass: 'warning', color: '#f59e0b', description };
            } else {
                description = `${eDesc}，${nDesc}，${pDesc}，${lDesc}。部分人格特征与${position}岗位要求有偏差，建议谨慎考虑或安排进一步评估。`;
                return { level: '需谨慎', badgeClass: 'danger', color: '#ef4444', description };
            }
        }

        // ==================== 工具函数 ====================
        function maskPhone(phone) {
            if (!phone || phone.length < 11) return phone;
            return phone.substring(0, 3) + '****' + phone.substring(7);
        }

        function exportCSV() {
            if (filteredRecords.length === 0) {
                alert('当前没有数据可导出');
                return;
            }

            const headers = ['提交时间', '姓名', '手机号', '应聘岗位', 'E分数', 'N分数', 'P分数', 'L分数', '岗位匹配度', '备注'];
            const rows = filteredRecords.map(record => {
                const fit = evaluateFit(record.position, record.scores);
                return [
                    record.createTime || '',
                    record.name || '',
                    record.phone || '',
                    record.position || '',
                    record.scores ? record.scores.E : '',
                    record.scores ? record.scores.N : '',
                    record.scores ? record.scores.P : '',
                    record.scores ? record.scores.L : '',
                    fit.level || '',
                    record.remark || ''
                ];
            });

            // 构建 CSV 内容
            let csvContent = '\uFEFF'; // UTF-8 BOM
            csvContent += headers.join(',') + '\n';
            
            rows.forEach(row => {
                const csvRow = row.map(cell => {
                    // 确保 cell 不是 undefined 或 null
                    const cellStr = cell !== null && cell !== undefined ? String(cell) : '';
                    // 如果包含逗号、引号或换行，需要用引号包裹并转义
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                });
                csvContent += csvRow.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const fileName = `epq_results_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert(`✓ 成功导出 ${filteredRecords.length} 条记录！`);
        }

        // ==================== Tab 切换 ====================
        function switchTab(index) {
            const tabs = document.querySelectorAll('.assessment-tab');
            const contents = document.querySelectorAll('.assessment-tab-content');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    contents[i].classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>
