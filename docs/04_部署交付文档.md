# QZ·TalentLens 部署交付文档

> **版本**: v1.0  
> **更新日期**: 2025年12月8日  
> **适用环境**: Linux (Ubuntu/CentOS) / macOS / Windows Server

---

## 一、部署概述

### 1.1 系统要求

| 组件 | 最低要求 | 推荐配置 |
|------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 硬盘 | 20GB | 50GB+ SSD |
| 操作系统 | Ubuntu 20.04+ / CentOS 7+ | Ubuntu 22.04 LTS |

### 1.2 软件依赖

| 软件 | 版本要求 | 用途 |
|------|----------|------|
| Python | 3.11+ | 后端运行时 |
| Node.js | 18+ | 前端构建 |
| Nginx | 1.18+ | 反向代理 |
| SQLite | 3.x | 数据库（开发） |
| PostgreSQL | 14+ | 数据库（生产，可选） |

### 1.3 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                        生产部署架构                          │
└─────────────────────────────────────────────────────────────┘

                    ┌─────────────┐
                    │   用户访问   │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │    Nginx    │
                    │  (反向代理)  │
                    └──────┬──────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
              ▼            ▼            ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │ 静态资源  │ │ API 请求 │ │ WebSocket│
        │ /assets  │ │  /api/*  │ │   /ws    │
        └────┬─────┘ └────┬─────┘ └────┬─────┘
             │            │            │
             ▼            │            │
        ┌──────────┐      │            │
        │ 前端静态  │      │            │
        │  dist/   │      │            │
        └──────────┘      │            │
                          ▼            ▼
                    ┌─────────────────────┐
                    │   FastAPI 后端      │
                    │   (Uvicorn/Gunicorn)│
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │     数据库          │
                    │ SQLite/PostgreSQL   │
                    └─────────────────────┘
```

---

## 二、数据库部署策略 ⭐

### 2.1 数据库选型

本系统支持两种数据库方案，请根据实际场景选择：

| 方案 | 适用场景 | 优点 | 缺点 |
|------|----------|------|------|
| **SQLite**（默认） | • 每日面试 < 10人<br>• 单服务器部署<br>• 快速上线 | • 零配置，开箱即用<br>• 无需独立数据库服务器<br>• 备份简单（复制文件） | • 不支持多服务器<br>• 并发性能有限 |
| **PostgreSQL** | • 每日面试 > 20人<br>• 多服务器负载均衡<br>• 高可用要求 | • 高并发性能<br>• 支持分布式<br>• 企业级特性 | • 需要独立部署<br>• 需要 DBA 维护 |

---

### 2.2 方案A: SQLite 部署（推荐小规模使用）

#### 2.2.1 特点
- ✅ **无需提供数据库账号密码**
- ✅ **无需单独部署数据库服务器**
- ✅ **数据库文件自动创建**
- ✅ **适合单机部署**

#### 2.2.2 数据库位置
```bash
# 默认位置（与后端代码同目录）
/opt/talentlens/backend/hr.db
```

#### 2.2.3 数据库备份
```bash
# 手动备份
cp /opt/talentlens/backend/hr.db /backup/hr.db.$(date +%Y%m%d)

# 定时备份（每天凌晨2点）
echo "0 2 * * * cp /opt/talentlens/backend/hr.db /backup/hr.db.\$(date +\%Y\%m\%d)" | crontab -

# 清理旧备份（保留30天）
find /backup -name "hr.db.*" -mtime +30 -delete
```

#### 2.2.4 数据库恢复
```bash
# 1. 停止后端服务
systemctl stop talentlens-backend

# 2. 恢复备份文件
cp /backup/hr.db.20251212 /opt/talentlens/backend/hr.db

# 3. 重启服务
systemctl start talentlens-backend
```

#### 2.2.5 注意事项
- 确保数据库文件所在目录有写权限
- 定期备份到异地存储（避免硬盘故障）
- 数据量建议控制在 10GB 以内

---

### 2.3 方案B: PostgreSQL 部署（企业级部署）

#### 2.3.1 前置条件

**需要企业 IT/DBA 提供以下信息**：
```
- [ ] PostgreSQL 服务器地址：_________________
- [ ] 端口号（默认5432）：___________________
- [ ] 数据库名称：__________________________
- [ ] 专用用户名：__________________________
- [ ] 用户密码：____________________________
```

#### 2.3.2 数据库创建（由企业 DBA 执行）

```sql
-- 1. 创建数据库
CREATE DATABASE talentlens_prod
    ENCODING 'UTF8'
    LC_COLLATE 'zh_CN.UTF-8'
    LC_CTYPE 'zh_CN.UTF-8'
    TEMPLATE template0;

-- 2. 创建专用用户（使用强密码）
CREATE USER talentlens_user WITH PASSWORD '你的强密码';

-- 3. 授予权限
GRANT ALL PRIVILEGES ON DATABASE talentlens_prod TO talentlens_user;

-- 4. 连接到新数据库并授予 schema 权限
\c talentlens_prod
GRANT ALL ON SCHEMA public TO talentlens_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO talentlens_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO talentlens_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO talentlens_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO talentlens_user;
```

#### 2.3.3 配置数据库连接

编辑后端 `.env` 文件：
```bash
cd /opt/talentlens/backend
nano .env
```

添加数据库连接字符串：
```bash
# PostgreSQL 配置（替换为实际值）
DATABASE_URL=postgresql://talentlens_user:你的密码@db.company.com:5432/talentlens_prod

# 可选：启用 SQL 调试日志
# SQL_ECHO=false
```

#### 2.3.4 初始化数据库表结构

```bash
cd /opt/talentlens/backend
source venv/bin/activate

# 运行数据库迁移
alembic upgrade head

# 验证表结构
python -c "
from app.db import get_engine
from sqlmodel import inspect
engine = get_engine()
inspector = inspect(engine)
print('已创建的表：', inspector.get_table_names())
"
```

#### 2.3.5 PostgreSQL 备份策略

```bash
# 1. 逻辑备份（推荐每日执行）
pg_dump -h db.company.com -U talentlens_user -d talentlens_prod \
    -F c -f /backup/talentlens_$(date +%Y%m%d).dump

# 2. 恢复备份
pg_restore -h db.company.com -U talentlens_user -d talentlens_prod \
    -c /backup/talentlens_20251212.dump

# 3. 定时备份（加入 crontab）
0 2 * * * pg_dump -h db.company.com -U talentlens_user -d talentlens_prod -F c -f /backup/talentlens_\$(date +\%Y\%m\%d).dump
```

#### 2.3.6 安全建议
- ✅ 使用强密码（至少 16 位，包含大小写字母、数字、特号）
- ✅ 启用 SSL 连接（生产环境必须）
- ✅ 限制数据库用户权限（仅访问本应用数据库）
- ✅ 定期备份到异地存储
- ❌ 不要在代码中硬编码密码
- ❌ 不要将 `.env` 文件提交到 Git

---

### 2.4 数据库切换（SQLite → PostgreSQL）

如果初期使用 SQLite，后期需要切换到 PostgreSQL：

```bash
# 1. 导出 SQLite 数据
sqlite3 hr.db .dump > data_export.sql

# 2. 转换格式（SQLite → PostgreSQL）
# 需要手动调整 SQL 语法差异（如自增字段、日期类型等）

# 3. 导入 PostgreSQL
psql -h db.company.com -U talentlens_user -d talentlens_prod -f data_export_converted.sql

# 4. 修改 .env 配置
DATABASE_URL=postgresql://talentlens_user:密码@db.company.com:5432/talentlens_prod

# 5. 重启后端服务
systemctl restart talentlens-backend
```

---

## 三、环境准备

### 3.1 安装 Python 3.11+

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install python3.11 python3.11-venv python3.11-dev python3-pip
```

**CentOS/RHEL:**
```bash
sudo yum install python3.11 python3.11-devel
```

**macOS:**
```bash
brew install python@3.11
```

### 2.2 安装 Node.js 18+

**使用 nvm (推荐):**
```bash
# 安装 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 安装 Node.js
nvm install 18
nvm use 18
```

**Ubuntu/Debian:**
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs
```

### 2.3 安装 Nginx

**Ubuntu/Debian:**
```bash
sudo apt install nginx
```

**CentOS/RHEL:**
```bash
sudo yum install nginx
```

---

## 三、项目部署

### 3.1 获取代码

```bash
# 克隆项目（或上传代码包）
cd /opt
git clone <repository_url> HR人事
# 或解压上传的代码包
# unzip HR人事.zip -d /opt/

cd /opt/HR人事
```

### 3.2 后端部署

#### 3.2.1 创建虚拟环境

```bash
cd /opt/HR人事/backend
python3.11 -m venv venv
source venv/bin/activate
```

#### 3.2.2 安装依赖

```bash
pip install --upgrade pip
pip install -r requirements.txt

# 或使用 pyproject.toml
pip install -e .
```

#### 3.2.3 配置环境变量

创建 `.env` 文件：

```bash
cat > .env << 'EOF'
# 数据库配置
DATABASE_URL=sqlite:///./hr.db

# JWT 配置
JWT_SECRET_KEY=your-super-secret-key-change-in-production
JWT_ALGORITHM=HS256

# AI 配置
MODELSCOPE_API_KEY=your_modelscope_api_key
MODELSCOPE_API_KEY_EXPIRES=2026-01-06
MODELSCOPE_API_BASE=https://api-inference.modelscope.cn/v1/chat/completions

# 硅基流动备用 (可选)
SILICONFLOW_API_KEY=your_siliconflow_api_key

# 默认管理员
DEFAULT_ADMIN_USERNAME=admin
DEFAULT_ADMIN_PASSWORD=admin123
EOF
```

#### 3.2.4 初始化数据库

```bash
# 数据库会在首次启动时自动创建
# 如需手动初始化：
python -c "from app.db import init_db; init_db()"
```

#### 3.2.5 启动后端服务

**开发模式:**
```bash
uvicorn app.main:app --host 0.0.0.0 --port 9000 --reload
```

**生产模式 (使用 Gunicorn):**
```bash
pip install gunicorn

gunicorn app.main:app \
    --workers 4 \
    --worker-class uvicorn.workers.UvicornWorker \
    --bind 0.0.0.0:9000 \
    --access-logfile /var/log/talentlens/access.log \
    --error-logfile /var/log/talentlens/error.log \
    --daemon
```

### 3.3 前端部署

#### 3.3.1 安装依赖

```bash
cd /opt/HR人事/frontend
npm install
```

#### 3.3.2 配置环境变量

创建 `.env.production` 文件：

```bash
cat > .env.production << 'EOF'
VITE_API_BASE=https://your-domain.com
EOF
```

#### 3.3.3 构建生产版本

```bash
npm run build
```

构建产物位于 `dist/` 目录。

### 3.4 Nginx 配置

创建 Nginx 配置文件：

```bash
sudo cat > /etc/nginx/sites-available/talentlens << 'EOF'
server {
    listen 80;
    server_name your-domain.com;
    
    # 重定向到 HTTPS (生产环境)
    # return 301 https://$server_name$request_uri;
    
    # 前端静态文件
    root /opt/HR人事/frontend/dist;
    index index.html;
    
    # 前端路由 (SPA)
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API 代理
    location /api {
        proxy_pass http://127.0.0.1:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }
    
    # Auth API 代理
    location /auth {
        proxy_pass http://127.0.0.1:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;
}
EOF

# 启用站点
sudo ln -s /etc/nginx/sites-available/talentlens /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 3.5 HTTPS 配置 (生产环境)

使用 Let's Encrypt 免费证书：

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

---

## 四、服务管理

### 4.1 创建 Systemd 服务

```bash
sudo cat > /etc/systemd/system/talentlens.service << 'EOF'
[Unit]
Description=QZ TalentLens Backend Service
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/HR人事/backend
Environment="PATH=/opt/HR人事/backend/venv/bin"
ExecStart=/opt/HR人事/backend/venv/bin/gunicorn app.main:app \
    --workers 4 \
    --worker-class uvicorn.workers.UvicornWorker \
    --bind 127.0.0.1:9000
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# 启用并启动服务
sudo systemctl daemon-reload
sudo systemctl enable talentlens
sudo systemctl start talentlens
```

### 4.2 服务管理命令

```bash
# 启动服务
sudo systemctl start talentlens

# 停止服务
sudo systemctl stop talentlens

# 重启服务
sudo systemctl restart talentlens

# 查看状态
sudo systemctl status talentlens

# 查看日志
sudo journalctl -u talentlens -f
```

---

## 五、数据库配置

### 5.1 SQLite (默认)

SQLite 是默认数据库，无需额外配置，数据库文件位于：
```
/opt/HR人事/backend/hr.db
```

### 5.2 PostgreSQL (生产推荐)

#### 5.2.1 安装 PostgreSQL

```bash
sudo apt install postgresql postgresql-contrib
```

#### 5.2.2 创建数据库

```bash
sudo -u postgres psql

CREATE USER talentlens WITH PASSWORD 'your_password';
CREATE DATABASE talentlens_db OWNER talentlens;
GRANT ALL PRIVILEGES ON DATABASE talentlens_db TO talentlens;
\q
```

#### 5.2.3 更新配置

修改 `.env` 文件：
```
DATABASE_URL=postgresql://talentlens:your_password@localhost:5432/talentlens_db
```

安装 PostgreSQL 驱动：
```bash
pip install psycopg2-binary
```

---

## 六、备份与恢复

### 6.1 数据库备份

**SQLite:**
```bash
# 备份
cp /opt/HR人事/backend/hr.db /backup/hr_$(date +%Y%m%d).db

# 恢复
cp /backup/hr_20251208.db /opt/HR人事/backend/hr.db
```

**PostgreSQL:**
```bash
# 备份
pg_dump -U talentlens talentlens_db > /backup/talentlens_$(date +%Y%m%d).sql

# 恢复
psql -U talentlens talentlens_db < /backup/talentlens_20251208.sql
```

### 6.2 自动备份脚本

```bash
cat > /opt/backup_talentlens.sh << 'EOF'
#!/bin/bash
BACKUP_DIR=/backup/talentlens
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份数据库
cp /opt/HR人事/backend/hr.db $BACKUP_DIR/hr_$DATE.db

# 备份配置
cp /opt/HR人事/backend/.env $BACKUP_DIR/env_$DATE

# 保留最近 7 天的备份
find $BACKUP_DIR -name "*.db" -mtime +7 -delete
find $BACKUP_DIR -name "env_*" -mtime +7 -delete

echo "Backup completed: $DATE"
EOF

chmod +x /opt/backup_talentlens.sh

# 添加定时任务 (每天凌晨 2 点)
echo "0 2 * * * /opt/backup_talentlens.sh" | crontab -
```

---

## 七、监控与日志

### 7.1 日志位置

| 日志 | 位置 |
|------|------|
| 后端日志 | `/var/log/talentlens/` |
| Nginx 访问日志 | `/var/log/nginx/access.log` |
| Nginx 错误日志 | `/var/log/nginx/error.log` |
| Systemd 日志 | `journalctl -u talentlens` |

### 7.2 日志轮转

```bash
sudo cat > /etc/logrotate.d/talentlens << 'EOF'
/var/log/talentlens/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload talentlens > /dev/null 2>&1 || true
    endscript
}
EOF
```

### 7.3 健康检查

```bash
# API 健康检查
curl http://localhost:9000/health

# 预期响应
# {"status": "healthy", "database": "connected", "ai": "available"}
```

---

## 八、安全配置

### 8.1 防火墙配置

```bash
# UFW (Ubuntu)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# firewalld (CentOS)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 8.2 安全建议

1. **修改默认密码**: 首次登录后立即修改 admin 密码
2. **使用 HTTPS**: 生产环境必须启用 HTTPS
3. **限制 API 访问**: 配置 IP 白名单或 API 网关
4. **定期更新**: 保持系统和依赖包更新
5. **备份加密**: 对备份数据进行加密存储

---

## 九、故障排查

### 9.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 502 Bad Gateway | 后端未启动 | 检查后端服务状态 |
| 静态资源 404 | Nginx 配置错误 | 检查 root 路径 |
| API 超时 | AI 服务慢 | 检查 AI Token 状态 |
| 数据库错误 | 权限/连接问题 | 检查数据库配置 |

### 9.2 诊断命令

```bash
# 检查服务状态
sudo systemctl status talentlens
sudo systemctl status nginx

# 检查端口
sudo netstat -tlnp | grep -E '80|443|9000'

# 检查日志
sudo tail -f /var/log/nginx/error.log
sudo journalctl -u talentlens -f

# 测试后端连接
curl http://127.0.0.1:9000/health
```

---

## 十、交付清单

### 10.1 交付物

| 项目 | 说明 |
|------|------|
| 源代码 | 完整的前后端代码 |
| 数据库 | SQLite 数据库文件 |
| 配置文件 | .env 配置模板 |
| 文档 | 完整的技术文档 |

### 10.2 验收测试

1. **登录测试**: 使用默认账号登录
2. **测评测试**: 创建并完成一次测评
3. **画像测试**: 查看候选人画像
4. **AI 测试**: 验证 AI 分析功能
5. **导出测试**: 导出数据为 Excel

### 10.3 交付后支持

- 提供 30 天免费技术支持
- 提供系统使用培训
- 提供紧急问题响应

---

## 附录

### A. 端口清单

| 端口 | 服务 | 说明 |
|------|------|------|
| 80 | Nginx | HTTP |
| 443 | Nginx | HTTPS |
| 9000 | FastAPI | 后端 API |
| 5432 | PostgreSQL | 数据库（可选） |

### B. 目录结构

```
/opt/HR人事/
├── backend/
│   ├── app/
│   ├── venv/
│   ├── .env
│   ├── hr.db
│   └── requirements.txt
├── frontend/
│   ├── src/
│   ├── dist/
│   └── package.json
└── docs/
```

### C. 相关文档

- [依赖安装文档](./08_依赖安装文档.md)
- [后续维护文档](./05_后续维护文档.md)
- [API 接口文档](./06_API接口文档.md)

