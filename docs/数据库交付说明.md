# 数据库交付说明

> **给开发者的清晰指引**：给部署人员什么？不给什么？

---

## 🎯 快速答案

### ✅ 需要给部署人员的

| 交付物 | 说明 | 位置 |
|--------|------|------|
| **数据库选型指南** | 帮助部署人员选择 SQLite 或 PostgreSQL | `docs/04_部署交付文档.md` 第2章 |
| **SQLite 使用说明** | 数据库文件位置、备份恢复方法 | `docs/04_部署交付文档.md` 第2.2节 |
| **PostgreSQL 配置模板** | 数据库创建 SQL、权限配置 | `docs/04_部署交付文档.md` 第2.3节 |
| **备份脚本** | 自动化备份工具 | `backend/scripts/backup-sqlite.sh` |
| **恢复脚本** | 数据恢复工具 | `backend/scripts/restore-sqlite.sh` |
| **数据库迁移脚本** | Alembic 版本控制 | `backend/alembic/versions/*.py` |
| **使用文档** | 脚本使用说明 | `backend/scripts/README_DATABASE.md` |

### ❌ **不需要**给部署人员的

| 不给的内容 | 原因 |
|------------|------|
| ❌ 数据库密码 | PostgreSQL 由企业 DBA 自行设置密码 |
| ❌ `.env` 文件 | 包含敏感信息，只给 `.env.example` 模板 |
| ❌ 开发数据库文件 | 生产环境需要全新初始化 |
| ❌ 测试数据 | 避免泄露隐私信息 |

---

## 📦 详细交付清单

### 方案A: SQLite 部署（你的情况，推荐）

#### 给什么？
```
✅ docs/04_部署交付文档.md（包含 SQLite 使用说明）
✅ backend/scripts/backup-sqlite.sh（备份脚本）
✅ backend/scripts/restore-sqlite.sh（恢复脚本）
✅ backend/scripts/README_DATABASE.md（使用说明）
✅ backend/alembic/（数据库迁移脚本）
✅ backend/.env.example（环境变量模板）
```

#### 部署人员需要做什么？
```bash
# 1. 启动后端服务（数据库自动创建）
cd /opt/talentlens/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 9000

# 2. 数据库文件自动生成
# 位置: /opt/talentlens/backend/hr.db

# 3. 设置定时备份（可选）
crontab -e
# 添加：0 2 * * * /opt/talentlens/backend/scripts/backup-sqlite.sh
```

#### 不需要做什么？
```
❌ 不需要安装 PostgreSQL
❌ 不需要创建数据库用户
❌ 不需要配置数据库密码
❌ 不需要手动执行 SQL 脚本
```

---

### 方案B: PostgreSQL 部署（未来扩展）

#### 给什么？
```
✅ docs/04_部署交付文档.md（包含 PostgreSQL 配置说明）
✅ 数据库创建 SQL（在文档中）
✅ 用户权限配置 SQL（在文档中）
✅ backend/alembic/（数据库迁移脚本）
✅ backend/.env.example（环境变量模板）
✅ PostgreSQL 备份恢复说明（在文档中）
```

#### 企业需要准备什么？
```
由企业 IT/DBA 提供：
1. PostgreSQL 服务器地址
2. 端口号（默认 5432）
3. 数据库名称
4. 专用用户名
5. 用户密码（强密码）
```

#### 部署人员需要做什么？
```bash
# 1. 企业 DBA 创建数据库和用户（执行文档中的 SQL）
# 2. 配置环境变量
cd /opt/talentlens/backend
cp .env.example .env
nano .env  # 填入企业提供的数据库连接信息

# 3. 运行数据库迁移
source venv/bin/activate
alembic upgrade head

# 4. 启动服务
uvicorn app.main:app --host 0.0.0.0 --port 9000
```

---

## 📋 .env.example 模板内容

创建 `backend/.env.example` 文件（交付给部署人员）：

```bash
# ============================================
# QZ·TalentLens 环境变量配置模板
# ============================================

# ---------- 数据库配置 ----------
# 方案A: SQLite（默认，适合小规模部署）
DATABASE_URL=sqlite:///./hr.db

# 方案B: PostgreSQL（企业级部署）
# DATABASE_URL=postgresql://用户名:密码@主机:5432/数据库名
# 示例: DATABASE_URL=postgresql://talentlens_user:StrongPassword123@db.company.com:5432/talentlens_prod

# 是否输出 SQL 日志（调试用）
SQL_ECHO=false

# ---------- AI 服务配置 ----------
# ModelScope API Key（魔塔空间）
MODELSCOPE_API_KEY=your_api_key_here
MODELSCOPE_API_KEY_EXPIRES=2025-12-31

# AI 备用模型（硅基流动免费模型）
AI_FALLBACK_MODELS_SIMPLE=THUDM/glm-4-9b-chat,THUDM/GLM-Z1-9B-0414

# ---------- JWT 认证配置 ----------
# JWT 密钥（生产环境必须修改！）
JWT_SECRET_KEY=your-super-secret-jwt-key-change-in-production
JWT_ALGORITHM=HS256
JWT_EXPIRATION_MINUTES=10080

# ---------- 应用配置 ----------
# 日志级别
LOG_LEVEL=INFO

# CORS 允许的来源（多个用逗号分隔）
CORS_ORIGINS=http://localhost:5173,https://your-domain.com

# ---------- 文件上传配置 ----------
# 最大上传文件大小（MB）
MAX_UPLOAD_SIZE_MB=10

# 上传文件存储路径
UPLOAD_DIR=./uploads

# ============================================
# 配置说明：
# 1. 复制此文件为 .env
# 2. 根据实际情况修改配置项
# 3. 不要将 .env 文件提交到 Git
# ============================================
```

---

## 🔐 安全建议

### 1. 敏感信息处理
```bash
# ✅ 正确做法
给部署人员：.env.example（模板）
部署人员自行创建：.env（包含实际密码）

# ❌ 错误做法
给部署人员：.env（包含密码）
```

### 2. 数据库密码策略
```
PostgreSQL 密码要求：
- 至少 16 位
- 包含大小写字母、数字、特殊字符
- 不使用常见密码
- 定期更换（建议90天）
```

### 3. 文件权限设置
```bash
# 数据库文件
chmod 600 /opt/talentlens/backend/hr.db

# 环境变量文件
chmod 600 /opt/talentlens/backend/.env

# 备份文件
chmod 600 /backup/talentlens/hr.db.*
```

---

## ✅ 交付检查清单

部署前请确认：

```
文档类：
[ ] 已更新 docs/04_部署交付文档.md（包含数据库章节）
[ ] 已创建 backend/.env.example（环境变量模板）
[ ] 已创建 backend/scripts/README_DATABASE.md（脚本使用说明）

脚本类：
[ ] 已创建 backend/scripts/backup-sqlite.sh（备份脚本）
[ ] 已创建 backend/scripts/restore-sqlite.sh（恢复脚本）
[ ] 已测试脚本可执行（chmod +x）

代码类：
[ ] 已提交所有数据库迁移脚本（alembic/versions/）
[ ] 已确认 DATABASE_URL 默认为 SQLite
[ ] 已确认没有硬编码的数据库密码

测试类：
[ ] 已测试 SQLite 自动创建
[ ] 已测试数据库备份恢复
[ ] 已测试 alembic 迁移

安全类：
[ ] 已从 Git 移除 .env 文件
[ ] 已在 .gitignore 中排除 .env
[ ] 已在 .gitignore 中排除 hr.db
[ ] 已清理测试数据中的隐私信息
```

---

## 📞 FAQ

### Q1: 部署人员需要懂数据库吗？
**A1**: 
- **SQLite**：不需要，自动创建，零配置
- **PostgreSQL**：需要基本的数据库知识，或由企业 DBA 协助

### Q2: 数据库密码谁来设置？
**A2**: 
- **SQLite**：无需密码
- **PostgreSQL**：由企业 DBA 设置，部署人员获取后填入 `.env`

### Q3: 需要给部署人员数据库管理工具吗？
**A3**: 
- **SQLite**：可选，推荐 DB Browser for SQLite
- **PostgreSQL**：可选，推荐 pgAdmin 或 DBeaver

### Q4: 开发数据库能直接用于生产吗？
**A4**: 
- ❌ **不能！** 开发数据库包含测试数据，可能有隐私问题
- ✅ 生产环境应该全新初始化（通过 alembic upgrade head）

### Q5: 如何确保数据安全？
**A5**: 
```
1. 定时备份（每天自动）
2. 异地存储备份文件
3. 定期测试恢复流程
4. 限制数据库文件访问权限
5. 加密备份文件（如果包含敏感信息）
```

---

## 📚 相关文档

- [部署交付文档](./04_部署交付文档.md) - 完整部署流程
- [后续维护文档](./05_后续维护文档.md) - 运维指南
- [数据库访问指南](./数据库访问指南.md) - 数据库查询示例
- [项目交付指南](./项目交付指南.md) - 交付清单

---

**总结**：根据你的情况（每天面试不超过5人），推荐使用 **SQLite**，**无需提供数据库账号密码**，部署人员只需启动服务即可自动创建数据库。🎉

