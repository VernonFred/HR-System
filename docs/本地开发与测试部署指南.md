# QZ·TalentLens 本地开发与测试部署指南

> **版本**: v2.0  
> **更新日期**: 2025年12月12日  
> **适用场景**: 本地开发、内网测试、外网临时测试

---

## 📋 目录

1. [本地开发环境启动](#一本地开发环境启动)
2. [内网测试部署](#二内网测试部署)
3. [Ngrok外网访问](#三ngrok外网访问)
4. [域名配置说明](#四域名配置说明)
5. [测评链接和二维码](#五测评链接和二维码)
6. [常见问题](#六常见问题)

---

## 一、本地开发环境启动

### 1.0 完整启动流程图

```
┌─────────────────────────────────────────────────────────────┐
│  第1步: 确保 Poetry 可用（如果使用 Poetry）                 │
├─────────────────────────────────────────────────────────────┤
│  poetry --version                                            │
│  ❌ 提示找不到? → export PATH="$HOME/.local/bin:$PATH"     │
│  ✅ 显示版本? → 继续下一步                                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  第2步: 进入后端目录                                         │
├─────────────────────────────────────────────────────────────┤
│  cd /Users/Python项目/HR人事/backend                         │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  第3步: 激活虚拟环境（必须！）                               │
├─────────────────────────────────────────────────────────────┤
│  • venv方式: source venv/bin/activate                       │
│  • Poetry方式: poetry shell                                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  第4步: 验证环境                                             │
├─────────────────────────────────────────────────────────────┤
│  which python  # 应该显示虚拟环境中的Python                 │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  第5步: 启动后端                                             │
├─────────────────────────────────────────────────────────────┤
│  uvicorn app.main:app --reload --host 0.0.0.0 --port 9000   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  第6步: 启动前端（新终端）                                   │
├─────────────────────────────────────────────────────────────┤
│  cd /Users/Python项目/HR人事/frontend                        │
│  npm run dev                                                 │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  第7步: 访问系统                                             │
├─────────────────────────────────────────────────────────────┤
│  • 本地: http://localhost:5173                              │
│  • 局域网: http://你的IP:5173                               │
└─────────────────────────────────────────────────────────────┘
```

### 1.1 环境检查（首次启动必读！）

在启动服务之前，请先确保环境已正确配置：

#### 配置 Poetry 环境变量（如果使用 Poetry）

**重要**: Poetry 通常安装在用户目录，需要先导入路径！

```bash
# 1. 查找 Poetry 安装位置
which poetry
# 如果显示 "command not found"，说明没有配置环境变量

# 2. Poetry 常见安装位置：
# macOS/Linux: ~/.local/bin/poetry
# 或: ~/Library/Application Support/pypoetry/venv/bin/poetry

# 3. 临时导入 Poetry 路径（本次终端会话有效）
export PATH="$HOME/.local/bin:$PATH"
# 或
export PATH="$HOME/Library/Application Support/pypoetry/venv/bin:$PATH"

# 4. 验证 Poetry 是否可用
poetry --version
# 应该显示: Poetry (version 1.5.0)

# 5. 永久配置（推荐）
# 编辑 ~/.zshrc 或 ~/.bash_profile
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc
```

**一键配置 Poetry 路径脚本**：
```bash
# 保存为 setup_poetry.sh
#!/bin/bash

echo "🔍 查找 Poetry..."

# 尝试常见路径
POETRY_PATHS=(
    "$HOME/.local/bin"
    "$HOME/Library/Application Support/pypoetry/venv/bin"
    "/usr/local/bin"
)

for path in "${POETRY_PATHS[@]}"; do
    if [ -f "$path/poetry" ]; then
        echo "✅ 找到 Poetry: $path/poetry"
        export PATH="$path:$PATH"
        
        # 写入配置文件
        if ! grep -q "$path" ~/.zshrc; then
            echo "export PATH=\"$path:\$PATH\"" >> ~/.zshrc
            echo "✅ 已添加到 ~/.zshrc"
        fi
        
        source ~/.zshrc
        poetry --version
        exit 0
    fi
done

echo "❌ 未找到 Poetry，请先安装:"
echo "curl -sSL https://install.python-poetry.org | python3 -"
```

#### 检查虚拟环境是否存在

```bash
# 进入后端目录
cd /Users/Python项目/HR人事/backend

# 方式1: 检查是否有 venv 目录
ls -la | grep venv
# 应该看到: drwxr-xr-x  venv/

# 方式2: 检查 Poetry 虚拟环境（需要先配置 Poetry 路径）
export PATH="$HOME/.local/bin:$PATH"  # 先导入 Poetry 路径
poetry env info
```

#### 如果虚拟环境不存在，需要先创建

```bash
# 方式1: 使用 venv
cd /Users/Python项目/HR人事/backend
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 方式2: 使用 Poetry（推荐）
cd /Users/Python项目/HR人事/backend
poetry install
```

#### 验证环境是否正确

```bash
# 激活虚拟环境
source venv/bin/activate  # 或 poetry shell

# 验证 Python 路径（重要！）
which python
# ✅ 正确输出: /Users/Python项目/HR人事/backend/venv/bin/python
# ❌ 错误输出: /usr/bin/python (说明没有激活虚拟环境)

# 验证依赖是否安装
pip list | grep fastapi
# 应该看到: fastapi  0.110.0

# 验证 uvicorn 是否可用
which uvicorn
# ✅ 应该输出虚拟环境中的 uvicorn 路径
```

### 1.1 快速启动（开发模式）

#### 步骤1: 启动后端服务

```bash
# 打开终端1
cd /Users/Python项目/HR人事/backend

# ⭐ 重要：先激活虚拟环境（必须！）

# 方式1: 如果使用 venv
source venv/bin/activate

# 方式2: 如果使用 Poetry（需要先确保Poetry在PATH中）
# 如果提示 "command not found: poetry"，需要先导入PATH:
export PATH="$HOME/.local/bin:$PATH"  # ⭐ Poetry通常安装在这里
# 然后再激活虚拟环境:
poetry shell

# 验证环境是否激活成功
which python
# 应该输出: /Users/Python项目/HR人事/backend/venv/bin/python
# 或: .../pypoetry/virtualenvs/.../bin/python

# 验证 Poetry 可用（如果使用 Poetry）
poetry --version

# ⭐ 启动后端（开发模式，支持热重载）
uvicorn app.main:app --reload --host 0.0.0.0 --port 9000

# 看到以下信息表示启动成功：
# INFO:     Uvicorn running on http://0.0.0.0:9000 (Press CTRL+C to quit)
# INFO:     Started reloader process
```

**⚠️ 常见错误：**
```bash
# 如果看到 "command not found: uvicorn"
# 说明没有激活虚拟环境，请先执行:
source venv/bin/activate

# 如果看到 "No module named 'app'"
# 说明不在正确的目录，请确保在 backend/ 目录下:
pwd  # 应该输出: /Users/Python项目/HR人事/backend
```

**重要参数说明：**
- `--reload`: 代码修改后自动重启（仅开发环境使用）
- `--host 0.0.0.0`: 允许局域网访问（重要！用于手机测试）
- `--port 9000`: 后端API端口

#### 步骤2: 启动前端服务

```bash
# 打开终端2（新开一个终端窗口）
cd /Users/Python项目/HR人事/frontend

# 启动前端（开发模式，支持热重载）
npm run dev

# 看到以下信息表示启动成功：
# VITE v5.0.0  ready in 500 ms
# ➜  Local:   http://localhost:5173/
# ➜  Network: http://192.168.1.100:5173/
```

**注意Network地址**：这是局域网IP，用于手机或其他设备访问！

#### 步骤3: 访问系统

```
本地访问:
- 前端: http://localhost:5173
- 后端API: http://localhost:9000
- API文档: http://localhost:9000/docs

局域网访问（同一WiFi下）:
- 前端: http://192.168.1.100:5173  （你的实际IP）
- 后端API: http://192.168.1.100:9000
```

### 1.2 获取本机IP地址

```bash
# macOS
ifconfig | grep "inet " | grep -v 127.0.0.1

# 输出类似:
# inet 192.168.1.100 netmask 0xffffff00 broadcast 192.168.1.255
# 你的IP就是: 192.168.1.100

# Linux
ip addr show | grep "inet " | grep -v 127.0.0.1

# Windows (CMD)
ipconfig | findstr "IPv4"
```

### 1.3 一键启动脚本

创建 `start_dev.sh` (macOS/Linux):

```bash
#!/bin/bash
# 保存在项目根目录: /Users/Python项目/HR人事/start_dev.sh

echo "=== QZ·TalentLens 开发环境启动 ==="

# 获取本机IP
LOCAL_IP=$(ifconfig | grep "inet " | grep -v 127.0.0.1 | head -n 1 | awk '{print $2}')
echo "📍 本机IP: $LOCAL_IP"
echo "📍 访问地址: http://$LOCAL_IP:5173"
echo ""

# 检查后端虚拟环境
if [ ! -d "backend/venv" ]; then
    echo "❌ 错误: 虚拟环境不存在！"
    echo "请先运行: cd backend && python3 -m venv venv && pip install -r requirements.txt"
    exit 1
fi

# 启动后端（后台运行）
echo "🚀 启动后端服务..."
cd backend
source venv/bin/activate  # ⭐ 激活虚拟环境

# 创建日志目录
mkdir -p ../logs

# 后台启动
nohup uvicorn app.main:app --reload --host 0.0.0.0 --port 9000 > ../logs/backend.log 2>&1 &
BACKEND_PID=$!
echo "✅ 后端已启动 (PID: $BACKEND_PID, 端口: 9000)"
echo "   日志文件: logs/backend.log"

# 等待后端启动
echo "⏳ 等待后端启动..."
sleep 3

# 检查后端是否成功启动
if ! curl -s http://localhost:9000/docs > /dev/null; then
    echo "❌ 后端启动失败！请查看日志: logs/backend.log"
    kill $BACKEND_PID
    exit 1
fi
echo "✅ 后端启动成功！"
echo ""

# 启动前端（前台运行）
echo "🚀 启动前端服务..."
cd ../frontend
npm run dev

# Ctrl+C 时停止后端
trap "echo '🛑 停止后端服务...'; kill $BACKEND_PID" EXIT
```

**使用方法：**
```bash
chmod +x start_dev.sh
./start_dev.sh
```

---

## 二、内网测试部署

### 2.1 局域网内测试（同一WiFi）

**场景**: 让办公室内的HR同事用手机测试

#### 步骤1: 确保防火墙开放端口

```bash
# macOS: 系统偏好设置 → 安全性与隐私 → 防火墙
# 允许 Python 和 Node 接受传入连接

# Linux (Ubuntu)
sudo ufw allow 9000
sudo ufw allow 5173
sudo ufw reload
```

#### 步骤2: 启动服务（同上）

```bash
# 后端
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 9000

# 前端
cd frontend
npm run dev
```

#### 步骤3: HR同事手机访问

```
1. 确保手机和电脑在同一WiFi
2. 手机浏览器访问: http://192.168.1.100:5173
   （替换为你的实际IP）
3. 登录账号: admin / admin123
4. 开始测试
```

### 2.2 测评链接生成（局域网）

**重要**: 在本地/内网测试时，测评链接会自动使用当前访问地址！

```
示例场景:
1. HR在电脑上访问: http://192.168.1.100:5173
2. HR创建测评，生成的链接是: 
   http://192.168.1.100:5173/assessment/ABC123
3. 二维码也是这个地址
4. HR用手机扫码，可以直接打开（同WiFi）

✅ 无需修改代码，系统会自动检测当前域名！
```

---

## 三、Ngrok外网访问

### 3.1 什么是Ngrok？

**Ngrok** 是一个内网穿透工具，可以让你的本地服务临时暴露到公网，获得一个公网域名。

**使用场景**:
- ✅ 让不在同一WiFi的HR同事测试（远程）
- ✅ 让候选人在家扫码答题
- ✅ 临时演示给客户看
- ✅ 微信内打开测评链接（微信不支持局域网IP）

### 3.2 安装Ngrok

#### macOS
```bash
# 使用Homebrew安装
brew install ngrok/ngrok/ngrok

# 或手动下载
# https://ngrok.com/download
```

#### Linux
```bash
# 下载并安装
wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
tar xvzf ngrok-v3-stable-linux-amd64.tgz
sudo mv ngrok /usr/local/bin/
```

#### Windows
```
下载: https://ngrok.com/download
解压到任意目录，添加到PATH
```

### 3.3 注册Ngrok账号

```bash
# 1. 访问 https://dashboard.ngrok.com/signup
# 2. 注册账号（免费版足够用）
# 3. 获取 authtoken

# 4. 配置 authtoken
ngrok config add-authtoken YOUR_AUTH_TOKEN
```

### 3.4 启动Ngrok

#### 方式一: 单独暴露后端（推荐）

```bash
# 终端1: 启动后端
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 9000

# 终端2: 启动前端
cd frontend
npm run dev

# 终端3: 启动Ngrok（暴露前端）
ngrok http 5173

# 你会看到:
# Forwarding  https://abc123.ngrok.io -> http://localhost:5173
# 这个 https://abc123.ngrok.io 就是你的临时公网域名！
```

**重要**: 还需要配置前端的API地址！

#### 方式二: 同时暴露前后端（需要2个Ngrok进程）

```bash
# 终端1: 启动后端
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 9000

# 终端2: Ngrok暴露后端
ngrok http 9000
# 得到: https://backend123.ngrok.io

# 终端3: 启动前端
cd frontend
npm run dev

# 终端4: Ngrok暴露前端
ngrok http 5173
# 得到: https://frontend456.ngrok.io
```

### 3.5 配置前端API地址（使用Ngrok时）

**重要**: 前端需要知道后端的Ngrok地址！

#### 临时修改（开发测试）

编辑 `frontend/src/api/index.ts`:

```typescript
// 原始代码（自动检测）
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || '/api'

// Ngrok测试时改为:
const API_BASE_URL = 'https://backend123.ngrok.io/api'  // 你的后端Ngrok地址
```

**或者** 使用环境变量（更推荐）：

创建 `frontend/.env.development.local`:
```bash
VITE_API_BASE_URL=https://backend123.ngrok.io/api
```

然后重启前端：
```bash
npm run dev
```

### 3.6 完整Ngrok测试流程

```bash
# 1. 启动后端
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 9000

# 2. 启动Ngrok暴露后端（新终端）
ngrok http 9000
# 记录地址: https://abc123.ngrok.io

# 3. 配置前端API地址
cd frontend
echo "VITE_API_BASE_URL=https://abc123.ngrok.io/api" > .env.development.local

# 4. 启动前端
npm run dev

# 5. 启动Ngrok暴露前端（新终端）
ngrok http 5173
# 记录地址: https://def456.ngrok.io

# 6. 访问
# 浏览器打开: https://def456.ngrok.io
# 手机扫码测评: https://def456.ngrok.io/assessment/XXX
```

### 3.7 Ngrok注意事项

⚠️ **免费版限制**:
- 每次启动地址都会变（如 `abc123.ngrok.io` → `xyz789.ngrok.io`）
- 每分钟40个请求限制
- 会显示Ngrok提示页面（点击"Visit Site"继续）

✅ **适用场景**:
- 临时测试（几小时）
- 小规模使用（5-10人）
- 演示Demo

❌ **不适用场景**:
- 长期使用（地址会变）
- 大量并发（有限流）
- 生产环境

💡 **替代方案**:
- **Ngrok付费版**: 固定域名 ($8/月)
- **花生壳**: 国内内网穿透工具
- **FRP**: 自建内网穿透（需要有公网服务器）

---

## 四、域名配置说明

### 4.1 域名申请和解析

#### 步骤1: 向公司申请域名

```
示例域名:
- hr.yourcompany.com
- talent.yourcompany.com
- recruit.yourcompany.com
```

#### 步骤2: DNS解析配置

```
在公司DNS管理平台配置:
类型: A记录
主机记录: hr (或talent)
记录值: 你的服务器公网IP (如 120.123.45.67)
TTL: 600

解析后的完整域名: hr.yourcompany.com
```

### 4.2 域名配置是否需要写入代码？

**重要答案**: ❌ **不需要！系统已经做了动态适配！**

#### 系统的智能检测机制

**前端代码**（`frontend/src/api/index.ts`）:
```typescript
// 系统会自动检测当前访问的域名
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || '/api'

// 访问 localhost:5173 → API地址: /api (代理到 localhost:9000)
// 访问 hr.company.com → API地址: /api (代理到 hr.company.com/api)
// ✅ 无需修改代码！
```

**后端测评链接生成**（`backend/app/api/assessments/router.py`）:
```python
# 系统会根据请求的Host头自动生成链接
def generate_assessment_link(request: Request, code: str) -> str:
    # 获取当前访问的域名
    host = request.headers.get("host")  # 如: hr.company.com
    scheme = request.url.scheme  # http 或 https
    
    # 自动生成链接
    link = f"{scheme}://{host}/assessment/{code}"
    # ✅ 域名变了，链接自动变！无需改代码！
    return link
```

### 4.3 生产环境部署后的配置

#### Nginx配置（重要！）

```nginx
# /etc/nginx/sites-available/talentlens

server {
    listen 80;
    server_name hr.yourcompany.com;  # 你的域名

    # 前端静态文件
    location / {
        root /var/www/talentlens;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api {
        proxy_pass http://127.0.0.1:9000;
        proxy_set_header Host $host;  # ⭐ 传递域名给后端
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 文件上传限制
    client_max_body_size 50M;
}

# HTTPS配置（生产环境必需！）
server {
    listen 443 ssl;
    server_name hr.yourcompany.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # 其他配置同上...
}
```

### 4.4 域名切换时需要做什么？

**答案**: ✅ **只需要修改Nginx配置，重启Nginx即可！**

```bash
# 1. 修改Nginx配置中的 server_name
sudo nano /etc/nginx/sites-available/talentlens
# 将 server_name 改为新域名

# 2. 测试配置
sudo nginx -t

# 3. 重启Nginx
sudo systemctl restart nginx

# 4. 访问新域名
# 浏览器: https://new-domain.com
# 测评链接会自动使用新域名！
```

**代码层面**: ❌ **完全不需要修改！**

---

## 五、测评链接和二维码

### 5.1 测评链接的生成机制

#### 后端逻辑（自动检测域名）

```python
# backend/app/api/assessments/router.py

@router.post("/")
async def create_assessment(
    request: Request,  # ⭐ 自动注入请求对象
    data: AssessmentCreate,
    session: Session = Depends(get_session)
):
    # 1. 创建测评记录
    assessment = Assessment(...)
    session.add(assessment)
    session.commit()
    
    # 2. 自动生成链接（根据当前域名）
    host = request.headers.get("host")  # 获取域名
    scheme = "https" if request.url.scheme == "https" else "http"
    
    link = f"{scheme}://{host}/assessment/{assessment.code}"
    # 示例结果:
    # localhost: http://localhost:5173/assessment/ABC123
    # 内网IP: http://192.168.1.100:5173/assessment/ABC123
    # Ngrok: https://abc123.ngrok.io/assessment/ABC123
    # 正式域名: https://hr.company.com/assessment/ABC123
    
    # 3. 生成二维码
    qr_url = generate_qrcode(link)
    assessment.qr_code_url = qr_url
    
    return assessment
```

### 5.2 不同场景下的链接

| 场景 | 访问地址 | 生成的测评链接 | 是否可用 |
|------|---------|--------------|---------|
| 本地开发 | localhost:5173 | http://localhost:5173/assessment/ABC123 | ✅ 本机可用 |
| 局域网测试 | 192.168.1.100:5173 | http://192.168.1.100:5173/assessment/ABC123 | ✅ 同WiFi可用 |
| Ngrok临时 | https://abc.ngrok.io | https://abc.ngrok.io/assessment/ABC123 | ✅ 公网可用（临时）|
| 正式域名 | https://hr.company.com | https://hr.company.com/assessment/ABC123 | ✅ 公网可用（永久）|

### 5.3 是否需要正式域名？

#### 各场景对比

| 需求 | 是否需要域名 | 推荐方案 |
|------|------------|---------|
| 本地开发测试 | ❌ 不需要 | localhost |
| 办公室内测试 | ❌ 不需要 | 局域网IP |
| 远程HR测试 | ⚠️ 建议有 | Ngrok临时域名 |
| 候选人答题（手机） | ⚠️ 建议有 | Ngrok或正式域名 |
| 微信内打开 | ✅ **必须** | 正式域名（需备案）|
| 生产环境 | ✅ **必须** | 正式域名 |

#### 为什么微信需要正式域名？

```
微信限制:
- ❌ 不能打开 localhost
- ❌ 不能打开局域网IP (192.168.x.x)
- ⚠️ Ngrok域名会显示"未验证的网页"警告
- ✅ 只有备案的正式域名可以正常打开
```

### 5.4 测试阶段的最佳实践

#### 阶段1: 内部测试（HR同事）

```bash
# 使用局域网IP
后端: http://192.168.1.100:9000
前端: http://192.168.1.100:5173

优点:
✅ 免费，稳定
✅ 速度快（局域网）
✅ 无需配置

缺点:
❌ 只能同WiFi访问
❌ 手机需要连公司WiFi
```

#### 阶段2: 小范围外部测试（5-10个候选人）

```bash
# 使用Ngrok
前端: https://abc123.ngrok.io
后端: https://def456.ngrok.io

优点:
✅ 公网访问
✅ 支持HTTPS
✅ 快速部署

缺点:
⚠️ 地址会变（每次重启）
⚠️ 有请求限制（免费版）
⚠️ 微信会提示"未验证"
```

#### 阶段3: 正式使用

```bash
# 使用正式域名
前端: https://hr.company.com

优点:
✅ 固定地址
✅ 微信正常打开
✅ 无限制
✅ 专业形象

缺点:
⚠️ 需要申请域名
⚠️ 需要备案（国内）
⚠️ 需要SSL证书
```

---

## 六、常见问题

### Q0: 启动后端时提示 "command not found: uvicorn"

**原因**: 没有激活虚拟环境，或依赖没有安装

**解决方案**:
```bash
# 1. 确保在正确的目录
cd /Users/Python项目/HR人事/backend
pwd  # 验证路径

# 2. 激活虚拟环境（必须！）
source venv/bin/activate

# 3. 验证是否激活成功
which python
# 应该输出: .../backend/venv/bin/python

# 4. 如果还是找不到 uvicorn，重新安装依赖
pip install uvicorn[standard]

# 5. 再次尝试启动
uvicorn app.main:app --reload --host 0.0.0.0 --port 9000
```

### Q0.1: 启动后端时提示 "No module named 'app'"

**原因**: 不在正确的目录，或 Python 路径问题

**解决方案**:
```bash
# 1. 确保在 backend 目录下
cd /Users/Python项目/HR人事/backend
pwd  # 必须显示 .../HR人事/backend

# 2. 确保虚拟环境已激活
source venv/bin/activate
which python  # 验证是否在虚拟环境中

# 3. 验证目录结构
ls -la
# 应该看到: app/ 目录

# 4. 再次启动
uvicorn app.main:app --reload --host 0.0.0.0 --port 9000
```

### Q0.2: 提示 "command not found: poetry"

**原因**: Poetry 没有添加到系统 PATH 中

**解决方案**:
```bash
# 1. 检查 Poetry 是否已安装
ls -la ~/.local/bin/ | grep poetry
# 如果看到 poetry 文件，说明已安装但PATH未配置

# 2. 临时解决（本次终端有效）
export PATH="$HOME/.local/bin:$PATH"

# 3. 永久解决（推荐）
# 根据你的 Shell 类型选择:

# 如果使用 bash:
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

# 如果使用 zsh (macOS 默认):
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# 4. 验证 Poetry 可用
poetry --version
# 应该输出: Poetry (version 1.5.0)

# 5. 如果 Poetry 确实没安装，执行安装:
curl -sSL https://install.python-poetry.org | python3 -
# 安装完成后重复步骤 2-4
```

### Q0.3: 虚拟环境不存在怎么办？

**首次启动必做**:
```bash
# 方式1: 使用 venv（推荐新手）
cd /Users/Python项目/HR人事/backend
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# 方式2: 使用 Poetry（推荐进阶用户）
cd /Users/Python项目/HR人事/backend
# 先确保 Poetry 可用
export PATH="$HOME/.local/bin:$PATH"  # ⭐ 如果需要
poetry --version  # 验证
# 然后安装依赖
poetry install
poetry shell
```

### Q1: 手机扫码后显示"无法访问"

**原因**: 手机和电脑不在同一WiFi

**解决方案**:
```bash
# 方案1: 手机连接同一WiFi
# 确保手机连接公司WiFi，不要用4G/5G

# 方案2: 使用Ngrok
ngrok http 5173
# 用Ngrok地址生成二维码
```

### Q2: 微信扫码显示"未验证的网页"

**原因**: 微信只信任备案域名

**解决方案**:
```bash
# 临时方案: 点击"继续访问"（可以用，但不专业）

# 正式方案: 申请公司域名并备案
# 1. 向IT部门申请域名
# 2. 完成ICP备案
# 3. 配置到生产服务器
```

### Q3: 局域网IP地址会变怎么办？

**解决方案**:
```bash
# 方案1: 固定本机IP（推荐）
# macOS: 系统偏好设置 → 网络 → 高级 → TCP/IP
# 选择"使用DHCP（手动地址）"，输入固定IP如 192.168.1.100

# 方案2: 每次启动时查看IP
ifconfig | grep "inet " | grep -v 127.0.0.1
# 告诉HR新的IP地址
```

### Q4: Ngrok地址每次都变怎么办？

**解决方案**:
```bash
# 方案1: 使用Ngrok付费版（$8/月）
# 可以获得固定域名，如 yourname.ngrok.io

# 方案2: 尽快申请正式域名
# 临时测试完就部署到正式服务器

# 方案3: 使用其他工具
# - 花生壳（国内）
# - FRP（自建，需要公网服务器）
```

### Q5: 前端调用后端API失败（跨域错误）

**症状**: 浏览器控制台显示 `CORS error`

**解决方案**:
```python
# 后端已经配置了CORS，检查是否包含你的域名
# backend/app/main.py

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:5173",
        "http://192.168.1.100:5173",  # 添加你的局域网IP
        "https://*.ngrok.io",  # 允许所有Ngrok域名
        "https://hr.yourcompany.com",  # 添加正式域名
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### Q6: 部署到服务器后，测评链接还是localhost

**原因**: Nginx没有正确传递Host头

**解决方案**:
```nginx
# 检查Nginx配置中是否有:
proxy_set_header Host $host;  # ⭐ 必须有这行！

# 完整配置:
location /api {
    proxy_pass http://127.0.0.1:9000;
    proxy_set_header Host $host;  # ⭐⭐⭐
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# 修改后重启Nginx
sudo nginx -t
sudo systemctl restart nginx
```

---

## 七、Poetry 专项配置指南

### 7.1 为什么需要配置 Poetry 路径？

Poetry 是全局安装的工具，通常安装在用户目录（不在项目内），所以需要先把 Poetry 的路径加到 PATH 环境变量中。

### 7.2 Poetry 常见安装位置

```bash
# macOS/Linux 常见位置：
~/.local/bin/poetry
~/Library/Application Support/pypoetry/venv/bin/poetry
/usr/local/bin/poetry

# 查找 Poetry 位置
which poetry  # 如果配置正确，会显示路径
find ~ -name poetry -type f 2>/dev/null | head -5  # 强制查找
```

### 7.3 配置 Poetry 路径（三种方式）

#### 方式1: 临时配置（本次终端会话有效）

```bash
# 每次打开新终端都需要执行
export PATH="$HOME/.local/bin:$PATH"

# 验证
poetry --version
```

#### 方式2: 永久配置（推荐）

```bash
# 编辑 shell 配置文件
# macOS Catalina+ 使用 zsh
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# 老版本 macOS 或 Linux 使用 bash
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bash_profile
source ~/.bash_profile

# 验证
poetry --version
```

#### 方式3: 使用别名（不推荐，但可以临时救急）

```bash
# 如果找到了 Poetry 位置，可以创建别名
alias poetry="$HOME/.local/bin/poetry"

# 或添加到配置文件
echo 'alias poetry="$HOME/.local/bin/poetry"' >> ~/.zshrc
source ~/.zshrc
```

### 7.4 首次安装 Poetry

如果完全没有安装 Poetry：

```bash
# 官方安装脚本
curl -sSL https://install.python-poetry.org | python3 -

# 安装完成后，配置环境变量
export PATH="$HOME/.local/bin:$PATH"
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# 验证
poetry --version
```

### 7.5 完整的 Poetry 使用流程

```bash
# 1. 配置 Poetry 路径（首次必做）
export PATH="$HOME/.local/bin:$PATH"

# 2. 进入项目目录
cd /Users/Python项目/HR人事/backend

# 3. 安装项目依赖（首次必做）
poetry install

# 4. 激活虚拟环境
poetry shell

# 5. 验证环境
which python  # 应该在 Poetry 的虚拟环境中
poetry env info  # 查看虚拟环境信息

# 6. 启动后端服务
uvicorn app.main:app --reload --host 0.0.0.0 --port 9000
```

---

## 八、快速参考

### 8.1 本地开发启动命令（完整版）

```bash
# ========== 后端（完整步骤）==========

# 方式1: 使用 venv
cd /Users/Python项目/HR人事/backend
source venv/bin/activate  # ⭐ 激活虚拟环境
uvicorn app.main:app --reload --host 0.0.0.0 --port 9000

# 方式2: 使用 Poetry
cd /Users/Python项目/HR人事/backend
# ⭐ 如果提示 "command not found: poetry"，先导入PATH:
export PATH="$HOME/.local/bin:$PATH"
# 然后激活虚拟环境:
poetry shell
uvicorn app.main:app --reload --host 0.0.0.0 --port 9000

# ========== 前端 ==========
cd /Users/Python项目/HR人事/frontend
npm run dev
```

### 7.2 Ngrok快速启动

```bash
# 1. 启动服务
# 后端: uvicorn app.main:app --reload --host 0.0.0.0 --port 9000
# 前端: npm run dev

# 2. 暴露前端
ngrok http 5173

# 3. 配置后端Ngrok地址（如果需要）
# 编辑 frontend/.env.development.local
# VITE_API_BASE_URL=https://你的后端ngrok地址/api
```

### 7.3 查看本机IP

```bash
# macOS/Linux
ifconfig | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}'

# 或
hostname -I
```

### 7.4 测试链接是否可访问

```bash
# 测试后端
curl http://localhost:9000/docs

# 测试前端
curl http://localhost:5173

# 测试局域网访问
curl http://192.168.1.100:9000/docs
```

---

## 八、推荐的测试流程

### 给HR人员测试的标准流程

#### 阶段1: 办公室内测试（1-2天）

```bash
1. 开发人员准备环境（首次必做）
   cd /Users/Python项目/HR人事/backend
   source venv/bin/activate  # ⭐ 激活虚拟环境
   which python  # 验证环境

2. 开发人员启动本地服务
   # 后端（必须先激活虚拟环境！）
   cd backend && source venv/bin/activate
   uvicorn app.main:app --reload --host 0.0.0.0 --port 9000
   
   # 前端
   cd frontend && npm run dev

3. 查看本机IP
   ifconfig | grep "inet " | grep -v 127.0.0.1
   # 记录IP，如: 192.168.1.100

4. HR同事手机连接公司WiFi（同一WiFi！）

5. HR访问: http://192.168.1.100:5173
   （替换为你的实际IP）

6. HR创建测评，生成二维码

7. HR用自己手机扫码测试答题

8. 收集反馈，修复Bug
```

#### 阶段2: 远程测试（3-5天）

```bash
1. 开发人员启动Ngrok
   ngrok http 5173

2. 获得公网地址: https://abc123.ngrok.io

3. 发送给HR人员

4. HR在任何地方访问
   - 电脑浏览器打开
   - 手机扫码答题
   - 微信分享测评链接

5. 收集反馈，优化功能
```

#### 阶段3: 正式部署（申请域名后）

```bash
1. 向公司IT申请域名
   - 如: hr.company.com

2. 运维人员部署到服务器
   - 配置Nginx
   - 配置SSL证书
   - 启动服务

3. HR访问正式域名测试

4. 确认所有功能正常

5. 正式投入使用
```

---

## 附录

### A. 相关文档

- [项目交付指南](./项目交付指南.md)
- [部署交付文档](./04_部署交付文档.md)
- [后续维护文档](./05_后续维护文档.md)

### B. 外部资源

- Ngrok官网: https://ngrok.com
- Ngrok文档: https://ngrok.com/docs
- 花生壳: https://hsk.oray.com
- FRP: https://github.com/fatedier/frp

### C. 技术支持

如有问题，请查阅文档或联系开发团队。


```

#### 阶段3: 正式部署（申请域名后）

```bash
1. 向公司IT申请域名
   - 如: hr.company.com

2. 运维人员部署到服务器
   - 配置Nginx
   - 配置SSL证书
   - 启动服务

3. HR访问正式域名测试

4. 确认所有功能正常

5. 正式投入使用
```

---

## 附录

### A. 相关文档

- [项目交付指南](./项目交付指南.md)
- [部署交付文档](./04_部署交付文档.md)
- [后续维护文档](./05_后续维护文档.md)

### B. 外部资源

- Ngrok官网: https://ngrok.com
- Ngrok文档: https://ngrok.com/docs
- 花生壳: https://hsk.oray.com
- FRP: https://github.com/fatedier/frp

### C. 技术支持

如有问题，请查阅文档或联系开发团队。


- FRP: https://github.com/fatedier/frp

### C. 技术支持

如有问题，请查阅文档或联系开发团队。

