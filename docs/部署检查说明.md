# 部署检查说明

## 问题1：为什么会出现缩进语法错误？

### 根本原因

这些缩进错误是在**多次代码修改**过程中逐步累积的，主要原因包括：

1. **工具使用不当**：使用 `search_replace` 工具时，如果上下文不完整，可能导致缩进不匹配
2. **多次部分修改**：对同一文件进行多次修改，每次都可能引入轻微的缩进错误
3. **Python 缩进敏感性**：Python 对缩进极其敏感，一个空格的差异都会导致语法错误
4. **缺乏自动检查**：之前没有在修改后立即进行语法检查

### 已修复的文件

本次修复了以下6个文件的共计**7处**缩进错误：

1. `backend/app/main.py` (2处)
   - 第818行：`session.commit()` 不在try块内
   - 第1240行：`break` 后面错误地跟了 `else:`

2. `backend/app/api/assessments/router.py` (1处)
   - 第187行：`raise HTTPException` 不在else块内

3. `backend/app/api/assessments/service.py` (2处)
   - 第501-503行：`for` 循环不在if块内
   - 第979行：`count += ...` 不在if块内

4. `backend/app/api/assessments/questionnaire_parser.py` (2处)
   - 第522行、第549行：`return True` 不在if块内

## 防止类似问题的措施

### 1. 部署前检查脚本

已创建 `backend/pre_deploy_check.sh`：

```bash
cd backend
chmod +x pre_deploy_check.sh
./pre_deploy_check.sh
```

该脚本会检查：
- ✅ Python 语法
- ✅ 依赖完整性
- ✅ 主模块导入
- ✅ 环境变量

### 2. 语法检查工具

已创建 `backend/check_syntax.py`：

```bash
cd backend
python3 check_syntax.py
```

会检查所有56个Python文件的语法。

### 3. 日常开发建议

**修改代码后立即检查**：
```bash
# 检查单个文件
python3 -m py_compile app/main.py

# 检查整个项目
python3 check_syntax.py

# 尝试导入
python3 -c "from app.main import app; print('OK')"
```

**使用IDE的Linter**：
- 启用 Pylint / Flake8
- 保存时自动格式化 (Black / autopep8)

**版本控制**：
```bash
# 每次修改后提交
git add .
git commit -m "描述修改内容"

# 如果出现问题，可以回退
git diff  # 查看修改
git checkout -- <file>  # 撤销修改
```

## 生产环境部署清单

### 部署前必做

1. [ ] 运行 `./pre_deploy_check.sh` 确保无语法错误
2. [ ] 运行测试用例（如果有）
3. [ ] 检查 `.env` 配置是否正确
4. [ ] 备份当前数据库
5. [ ] 确认依赖版本兼容性

### 部署步骤

```bash
# 1. 拉取最新代码
git pull origin main

# 2. 安装依赖
cd backend
poetry install --no-dev

# 3. 检查语法
./pre_deploy_check.sh

# 4. 运行数据库迁移（如果有）
# poetry run alembic upgrade head

# 5. 重启服务
# systemctl restart hr-backend
```

### 部署后检查

1. [ ] 服务启动成功
2. [ ] 健康检查通过：`curl http://localhost:9000/health`
3. [ ] 日志无错误
4. [ ] 前端可以正常访问API
5. [ ] 关键功能测试通过

## 监控建议

### 日志监控

```bash
# 查看最新日志
tail -f /var/log/hr-backend.log

# 搜索错误
grep -i error /var/log/hr-backend.log
grep -i "IndentationError\|SyntaxError" /var/log/hr-backend.log
```

### 进程监控

```bash
# 检查进程状态
ps aux | grep uvicorn

# 检查端口占用
lsof -i:9000
```

### 性能监控

- 使用 PM2 / Supervisor 管理进程
- 配置进程自动重启
- 设置日志轮转
- 配置告警通知

## 总结

**当前状态**：
- ✅ 所有56个Python文件语法检查通过
- ✅ 后端服务正常运行
- ✅ 前端可以正常访问
- ✅ 已建立部署检查机制

**重要提醒**：
1. 每次修改代码后立即运行 `check_syntax.py`
2. 部署前必须运行 `pre_deploy_check.sh`
3. 使用版本控制跟踪所有修改
4. 生产环境部署前在测试环境验证

---

最后更新：2025-12-10

