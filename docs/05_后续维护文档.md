# QZ·TalentLens 后续维护文档

> **版本**: v1.0  
> **更新日期**: 2025年12月8日  
> **适用对象**: 系统运维人员、技术支持

---

## 一、日常维护

### 1.1 日常检查清单

| 检查项 | 频率 | 方法 |
|--------|------|------|
| 服务状态 | 每日 | `systemctl status talentlens` |
| 磁盘空间 | 每周 | `df -h` |
| 日志大小 | 每周 | `du -sh /var/log/talentlens/` |
| 数据库大小 | 每周 | `ls -lh backend/hr.db` |
| AI Token 状态 | 每周 | 系统设置页面查看 |
| 备份完整性 | 每周 | 检查备份文件 |

### 1.2 服务管理

```bash
# 启动服务
sudo systemctl start talentlens

# 停止服务
sudo systemctl stop talentlens

# 重启服务
sudo systemctl restart talentlens

# 查看状态
sudo systemctl status talentlens

# 查看实时日志
sudo journalctl -u talentlens -f
```

### 1.3 健康检查

```bash
# API 健康检查
curl http://localhost:9000/health

# 预期响应
{
  "status": "healthy",
  "database": "connected",
  "ai": "available"
}
```

---

## 二、Token 维护

### 2.1 Token 有效期

- **有效期**: 30 天
- **提醒时机**: 到期前 7 天
- **提醒方式**: 每日登录弹窗

### 2.2 Token 更新流程

#### 方式一：通过系统界面

1. 登录系统后台
2. 进入"系统设置"
3. 展开"AI 模型配置"
4. 输入新 Token
5. 点击"保存配置"

#### 方式二：直接修改配置文件

```bash
# 编辑 .env 文件
cd /opt/HR人事/backend
nano .env

# 更新以下配置
MODELSCOPE_API_KEY=new_api_key_here
MODELSCOPE_API_KEY_EXPIRES=2026-01-06

# 重启服务
sudo systemctl restart talentlens
```

### 2.3 Token 获取

1. 访问 [ModelScope](https://modelscope.cn)
2. 登录账号
3. 进入"个人中心" → "API 密钥"
4. 创建或复制 API Key

---

## 三、数据维护

### 3.1 数据备份

#### 自动备份

备份脚本位于 `/opt/backup_talentlens.sh`：

```bash
#!/bin/bash
BACKUP_DIR=/backup/talentlens
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份数据库
cp /opt/HR人事/backend/hr.db $BACKUP_DIR/hr_$DATE.db

# 备份配置
cp /opt/HR人事/backend/.env $BACKUP_DIR/env_$DATE

# 保留最近 7 天的备份
find $BACKUP_DIR -name "*.db" -mtime +7 -delete
find $BACKUP_DIR -name "env_*" -mtime +7 -delete

echo "Backup completed: $DATE"
```

定时任务（每天凌晨 2 点）：
```bash
0 2 * * * /opt/backup_talentlens.sh
```

#### 手动备份

```bash
# 备份数据库
cp /opt/HR人事/backend/hr.db /backup/hr_manual_$(date +%Y%m%d).db

# 备份配置
cp /opt/HR人事/backend/.env /backup/env_manual_$(date +%Y%m%d)
```

### 3.2 数据恢复

```bash
# 停止服务
sudo systemctl stop talentlens

# 恢复数据库
cp /backup/hr_20251208.db /opt/HR人事/backend/hr.db

# 恢复配置（如需要）
cp /backup/env_20251208 /opt/HR人事/backend/.env

# 启动服务
sudo systemctl start talentlens
```

### 3.3 数据清理

#### 清理测试数据

通过系统界面：
1. 进入"人员管理"
2. 点击"批量删除"
3. 选择要删除的记录
4. 确认删除

#### 清理所有数据（谨慎操作）

```bash
# 停止服务
sudo systemctl stop talentlens

# 删除数据库
rm /opt/HR人事/backend/hr.db

# 启动服务（会自动创建新数据库）
sudo systemctl start talentlens
```

---

## 四、日志维护

### 4.1 日志位置

| 日志类型 | 位置 |
|----------|------|
| 应用日志 | `/var/log/talentlens/` |
| Nginx 访问日志 | `/var/log/nginx/access.log` |
| Nginx 错误日志 | `/var/log/nginx/error.log` |
| 系统服务日志 | `journalctl -u talentlens` |

### 4.2 日志查看

```bash
# 查看应用日志
tail -f /var/log/talentlens/app.log

# 查看 Nginx 错误
tail -f /var/log/nginx/error.log

# 查看系统服务日志
journalctl -u talentlens -f

# 按时间查看日志
journalctl -u talentlens --since "2025-12-08 00:00:00"
```

### 4.3 日志轮转

日志轮转配置 `/etc/logrotate.d/talentlens`：

```
/var/log/talentlens/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
}
```

### 4.4 日志清理

```bash
# 清理 14 天前的日志
find /var/log/talentlens/ -name "*.log.*" -mtime +14 -delete

# 清理压缩的旧日志
find /var/log/talentlens/ -name "*.gz" -mtime +30 -delete
```

---

## 五、性能维护

### 5.1 性能监控

```bash
# 查看系统资源
top
htop

# 查看内存使用
free -h

# 查看磁盘使用
df -h

# 查看进程状态
ps aux | grep uvicorn
```

### 5.2 性能优化

#### 数据库优化

```bash
# SQLite 优化
sqlite3 /opt/HR人事/backend/hr.db "VACUUM;"
sqlite3 /opt/HR人事/backend/hr.db "ANALYZE;"
```

#### 清理缓存

```bash
# 清理 Python 缓存
find /opt/HR人事/backend -type d -name __pycache__ -exec rm -rf {} +

# 清理 npm 缓存
cd /opt/HR人事/frontend
npm cache clean --force
```

### 5.3 资源扩展

当系统负载增加时：

1. **增加 Worker 数量**:
   ```bash
   # 修改 systemd 配置
   --workers 4 → --workers 8
   ```

2. **增加服务器内存**

3. **考虑使用 PostgreSQL** 替代 SQLite

---

## 六、安全维护

### 6.1 密码管理

#### 修改管理员密码

1. 登录系统
2. 进入"系统设置"
3. 展开"修改密码"
4. 输入当前密码和新密码
5. 保存修改

#### 重置密码（忘记密码）

```bash
# 进入后端目录
cd /opt/HR人事/backend
source venv/bin/activate

# 使用 Python 重置密码
python << 'EOF'
from app.db import get_session
from app.models import User
from app.auth import hash_password

with get_session() as session:
    user = session.query(User).filter(User.username == "admin").first()
    if user:
        user.password_hash = hash_password("new_password_here")
        session.commit()
        print("Password reset successfully")
    else:
        print("User not found")
EOF
```

### 6.2 安全更新

```bash
# 更新系统包
sudo apt update && sudo apt upgrade

# 更新 Python 依赖
cd /opt/HR人事/backend
source venv/bin/activate
pip install --upgrade -r requirements.txt

# 更新 Node.js 依赖
cd /opt/HR人事/frontend
npm update
npm audit fix
```

### 6.3 安全检查

```bash
# 检查 Python 依赖漏洞
pip install safety
safety check

# 检查 npm 依赖漏洞
npm audit
```

---

## 七、故障处理

### 7.1 常见故障

#### 服务无法启动

**症状**: `systemctl status talentlens` 显示 failed

**排查步骤**:
```bash
# 查看详细错误
journalctl -u talentlens -n 50

# 常见原因
# 1. 端口被占用
netstat -tlnp | grep 9000

# 2. 权限问题
ls -la /opt/HR人事/backend/

# 3. 依赖缺失
cd /opt/HR人事/backend
source venv/bin/activate
pip check
```

#### 502 Bad Gateway

**症状**: 访问网站显示 502 错误

**排查步骤**:
```bash
# 检查后端是否运行
curl http://127.0.0.1:9000/health

# 检查 Nginx 配置
nginx -t

# 查看 Nginx 错误日志
tail -f /var/log/nginx/error.log
```

#### AI 功能不可用

**症状**: AI 分析返回错误或超时

**排查步骤**:
1. 检查 Token 是否过期
2. 检查网络连接
3. 查看 AI 相关日志

```bash
# 测试 AI 服务连接
curl -X POST https://api-inference.modelscope.cn/v1/chat/completions \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"model":"Qwen/Qwen2.5-7B-Instruct","messages":[{"role":"user","content":"test"}]}'
```

#### 数据库错误

**症状**: 操作返回数据库错误

**排查步骤**:
```bash
# 检查数据库文件
ls -la /opt/HR人事/backend/hr.db

# 检查数据库完整性
sqlite3 /opt/HR人事/backend/hr.db "PRAGMA integrity_check;"

# 如果损坏，从备份恢复
cp /backup/hr_latest.db /opt/HR人事/backend/hr.db
```

### 7.2 紧急恢复

#### 快速恢复步骤

```bash
# 1. 停止服务
sudo systemctl stop talentlens

# 2. 恢复最近备份
cp /backup/talentlens/hr_latest.db /opt/HR人事/backend/hr.db
cp /backup/talentlens/env_latest /opt/HR人事/backend/.env

# 3. 重启服务
sudo systemctl start talentlens

# 4. 验证
curl http://localhost:9000/health
```

---

## 八、版本升级

### 8.1 升级前准备

1. **备份数据**
   ```bash
   /opt/backup_talentlens.sh
   ```

2. **记录当前版本**
   ```bash
   cat /opt/HR人事/version.txt
   ```

3. **通知用户**
   - 发送维护通知
   - 确定维护窗口

### 8.2 升级步骤

```bash
# 1. 停止服务
sudo systemctl stop talentlens

# 2. 备份当前版本
cp -r /opt/HR人事 /opt/HR人事_backup_$(date +%Y%m%d)

# 3. 获取新版本代码
cd /opt/HR人事
git pull origin main
# 或解压新版本包

# 4. 更新后端依赖
cd backend
source venv/bin/activate
pip install -r requirements.txt

# 5. 更新前端
cd ../frontend
npm install
npm run build

# 6. 运行数据库迁移（如有）
cd ../backend
python -m alembic upgrade head

# 7. 启动服务
sudo systemctl start talentlens

# 8. 验证
curl http://localhost:9000/health
```

### 8.3 回滚步骤

```bash
# 如果升级失败，回滚到备份版本
sudo systemctl stop talentlens
rm -rf /opt/HR人事
mv /opt/HR人事_backup_20251208 /opt/HR人事
sudo systemctl start talentlens
```

---

## 九、监控告警

### 9.1 监控指标

| 指标 | 阈值 | 告警级别 |
|------|------|----------|
| CPU 使用率 | > 80% | 警告 |
| 内存使用率 | > 85% | 警告 |
| 磁盘使用率 | > 90% | 严重 |
| API 响应时间 | > 5s | 警告 |
| 错误率 | > 5% | 严重 |

### 9.2 简单监控脚本

```bash
cat > /opt/monitor_talentlens.sh << 'EOF'
#!/bin/bash

# 检查服务状态
if ! systemctl is-active --quiet talentlens; then
    echo "ALERT: TalentLens service is down!"
    # 发送告警（邮件/短信/webhook）
fi

# 检查磁盘空间
DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 90 ]; then
    echo "ALERT: Disk usage is ${DISK_USAGE}%"
fi

# 检查 API 健康
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9000/health)
if [ $HTTP_CODE -ne 200 ]; then
    echo "ALERT: API health check failed with code $HTTP_CODE"
fi
EOF

chmod +x /opt/monitor_talentlens.sh

# 每 5 分钟检查一次
echo "*/5 * * * * /opt/monitor_talentlens.sh >> /var/log/talentlens/monitor.log 2>&1" | crontab -
```

---

## 十、联系支持

### 10.1 技术支持

- **支持时间**: 工作日 9:00-18:00
- **响应时间**: 
  - 紧急问题: 2 小时内
  - 一般问题: 24 小时内

### 10.2 问题反馈

反馈问题时请提供：
1. 问题描述
2. 复现步骤
3. 错误日志截图
4. 系统环境信息

### 10.3 常用资源

- [产品使用指南](./02_产品使用指南.md)
- [API 接口文档](./06_API接口文档.md)
- [部署交付文档](./04_部署交付文档.md)

---

## 附录

### A. 维护命令速查

```bash
# 服务管理
sudo systemctl start/stop/restart/status talentlens

# 日志查看
journalctl -u talentlens -f
tail -f /var/log/talentlens/app.log

# 备份
/opt/backup_talentlens.sh

# 健康检查
curl http://localhost:9000/health

# 数据库优化
sqlite3 hr.db "VACUUM; ANALYZE;"
```

### B. 重要文件位置

| 文件 | 位置 |
|------|------|
| 应用代码 | `/opt/HR人事/` |
| 后端配置 | `/opt/HR人事/backend/.env` |
| 数据库 | `/opt/HR人事/backend/hr.db` |
| Nginx 配置 | `/etc/nginx/sites-available/talentlens` |
| 服务配置 | `/etc/systemd/system/talentlens.service` |
| 备份目录 | `/backup/talentlens/` |
| 日志目录 | `/var/log/talentlens/` |

