# QZ·TalentLens 数据库表文档

> **版本**: v1.0  
> **更新日期**: 2025年12月8日  
> **数据库**: SQLite (开发) / PostgreSQL (生产)

---

## 一、数据库概述

### 1.1 ER 图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           数据库关系图                                   │
└─────────────────────────────────────────────────────────────────────────┘

┌───────────┐       ┌───────────────┐       ┌───────────────┐
│   users   │       │questionnaires │       │  assessments  │
├───────────┤       ├───────────────┤       ├───────────────┤
│ id (PK)   │       │ id (PK)       │◄──────│questionnaire_id│
│ username  │       │ name          │       │ code          │
│ password  │       │ type          │       │ valid_from    │
│ role      │       │ category      │       │ valid_until   │
└───────────┘       │ questions_data│       └───────┬───────┘
                    └───────┬───────┘               │
                            │                       │
                            │                       │
                            ▼                       ▼
                    ┌───────────────────────────────────────┐
                    │             submissions               │
                    ├───────────────────────────────────────┤
                    │ id (PK)                               │
                    │ code                                  │
                    │ assessment_id (FK) ──────────────────►│
                    │ questionnaire_id (FK) ───────────────►│
                    │ candidate_name                        │
                    │ candidate_phone                       │
                    │ answers                               │
                    │ scores                                │
                    │ candidate_id (FK) ───────────────────►│
                    └───────────────────┬───────────────────┘
                                        │
                                        ▼
                    ┌───────────────────────────────────────┐
                    │             candidates                │
                    ├───────────────────────────────────────┤
                    │ id (PK)                               │
                    │ name                                  │
                    │ phone                                 │
                    │ position                              │
                    │ resume_text                           │
                    └───────────────────────────────────────┘
                                        │
                                        ▼
                    ┌───────────────────────────────────────┐
                    │           portrait_cache              │
                    ├───────────────────────────────────────┤
                    │ id (PK)                               │
                    │ candidate_id (FK) ───────────────────►│
                    │ portrait_data                         │
                    │ analysis_level                        │
                    └───────────────────────────────────────┘


┌───────────────┐       ┌───────────────────┐       ┌───────────────┐
│ job_profiles  │◄──────│job_dimension_weights│       │profile_matches│
├───────────────┤       ├───────────────────┤       ├───────────────┤
│ id (PK)       │       │ id (PK)           │       │ id (PK)       │
│ name          │       │ job_profile_id(FK)│       │ profile_id(FK)│
│ dimensions    │       │ dimension_code    │       │submission_id  │
│ department    │       │ weight            │       │ match_score   │
└───────────────┘       └───────────────────┘       └───────────────┘
```

### 1.2 表清单

| 表名 | 说明 | 核心用途 |
|------|------|----------|
| users | 用户表 | 系统认证 |
| questionnaires | 问卷表 | 存储问卷定义和题目 |
| assessments | 测评分发表 | 管理测评链接和配置 |
| submissions | 提交记录表 | 存储答题结果 |
| candidates | 候选人表 | 候选人基本信息 |
| portrait_cache | 画像缓存表 | 缓存 AI 分析结果 |
| job_profiles | 岗位画像表 | 岗位能力配置 |
| job_dimension_weights | 维度权重表 | 岗位维度详细配置 |
| profile_matches | 匹配记录表 | 人岗匹配结果 |
| job_positions | 岗位表 | 基础岗位信息 |

---

## 二、表结构详解

### 2.1 users - 用户表

**用途**: 存储系统管理员账号信息

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| username | VARCHAR(255) | UNIQUE, INDEX | 用户名 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希值 |
| role | VARCHAR(20) | DEFAULT 'user' | 角色: admin/user |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

**索引**:
- `idx_users_username` (username)

**示例数据**:
```json
{
  "id": 1,
  "username": "admin",
  "password_hash": "$2b$12$...",
  "role": "admin",
  "created_at": "2025-12-08T10:00:00"
}
```

---

### 2.2 questionnaires - 问卷表

**用途**: 存储所有问卷的定义，包括专业测评和自定义问卷

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| name | VARCHAR(255) | INDEX | 问卷名称 |
| type | VARCHAR(20) | NOT NULL | 类型: EPQ/DISC/MBTI/custom |
| category | VARCHAR(20) | DEFAULT 'survey' | 分类: professional/scored/survey |
| questions_count | INTEGER | DEFAULT 0 | 题目数量 |
| estimated_minutes | INTEGER | DEFAULT 15 | 预计时长(分钟) |
| questions_data | JSON | | 题目数据 |
| scoring_rules | JSON | | 计分规则 |
| description | TEXT | | 问卷描述 |
| status | VARCHAR(20) | DEFAULT 'active' | 状态: active/inactive |
| custom_type | VARCHAR(20) | | 自定义类型: scored/non_scored |
| scoring_config | JSON | | 评分配置 |
| purpose | VARCHAR(20) | | 用途: assessment/survey |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |
| updated_at | DATETIME | DEFAULT NOW | 更新时间 |

**category 分类说明**:
- `professional`: 专业测评（MBTI/DISC/EPQ）
- `scored`: 评分问卷（自定义，有评分）
- `survey`: 调查问卷（自定义，无评分）

**questions_data 结构示例**:
```json
{
  "questions": [
    {
      "id": 1,
      "text": "在社交场合中，你更倾向于...",
      "type": "single",
      "dimension": "E/I",
      "options": [
        {"id": "a", "text": "主动与人交流", "dimension": "E"},
        {"id": "b", "text": "等待他人接近", "dimension": "I"}
      ]
    }
  ]
}
```

---

### 2.3 assessments - 测评分发表

**用途**: 管理测评的分发配置，每次分发生成一条记录

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| name | VARCHAR(255) | NOT NULL | 测评名称 |
| code | VARCHAR(64) | UNIQUE, INDEX | 访问码 |
| questionnaire_id | INTEGER | FK | 关联问卷 |
| valid_from | DATETIME | NOT NULL | 有效期开始 |
| valid_until | DATETIME | NOT NULL | 有效期结束 |
| description | TEXT | | 描述 |
| qr_code_url | VARCHAR(512) | | 二维码URL |
| form_fields | JSON | | 表单字段配置 |
| page_texts | JSON | | 页面文案配置 |
| link_type | VARCHAR(20) | DEFAULT 'temporary' | 链接类型 |
| allow_repeat | BOOLEAN | DEFAULT TRUE | 允许重复提交 |
| repeat_check_by | VARCHAR(20) | DEFAULT 'phone' | 重复判断依据 |
| max_submissions | INTEGER | DEFAULT 0 | 最大提交次数 |
| view_count | INTEGER | DEFAULT 0 | 浏览量 |
| start_count | INTEGER | DEFAULT 0 | 开始数 |
| created_by | INTEGER | | 创建人ID |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |
| updated_at | DATETIME | DEFAULT NOW | 更新时间 |

**form_fields 结构示例**:
```json
{
  "name": {"enabled": true, "required": true, "label": "姓名"},
  "phone": {"enabled": true, "required": true, "label": "手机号"},
  "email": {"enabled": false, "required": false},
  "position": {"enabled": true, "required": false, "label": "应聘岗位"}
}
```

---

### 2.4 submissions - 提交记录表

**用途**: 存储候选人的答题记录和结果

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| code | VARCHAR(64) | UNIQUE, INDEX | 提交编码 |
| assessment_id | INTEGER | FK | 关联测评 |
| questionnaire_id | INTEGER | FK | 关联问卷 |
| candidate_name | VARCHAR(255) | NOT NULL | 候选人姓名 |
| candidate_phone | VARCHAR(20) | NOT NULL | 候选人手机 |
| candidate_email | VARCHAR(255) | | 候选人邮箱 |
| gender | VARCHAR(10) | | 性别 |
| target_position | VARCHAR(255) | | 应聘岗位 |
| custom_data | JSON | | 自定义字段数据 |
| answers | JSON | | 答案数据 |
| scores | JSON | | 得分数据 |
| total_score | INTEGER | | 总分 |
| grade | VARCHAR(10) | | 等级 |
| result_details | JSON | | 结果详情 |
| max_score | INTEGER | | 满分 |
| score_percentage | FLOAT | | 得分率 |
| status | VARCHAR(20) | DEFAULT 'in_progress' | 状态 |
| started_at | DATETIME | DEFAULT NOW | 开始时间 |
| submitted_at | DATETIME | | 提交时间 |
| candidate_id | INTEGER | FK | 关联候选人 |

**answers 结构示例**:
```json
{
  "1": "a",
  "2": "b",
  "3": ["a", "c"]
}
```

**result_details 结构示例 (MBTI)**:
```json
{
  "type": "INTJ",
  "dimensions": {
    "E/I": {"E": 30, "I": 70},
    "S/N": {"S": 25, "N": 75},
    "T/F": {"T": 80, "F": 20},
    "J/P": {"J": 65, "P": 35}
  },
  "description": "建筑师型人格..."
}
```

---

### 2.5 candidates - 候选人表

**用途**: 存储候选人基本信息和简历数据

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| name | VARCHAR(255) | INDEX | 姓名 |
| email | VARCHAR(255) | | 邮箱 |
| phone | VARCHAR(20) | | 手机号 |
| position | VARCHAR(255) | | 应聘岗位 |
| resume_file_path | VARCHAR(512) | | 简历文件路径 |
| resume_original_name | VARCHAR(255) | | 原始文件名 |
| resume_text | TEXT | | 简历文本 |
| resume_parsed_data | JSON | | AI解析数据 |
| resume_uploaded_at | DATETIME | | 上传时间 |
| submission_id | INTEGER | FK | 关联提交 |
| status | VARCHAR(20) | DEFAULT 'new' | 状态 |
| notes | TEXT | | 备注 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |
| updated_at | DATETIME | DEFAULT NOW | 更新时间 |

**status 状态说明**:
- `new`: 新建
- `screening`: 筛选中
- `interviewing`: 面试中
- `hired`: 已录用
- `rejected`: 已拒绝

---

### 2.6 portrait_cache - 画像缓存表

**用途**: 缓存 AI 生成的候选人画像，避免重复调用

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| candidate_id | INTEGER | INDEX | 候选人ID |
| analysis_level | VARCHAR(20) | INDEX, DEFAULT 'pro' | 分析级别 |
| portrait_data | TEXT | | JSON画像数据 |
| data_version | VARCHAR(64) | | 数据版本 |
| ai_model | VARCHAR(100) | | 使用的AI模型 |
| generation_time_ms | INTEGER | | 生成耗时(ms) |
| is_default | BOOLEAN | DEFAULT FALSE | 是否默认分析 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |
| updated_at | DATETIME | DEFAULT NOW | 更新时间 |

**analysis_level 说明**:
- `pro`: 深度分析 (Qwen2.5-32B)
- `expert`: 专家分析 (DeepSeek-R1)

**portrait_data 结构示例**:
```json
{
  "summary": "综合评价...",
  "personality_traits": ["特质1", "特质2"],
  "strengths": ["优势1", "优势2"],
  "weaknesses": ["待发展项1"],
  "career_suggestions": ["建议1"]
}
```

---

### 2.7 job_profiles - 岗位画像表

**用途**: 存储岗位的能力画像配置

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| name | VARCHAR(255) | INDEX | 岗位名称 |
| department | VARCHAR(255) | | 所属部门 |
| description | TEXT | | 岗位说明 |
| tags | TEXT | | 标签(JSON数组) |
| dimensions | TEXT | | 能力维度(JSON) |
| job_position_id | INTEGER | FK | 关联岗位表 |
| requirement_text | TEXT | | JD文案 |
| ai_analysis | JSON | | AI分析结果 |
| status | VARCHAR(20) | DEFAULT 'active' | 状态 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |
| updated_at | DATETIME | DEFAULT NOW | 更新时间 |

**dimensions 结构示例**:
```json
[
  {"name": "产品规划", "weight": 25, "description": "..."},
  {"name": "用户洞察", "weight": 20, "description": "..."},
  {"name": "数据分析", "weight": 20, "description": "..."}
]
```

---

### 2.8 job_dimension_weights - 维度权重表

**用途**: 存储岗位画像的详细维度配置

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| job_profile_id | INTEGER | FK, INDEX | 关联岗位画像 |
| dimension_code | VARCHAR(20) | NOT NULL | 维度代码 |
| dimension_name | VARCHAR(100) | NOT NULL | 维度名称 |
| weight | FLOAT | DEFAULT 0.0 | 权重(0-1) |
| ideal_score | FLOAT | | 理想分数 |
| min_score | FLOAT | | 最低分数 |
| description | TEXT | | 维度说明 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

---

### 2.9 profile_matches - 匹配记录表

**用途**: 存储候选人与岗位的匹配结果

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| profile_id | INTEGER | FK, INDEX | 岗位画像ID |
| submission_id | INTEGER | FK, INDEX | 提交记录ID |
| match_score | FLOAT | DEFAULT 0.0 | 匹配分数(0-100) |
| dimension_scores | JSON | | 各维度得分 |
| ai_analysis | TEXT | | AI分析报告 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

---

### 2.10 job_positions - 岗位表

**用途**: 存储基础岗位信息（可选使用）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| name | VARCHAR(255) | INDEX | 岗位名称 |
| department | VARCHAR(255) | | 部门 |
| level | VARCHAR(50) | | 级别 |
| description | TEXT | | 岗位描述 |
| status | VARCHAR(20) | DEFAULT 'active' | 状态 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |
| updated_at | DATETIME | DEFAULT NOW | 更新时间 |

---

## 三、数据关系

### 3.1 核心关系

```
questionnaires (1) ──────< (N) assessments
     │
     │ (1)
     │
     ▼ (N)
submissions ────────────> candidates
     │                         │
     │                         │
     ▼                         ▼
profile_matches          portrait_cache
```

### 3.2 关系说明

| 关系 | 说明 |
|------|------|
| questionnaires → assessments | 一个问卷可以分发多次 |
| questionnaires → submissions | 一个问卷可以有多次提交 |
| assessments → submissions | 一次分发可以有多次提交 |
| submissions → candidates | 提交记录关联到候选人 |
| candidates → portrait_cache | 候选人可以有多个画像缓存 |
| job_profiles → profile_matches | 岗位画像可以有多个匹配记录 |

---

## 四、索引设计

### 4.1 主要索引

```sql
-- 用户表
CREATE INDEX idx_users_username ON users(username);

-- 问卷表
CREATE INDEX idx_questionnaires_name ON questionnaires(name);

-- 测评表
CREATE UNIQUE INDEX idx_assessments_code ON assessments(code);

-- 提交表
CREATE UNIQUE INDEX idx_submissions_code ON submissions(code);
CREATE INDEX idx_submissions_candidate_phone ON submissions(candidate_phone);
CREATE INDEX idx_submissions_questionnaire_id ON submissions(questionnaire_id);

-- 候选人表
CREATE INDEX idx_candidates_name ON candidates(name);
CREATE INDEX idx_candidates_phone ON candidates(phone);

-- 画像缓存表
CREATE INDEX idx_portrait_cache_candidate_id ON portrait_cache(candidate_id);
CREATE INDEX idx_portrait_cache_level ON portrait_cache(analysis_level);
```

---

## 五、数据迁移

### 5.1 SQLite → PostgreSQL

```bash
# 1. 导出 SQLite 数据
sqlite3 hr.db .dump > dump.sql

# 2. 转换 SQL 语法
# - AUTOINCREMENT → SERIAL
# - datetime('now') → NOW()
# - 布尔值 0/1 → false/true

# 3. 导入 PostgreSQL
psql -U talentlens -d talentlens_db < dump_converted.sql
```

### 5.2 数据备份

```bash
# SQLite 备份
cp hr.db hr_backup_$(date +%Y%m%d).db

# PostgreSQL 备份
pg_dump -U talentlens talentlens_db > backup_$(date +%Y%m%d).sql
```

---

## 六、查询示例

### 6.1 获取候选人及其提交记录

```sql
SELECT 
    c.id,
    c.name,
    c.phone,
    COUNT(s.id) as submission_count,
    MAX(s.submitted_at) as last_submission
FROM candidates c
LEFT JOIN submissions s ON s.candidate_id = c.id
GROUP BY c.id
ORDER BY last_submission DESC;
```

### 6.2 获取问卷统计

```sql
SELECT 
    q.name as questionnaire_name,
    COUNT(s.id) as total_submissions,
    AVG(s.total_score) as avg_score,
    COUNT(CASE WHEN s.status = 'completed' THEN 1 END) as completed_count
FROM questionnaires q
LEFT JOIN submissions s ON s.questionnaire_id = q.id
GROUP BY q.id;
```

### 6.3 获取岗位匹配候选人

```sql
SELECT 
    c.name,
    c.phone,
    pm.match_score,
    pm.dimension_scores
FROM profile_matches pm
JOIN submissions s ON pm.submission_id = s.id
JOIN candidates c ON s.candidate_id = c.id
WHERE pm.profile_id = ?
ORDER BY pm.match_score DESC
LIMIT 10;
```

---

## 附录

### A. 数据库文件位置

| 环境 | 位置 |
|------|------|
| 开发 | `/Users/Python项目/HR人事/backend/hr.db` |
| 生产 | 配置在 `.env` 的 `DATABASE_URL` |

### B. 相关文档

- [API 接口文档](./06_API接口文档.md)
- [部署交付文档](./04_部署交付文档.md)
- [后续维护文档](./05_后续维护文档.md)

