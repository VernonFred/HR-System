# QZ·TalentLens 大模型架构文档

> **版本**: v1.0  
> **更新日期**: 2025年12月8日  
> **架构版本**: V5 三模型分层调用

---

## 一、架构概述

### 1.1 设计理念

QZ·TalentLens 采用**多模型分层调用**架构，通过智能路由和降级策略，在保证分析质量的同时控制成本和响应时间。

### 1.2 核心特点

| 特点 | 描述 |
|------|------|
| **分层调用** | 根据分析需求选择合适的模型级别 |
| **智能降级** | 主模型失败时自动切换备用模型 |
| **成本优化** | 日常分析使用轻量模型，重要分析使用高阶模型 |
| **高可用性** | 多重 fallback 保证服务稳定 |

---

## 二、模型配置

### 2.1 模型层级

```
┌─────────────────────────────────────────────────────────────┐
│                      模型分层架构                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Layer 3: 专家级 (Expert)                            │   │
│  │  模型: DeepSeek-R1-0528                              │   │
│  │  特点: 深度推理、复杂分析                             │   │
│  │  场景: 高管候选人、重要人才深度洞察                    │   │
│  │  限制: ~100次/天                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Layer 2: 深度分析 (Pro) [默认]                       │   │
│  │  模型: Qwen2.5-32B-Instruct                          │   │
│  │  特点: 高质量分析、全面画像                           │   │
│  │  场景: 所有 AI 分析的默认选择                         │   │
│  │  限制: ~500次/天                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Layer 1: 兜底级 (Normal)                            │   │
│  │  模型: Qwen2.5-7B-Instruct                           │   │
│  │  特点: 快速响应、基础分析                             │   │
│  │  场景: Pro 失败时的自动降级                           │   │
│  │  限制: ~500次/天                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模型详细配置

| 级别 | 模型 ID | 超时 | 最大Token | 日限制 |
|------|---------|------|-----------|--------|
| Expert | deepseek-ai/DeepSeek-R1-0528 | 120s | 2048 | ~100次 |
| Pro | Qwen/Qwen2.5-32B-Instruct | 90s | 2048 | ~500次 |
| Normal | Qwen/Qwen2.5-7B-Instruct | 45s | 1536 | ~500次 |

### 2.3 模型服务商

**主服务商**: ModelScope (魔塔空间)
- API 地址: `https://api-inference.modelscope.cn/v1/chat/completions`
- 认证方式: API Key (Bearer Token)
- 计费方式: 按 Token 计费

**备用服务商**: 硅基流动 (SiliconFlow)
- 模型: Qwen3-8B
- 用途: ModelScope 不可用时的 fallback

---

## 三、智能降级策略

### 3.1 降级流程

```
┌─────────────────────────────────────────────────────────────┐
│                      智能降级流程                            │
└─────────────────────────────────────────────────────────────┘

用户请求 AI 分析
       │
       ▼
┌─────────────────┐
│ 检查 ModelScope │
│   是否可用？     │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
   YES        NO
    │         │
    ▼         ▼
┌───────┐  ┌─────────────┐
│ Pro   │  │ 硅基流动    │
│ (32B) │  │ Qwen3-8B   │
└───┬───┘  └──────┬──────┘
    │             │
  成功?         成功?
    │             │
┌───┴───┐    ┌────┴────┐
│       │    │         │
YES     NO   YES       NO
│       │    │         │
▼       ▼    ▼         ▼
返回   Normal  返回    本地规则
结果   (7B)    结果    降级
       │
     成功?
       │
  ┌────┴────┐
  │         │
 YES        NO
  │         │
  ▼         ▼
返回      硅基流动
结果      Qwen3-8B
```

### 3.2 降级触发条件

| 条件 | 触发降级 |
|------|----------|
| API Key 未配置 | 直接使用硅基流动 |
| API Key 过期 | 直接使用硅基流动 |
| 请求超时 | 降级到下一级模型 |
| 服务端错误 (5xx) | 降级到下一级模型 |
| 速率限制 (429) | 等待后重试或降级 |
| 模型不可用 | 降级到下一级模型 |

### 3.3 降级响应标识

API 响应中包含降级标识：

```json
{
  "content": "分析结果...",
  "model": "Qwen/Qwen2.5-7B-Instruct",
  "level": "fallback",
  "degraded_from": "pro"
}
```

---

## 四、AI 功能模块

### 4.1 画像生成

#### 功能描述
基于候选人的测评数据，生成综合人员画像。

#### 调用模型
- 默认: Pro (Qwen2.5-32B)
- 可选: Expert (DeepSeek-R1)

#### 输入数据
```json
{
  "candidate_name": "张三",
  "position": "产品经理",
  "assessment_results": {
    "mbti": {"type": "INTJ", "scores": {...}},
    "disc": {"dominant": "D", "scores": {...}},
    "epq": {"scores": {...}}
  },
  "questionnaire_data": [...]
}
```

#### 输出结构
```json
{
  "summary": "综合评价...",
  "personality_traits": ["特质1", "特质2"],
  "strengths": ["优势1", "优势2"],
  "weaknesses": ["劣势1", "劣势2"],
  "career_suggestions": ["建议1", "建议2"],
  "team_fit": "团队适配分析...",
  "development_areas": ["发展方向1", "发展方向2"]
}
```

### 4.2 岗位画像配置

#### 4.2.1 AI 一键配置维度

**功能**: 根据岗位名称和描述，自动生成能力维度建议。

**调用模型**: Pro (Qwen2.5-32B)

**输入**:
```json
{
  "job_title": "产品经理",
  "description": "负责产品规划和设计..."
}
```

**输出**:
```json
{
  "dimensions": [
    {"name": "产品规划", "weight": 25, "description": "..."},
    {"name": "用户洞察", "weight": 20, "description": "..."},
    {"name": "数据分析", "weight": 20, "description": "..."},
    {"name": "沟通协调", "weight": 20, "description": "..."},
    {"name": "项目管理", "weight": 15, "description": "..."}
  ],
  "analysis": "AI 分析说明..."
}
```

#### 4.2.2 简历分析

**功能**: 从简历文件中提取岗位特征，生成能力维度建议。

**调用模型**: Pro (Qwen2.5-32B)

**流程**:
1. 上传简历文件 (PDF/Word)
2. 提取文本内容
3. AI 分析提取关键技能
4. 生成岗位画像建议

#### 4.2.3 JD 分析

**功能**: 从岗位 JD 文本中解析能力要求。

**调用模型**: Pro (Qwen2.5-32B)

**流程**:
1. 输入 JD 文本
2. AI 解析岗位要求
3. 提取能力维度
4. 生成权重建议

### 4.3 测评结果解读

#### MBTI 解读

**输入**: MBTI 类型和各维度得分
**输出**: 人格类型详细解读、职业建议

#### DISC 解读

**输入**: DISC 各维度得分
**输出**: 行为风格分析、团队角色建议

#### EPQ 解读

**输入**: EPQ 各维度得分
**输出**: 人格特质分析、发展建议

---

## 五、提示词工程

### 5.1 提示词模板位置

```
backend/app/core/ai/prompt_builder.py
```

### 5.2 画像生成提示词结构

```python
PORTRAIT_SYSTEM_PROMPT = """
你是一位资深的人力资源专家和心理学顾问，擅长根据测评数据分析候选人特征。

分析要求：
1. 客观、专业、有建设性
2. 基于数据，避免主观臆断
3. 语言简洁，突出重点
4. 提供可操作的建议

输出格式：
请以 JSON 格式输出，包含以下字段：
- summary: 综合评价（100-200字）
- personality_traits: 性格特点（3-5条）
- strengths: 优势（3-5条）
- weaknesses: 待发展项（2-3条）
- career_suggestions: 职业发展建议（2-3条）
"""

PORTRAIT_USER_PROMPT = """
请分析以下候选人的测评数据：

候选人：{name}
应聘岗位：{position}

测评数据：
{assessment_data}

请生成该候选人的综合画像分析。
"""
```

### 5.3 提示词优化原则

1. **明确角色**: 定义 AI 的专业身份
2. **清晰指令**: 具体说明分析要求
3. **结构化输出**: 指定 JSON 输出格式
4. **数据驱动**: 强调基于数据分析
5. **长度控制**: 限制输出字数

---

## 六、API 调用流程

### 6.1 调用时序图

```
┌─────────┐     ┌─────────┐     ┌─────────────┐     ┌───────────┐
│ Frontend│     │ Backend │     │ PortraitRouter│     │ ModelScope│
└────┬────┘     └────┬────┘     └──────┬──────┘     └─────┬─────┘
     │               │                 │                   │
     │ 请求画像分析   │                 │                   │
     │──────────────>│                 │                   │
     │               │                 │                   │
     │               │ 调用画像路由器   │                   │
     │               │────────────────>│                   │
     │               │                 │                   │
     │               │                 │ 确定模型级别      │
     │               │                 │──────┐            │
     │               │                 │      │            │
     │               │                 │<─────┘            │
     │               │                 │                   │
     │               │                 │ 调用 ModelScope   │
     │               │                 │──────────────────>│
     │               │                 │                   │
     │               │                 │      AI 分析      │
     │               │                 │<──────────────────│
     │               │                 │                   │
     │               │ 返回分析结果    │                   │
     │               │<────────────────│                   │
     │               │                 │                   │
     │ 返回画像数据  │                 │                   │
     │<──────────────│                 │                   │
     │               │                 │                   │
```

### 6.2 错误处理

```python
try:
    result = await call_portrait_model(messages, level="pro")
except ModelScopeError as e:
    # ModelScope 调用失败
    logger.warning(f"ModelScope 失败: {e}")
    # 自动降级到 Normal
    result = await call_portrait_model(messages, level="normal")
except AIClientError as e:
    # 所有模型都失败
    logger.error(f"AI 服务不可用: {e}")
    # 返回降级响应
    result = generate_fallback_response()
```

---

## 七、Token 管理

### 7.1 Token 配置

Token 存储在 `.env` 文件中：

```env
MODELSCOPE_API_KEY=your_api_key_here
MODELSCOPE_API_KEY_EXPIRES=2026-01-06
```

### 7.2 Token 过期检查

```python
def check_api_key_expiry() -> Dict[str, Any]:
    """检查 API Key 过期状态."""
    expires_str = os.getenv("MODELSCOPE_API_KEY_EXPIRES")
    if not expires_str:
        return {"valid": True, "warning": None, "days_remaining": None}
    
    try:
        expires_date = datetime.strptime(expires_str, "%Y-%m-%d")
        now = datetime.now()
        days_remaining = (expires_date - now).days
        
        if days_remaining < 0:
            return {"valid": False, "warning": "Token 已过期", "days_remaining": 0}
        elif days_remaining < 7:
            return {"valid": True, "warning": f"Token 将在 {days_remaining} 天后过期", "days_remaining": days_remaining}
        else:
            return {"valid": True, "warning": None, "days_remaining": days_remaining}
    except ValueError:
        return {"valid": True, "warning": None, "days_remaining": None}
```

### 7.3 Token 更新

通过系统设置页面更新 Token：

1. 进入"系统设置"
2. 展开"AI 模型配置"
3. 输入新 Token
4. 点击"保存配置"

更新后自动写入 `.env` 文件，无需重启服务。

---

## 八、性能优化

### 8.1 响应时间优化

| 优化措施 | 效果 |
|----------|------|
| 连接复用 | 减少 TCP 握手时间 |
| 超时控制 | 避免长时间等待 |
| 并发限制 | 防止过载 |
| 缓存策略 | 相同请求复用结果 |

### 8.2 成本优化

| 策略 | 说明 |
|------|------|
| 默认使用 Pro | 平衡质量和成本 |
| 按需使用 Expert | 仅重要分析使用 |
| 智能降级 | 失败时使用更便宜的模型 |
| 日限制监控 | 避免超出配额 |

### 8.3 监控指标

```python
# 获取模型状态
status = get_modelscope_status()
# {
#     "available": True,
#     "api_key_status": {"valid": True, "days_remaining": 25},
#     "models": {
#         "pro": {"model_id": "Qwen/Qwen2.5-32B-Instruct", "status": "available"},
#         "normal": {"model_id": "Qwen/Qwen2.5-7B-Instruct", "status": "available"},
#         "expert": {"model_id": "deepseek-ai/DeepSeek-R1-0528", "status": "available"}
#     }
# }
```

---

## 九、扩展指南

### 9.1 添加新模型

1. 在 `modelscope_client.py` 中添加模型配置：

```python
MODELSCOPE_MODELS[ModelLevel.NEW_LEVEL] = ModelScopeConfig(
    model_id="vendor/new-model-id",
    level=ModelLevel.NEW_LEVEL,
    timeout=60,
    max_tokens=2048,
    daily_limit=300
)
```

2. 在 `portrait_router.py` 中添加路由逻辑

3. 更新前端调用选项

### 9.2 自定义提示词

1. 在 `prompt_builder.py` 中添加新模板
2. 创建对应的构建函数
3. 在调用时指定模板

### 9.3 添加新的 AI 功能

1. 定义功能需求和输入输出
2. 设计提示词模板
3. 实现 API 端点
4. 添加前端调用

---

## 十、故障排查

### 10.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| AI 分析超时 | 网络问题/模型繁忙 | 重试或降级 |
| Token 无效 | Token 过期/错误 | 更新 Token |
| 返回格式错误 | 模型输出不规范 | 调整提示词 |
| 降级频繁 | 主模型不稳定 | 检查服务状态 |

### 10.2 日志查看

```bash
# 查看 AI 相关日志
tail -f backend/logs/ai.log

# 过滤 ModelScope 调用
grep "ModelScope" backend/logs/app.log
```

### 10.3 调试模式

```python
# 开启详细日志
import logging
logging.getLogger("app.core.ai").setLevel(logging.DEBUG)
```

---

## 附录

### A. 模型对比

| 模型 | 参数量 | 特点 | 适用场景 |
|------|--------|------|----------|
| Qwen2.5-7B | 7B | 快速、经济 | 日常分析 |
| Qwen2.5-32B | 32B | 高质量、全面 | 深度分析 |
| DeepSeek-R1 | - | 推理能力强 | 复杂决策 |

### B. API 限制

| 限制项 | 数值 |
|--------|------|
| 单次最大 Token | 2048 |
| 单日调用上限 | 2000次 |
| 单模型日限制 | ~500次 |
| 请求超时 | 45-120秒 |

### C. 相关文档

- [产品功能架构](./01_产品功能架构文档.md)
- [API 接口文档](./06_API接口文档.md)
- [部署交付文档](./04_部署交付文档.md)

